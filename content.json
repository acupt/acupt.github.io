{"meta":{"title":"ä¸€æ¯82å¹´çš„JAVA","subtitle":null,"description":null,"author":"ACUPT","url":"https://acupt.github.io"},"pages":[{"title":"","date":"2018-09-21T10:01:16.566Z","updated":"2018-09-21T10:01:16.566Z","comments":true,"path":"README.html","permalink":"https://acupt.github.io/README.html","excerpt":"","text":"sourcemy hexo source"},{"title":"about me","date":"2018-05-20T08:00:00.000Z","updated":"2018-09-21T10:01:16.570Z","comments":true,"path":"about/index.html","permalink":"https://acupt.github.io/about/index.html","excerpt":"","text":"Iâ€™m fine, fuck you."},{"title":"Gallery","date":"2017-01-17T13:39:03.000Z","updated":"2018-09-21T10:01:16.570Z","comments":true,"path":"gallery/index.html","permalink":"https://acupt.github.io/gallery/index.html","excerpt":"","text":""},{"title":"tags","date":"2017-01-17T13:39:14.000Z","updated":"2018-09-21T10:01:16.687Z","comments":true,"path":"tag/index.html","permalink":"https://acupt.github.io/tag/index.html","excerpt":"","text":""},{"title":"group","date":"2017-01-17T13:05:04.000Z","updated":"2018-09-21T10:01:16.688Z","comments":true,"path":"work/index.html","permalink":"https://acupt.github.io/work/index.html","excerpt":"","text":""}],"posts":[{"title":"æ¢ç´¢JAVAå¹¶å‘ - å¦‚ä½•å‡å°‘é”çš„ç«äº‰","slug":"concurrent-lock-contention-reduce","date":"2019-08-04T15:20:00.000Z","updated":"2019-08-05T15:38:14.926Z","comments":true,"path":"2019/08/04/concurrent-lock-contention-reduce/","link":"","permalink":"https://acupt.github.io/2019/08/04/concurrent-lock-contention-reduce/","excerpt":"","text":"é”çš„ç«äº‰ä¼šé™åˆ¶ä»£ç çš„å¯ä¼¸ç¼©æ€§ï¼Œåœ¨å¹¶å‘ç¼–ç¨‹æ—¶é€šè¿‡ä¸€äº›æ‰‹æ®µæœ‰æ„åœ°å‡å°‘é”ç«äº‰ï¼Œå¯ä»¥è®©ç¨‹åºæœ‰æ›´å¥½çš„è¡¨ç°ã€‚ æ‰€è°“å¯ä¼¸ç¼©æ€§ï¼Œå³å½“å¢åŠ è®¡ç®—èµ„æº(å¦‚CPUã€å†…å­˜ã€å¸¦å®½ç­‰)æ—¶ï¼Œç¨‹åºçš„ååé‡æˆ–å¤„ç†èƒ½åŠ›ä¼šç›¸åº”å¢åŠ ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å½“ç„¶å¸Œæœ›å¢åŠ çš„æ•ˆæœè¶Šæ˜æ˜¾è¶Šå¥½ï¼Œä¸è¿‡å¦‚æœé”ç«äº‰å¤ªä¸¥é‡ï¼Œå¯ä¼¸ç¼©æ€§ä¼šå¤§æ‰“æŠ˜æ‰£ã€‚ ç¼©å°é”çš„èŒƒå›´å½“æŸä¸ªæ–¹æ³•éœ€è¦æ“ä½œä¸€ä¸ªçº¿ç¨‹ä¸å®‰å…¨çš„å…±äº«èµ„æºæ—¶ï¼Œæœ€ç®€å•çš„åŠæ³•å°±æ˜¯ç»™æ–¹æ³•åŠ ä¸Šsynchronizedï¼Œè¿™æ ·ä¸€æ¥è¿™ä¸ªæ–¹æ³•åªèƒ½åŒæ—¶æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œï¼Œæ»¡æ»¡çš„å®‰å…¨æ„Ÿã€‚ 12345678910111213141516171819public class Counter &#123; private volatile int value; public synchronized void incr(int n) &#123; System.out.println(\"i will incr \" + n); try &#123; // è¿™ä¸ªå°å°çš„ç¡çœ ä»£è¡¨ä¸€äº›çº¿ç¨‹å®‰å…¨çš„æ“ä½œ Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(\"i am ready\"); value = value + n; System.out.println(\"i incr \" + n); &#125; //...&#125; ä¸Šè¿°ç¤ºä¾‹çš„åŒæ­¥æ–¹æ³•ä¸­æœ‰ä¸ªè€—æ—¶1ç§’çš„å‡†å¤‡è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯çº¿ç¨‹å®‰å…¨ï¼Œä½†ç”±äºèº«åœ¨åŒæ­¥æ–¹æ³•ä¸­ï¼Œä¼—çº¿ç¨‹ä¸å¾—ä¸æ’é˜Ÿç¡è§‰ã€‚è¿™æ—¶å€™ä¸ç®¡å¢åŠ å¤šå°‘ä¸ªçº¿ç¨‹ï¼Œç¨‹åºè¯¥ç¡å¤šä¹…è¿˜æ˜¯ç¡å¤šä¹…ã€‚è‹¥æ˜¯æŠŠè¿™ä¸ªæ­¥éª¤ä»åŒæ­¥ä»£ç å—ä¸­ç§»é™¤ï¼Œå¤§å®¶å°±èƒ½å¹¶å‘ç¡è§‰ã€‚ 123456789101112131415161718192021public class Counter &#123; private volatile int value; public void incr(int n) &#123; System.out.println(\"i will incr \" + n); try &#123; Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(\"i am ready\"); synchronized (this) &#123; // åªæœ‰è¿™è¡Œä»£ç æ˜¯ä¸èƒ½å¹¶å‘æ‰§è¡Œçš„ value = value + n; &#125; System.out.println(\"i incr \" + n); &#125; //...&#125; é€šè¿‡ä¸Šè¿°ç¤ºä¾‹å°±è®©çº¿ç¨‹åœ¨æŒæœ‰é”æ—¶éœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤å°½å¯èƒ½å°ï¼Œå¹¶å‘çš„æ•ˆç‡æ›´é«˜äº†ã€‚ ä½†å¦‚æœå¤šä¸ªçº¿ç¨‹ä¸å®‰å…¨çš„æ“ä½œä¹‹é—´éš”ç€ä¸€äº›å®‰å…¨çš„è€—æ—¶æ“ä½œï¼Œæ˜¯åˆ†åˆ«ä½¿ç”¨åŒæ­¥å—ï¼Œè¿˜æ˜¯ç”¨ä¸€ä¸ªåŒæ­¥å—ï¼Œå¹¶ä¸èƒ½è¯´è°ä¸€å®šå¥½ã€‚å› ä¸ºåŒæ­¥ä»£ç å—ä¹Ÿæ˜¯æœ‰é¢å¤–æ€§èƒ½å¼€é”€çš„ï¼Œæ¯”èµ·åŒæ­¥æ‰§è¡Œæ— å…³çš„æ“ä½œï¼Œä¸ä¸€å®šåˆ’ç®—ï¼Œè¿˜æ˜¯éœ€è¦é€šè¿‡æµ‹è¯•ï¼Œç”¨æ•°æ®è¯´è¯ã€‚ å‡å°é”ç²’åº¦ - é”åˆ†è§£å¦‚æœä¸€ä¸ªé”è¦ç”¨æ¥ä¿æŠ¤å¤šä¸ªç›¸äº’ç‹¬ç«‹çš„èµ„æºï¼Œå¯ä»¥è€ƒè™‘ç”¨å¤šä¸ªé”åˆ†åˆ«ä¿æŠ¤æŸä¸ªèµ„æºï¼Œå³é”åˆ†è§£ã€‚ å¦‚æ­¤è¿™èˆ¬ï¼Œå°±ä¸ç”¨åœ¨åªéœ€è¦æ“ä½œä¸€ä¸ªèµ„æºæ—¶ï¼ŒæŠŠå…¶å®ƒä¸ç›¸å¹²èµ„æºä¹Ÿå·å…¥å…¶ä¸­ï¼Œå¯¼è‡´å…¶å®ƒæƒ³ç”¨èµ„æºçš„çº¿ç¨‹çœ‹ç€è¿™ä¸ªçº¿ç¨‹å ç€èŒ…å‘ä¸æ‹‰ğŸ’©ï¼ˆæˆ–è€…å ç€æ•´ä¸ªå•æ‰€æ›´æ°å½“ï¼Ÿï¼‰ã€‚ ä½¿ç”¨ä¸€ä¸ªé”ä¿æŠ¤å¤šä¸ªèµ„æºä¸‹é¢è¿™ä¸ªç¤ºä¾‹ï¼Œä¸ç®¡æƒ³æ“ä½œå“ªä¸ªèµ„æºï¼Œéƒ½ä¼šæŠŠæ‰€æœ‰èµ„æºéƒ½é”ä½ã€‚ 123456789101112public class Counter &#123; private volatile int src1; private volatile int src2; private volatile int src3; public synchronized void incr(int src1, int src2, int src3) &#123; this.src1 += src1; this.src2 += src2; this.src3 += src3; &#125;&#125; ä¸€ä¸ªé”ä¿æŠ¤ä¸€ä¸ªèµ„æºé€šè¿‡é”åˆ†è§£ï¼Œæ¯ä¸ªèµ„æºæœ‰å®ƒè‡ªå·±çš„é”ï¼Œå¯ä»¥å•ç‹¬æ“ä½œã€‚å¦‚æœæƒ³å…¼å®¹æ—§ä»£ç ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ 12345678910111213141516171819202122232425262728293031public class Counter &#123; private volatile int src1; private volatile int src2; private volatile int src3; // å…¼å®¹æ—§ä»£ç ï¼Œä¸ç”¨ä¿®æ”¹è°ƒç”¨çš„åœ°æ–¹ public void incr(int src1, int src2, int src3) &#123; if (src1 != 0) &#123; incrSrc1(src1); &#125; if (src2 != 0) &#123; incrSrc2(src2); &#125; if (src3 != 0) &#123; incrSrc3(src3); &#125; &#125; public synchronized void incrSrc1(int n) &#123; this.src1 += n; &#125; public synchronized void incrSrc2(int n) &#123; this.src2 += n; &#125; public synchronized void incrSrc3(int n) &#123; this.src3 += n; &#125;&#125; å‡å°é”ç²’åº¦ - é”åˆ†æ®µé”åˆ†æ®µæ˜¯é”åˆ†è§£çš„è¿›ä¸€æ­¥æ‰©å±•ï¼Œå¯¹äºä¸€ç»„èµ„æºé›†åˆï¼Œå¯ä»¥æŠŠèµ„æºåˆ†ä¸ºå¤šä¸ªå°ç»„ï¼Œæ¯ä¸ªå°ç»„ç”¨ä¸€ä¸ªé”æ¥ä¿æŠ¤ï¼Œæ¯”å¦‚æˆ‘ä»¬ç†ŸçŸ¥çš„ConcurrentHashMap(java8ä¸­å·²ç»ä¸å†ä½¿ç”¨åˆ†æ®µé”äº†ï¼Œæ”¹ä¸ºsynchronized + cas)ã€‚ ç”¨çš„java8ï¼Œä¸èƒ½åˆ†æä¸€æ³¢ConcurrentHashMapçš„åˆ†æ®µé”äº†ï¼Œå†™ä¸ªä¾‹å­ã€‚ 12345678910111213141516171819202122232425262728293031public class Counter &#123; private int[] src; private Object[] locks; /** * @param nSrc èµ„æºæ•°é‡ * @param nLocks åˆ†æˆå‡ æ®µé” */ public Counter(int nSrc, int nLocks) &#123; src = new int[nSrc]; locks = new Object[nLocks]; for (int i = 0; i &lt; nLocks; i++) &#123; locks[i] = new Object(); &#125; &#125; /** * @param idx è¦è®¿é—®çš„èµ„æºåºå· * @param n å¢é‡ */ public void incr(int idx, int n) &#123; // æ ¹æ®ä¸€å®šè§„åˆ™ï¼ˆæ¯”å¦‚hashï¼‰æ‰¾åˆ°ç›®æ ‡èµ„æºå½’è°ç®¡ synchronized (locks[idx % locks.length]) &#123; src[idx] += n; &#125; &#125; //...&#125; é¿å…çƒ­ç‚¹åŸŸä¸Šé¢çš„ä¾‹å­é€šè¿‡é”åˆ†æ®µå‡å°äº†é”çš„ç«äº‰ï¼Œå› ä¸ºè®¿é—®ä¸åŒæ®µçš„èµ„æºæ—¶ï¼Œéœ€è¦çš„é”æ˜¯ä¸åŒçš„ï¼Œç«äº‰å‹åŠ›ä¹Ÿéšä¹‹å‡å°ã€‚æ¯•ç«Ÿæ¯”èµ·10ä¸ªäººç«äº‰ä¸€ä¸ªåé¢ï¼Œ10ä¸ªäººç«äº‰5ä¸ªåé¢çš„è¯å¤§å®¶å†²çªä¸ä¼šé‚£ä¹ˆå¤§ã€‚ ä½†æ˜¯ï¼Œä¾ç„¶ä¼šå­˜åœ¨éœ€è¦åŒæ—¶è®¿é—®å¤šä¸ªèµ„æºçš„æƒ…å†µï¼Œæ¯”å¦‚è®¡ç®—å½“å‰æ‰€æœ‰èµ„æºçš„æ€»å’Œï¼Œè¿™ä¸ªæ—¶å€™é”çš„ç²’åº¦å°±å¾ˆéš¾é™ä½äº†ã€‚å½“é”çš„ç²’åº¦æ— æ³•é™ä½æ—¶ï¼Œä¸ºäº†å‡å°‘ç­‰å¾…çš„æ—¶é—´ï¼Œæœºæ™ºçš„ç¨‹åºå‘˜å¾€å¾€ä¼šç”¨ä¸€äº›ä¼˜åŒ–æªæ–½ï¼Œæ¯”å¦‚æŠŠè®¡ç®—çš„ç»“æœç¼“å­˜èµ·æ¥ï¼Œçƒ­ç‚¹åŸŸå°±éšä¹‹è¢«å¼•å…¥äº†ã€‚ ä¾ç„¶ä»¥ä¸Šé¢çš„ä»£ç ä¸ºä¾‹ï¼Œå¢åŠ ä¸€ä¸ªè®¡æ•°å™¨æ¥è®°å½•èµ„æºçš„å˜åŒ–ï¼Œæ¯ä¸ªèµ„æºå˜åŒ–éƒ½ä¿®æ”¹è®¡æ•°å™¨ï¼Œè¿™æ ·å½“éœ€è¦ç»Ÿè®¡æ‰€æœ‰èµ„æºæ—¶ï¼Œåªéœ€è¦è¿”å›è®¡æ•°å™¨çš„å€¼å°±è¡Œäº†ã€‚è¿™ä¸ªè®¡æ•°å™¨å°±æ˜¯ä¸€ä¸ªçƒ­ç‚¹åŸŸã€‚ å…¨å±€è®¡æ•°å™¨å¼•å…¥çƒ­ç‚¹åŸŸ12345678910111213141516171819202122232425262728293031323334353637383940414243public class Counter &#123; private int[] src; private Object[] locks; // å…¨å±€è®¡æ•°å™¨ private volatile int count; /** * @param nSrc èµ„æºæ•°é‡ * @param nLocks åˆ†æˆå‡ æ®µé” */ public Counter(int nSrc, int nLocks) &#123; src = new int[nSrc]; locks = new Object[nLocks]; for (int i = 0; i &lt; nLocks; i++) &#123; locks[i] = new Object(); &#125; &#125; /** * @param idx è¦è®¿é—®çš„èµ„æºåºå· * @param n å¢é‡ */ public void incr(int idx, int n) &#123; // æ ¹æ®ä¸€å®šè§„åˆ™ï¼ˆæ¯”å¦‚hashï¼‰æ‰¾åˆ°ç›®æ ‡èµ„æºå½’è°ç®¡ synchronized (locks[idx % locks.length]) &#123; src[idx] += n; &#125; // ä¸ç®¡æ“ä½œå“ªä¸ªåˆ†æ®µçš„èµ„æºï¼Œè®¡æ•°æ—¶éƒ½ç«äº‰åŒä¸€ä¸ªé” synchronized (this) &#123; count++; &#125; &#125; // ç›´æ¥è¿”å›ç¼“å­˜çš„å€¼ public int count() &#123; return count; &#125; //...&#125; åˆ†æ®µè®¡æ•°å™¨é¿å…çƒ­ç‚¹åŸŸä¸Šè¿°é€šè¿‡å…¨å±€è®¡æ•°å™¨ç¼“å­˜è®¡ç®—çš„ç»“æœè™½ç„¶è®©è·å–è®¡æ•°æ–¹æ³•çš„å¼€é”€ä»O(n)å˜æˆäº†O(1)ï¼Œä½†å´å¼•å…¥äº†çƒ­ç‚¹åŸŸï¼Œæ¯æ¬¡è®¿é—®èµ„æºéƒ½è¦è®¿é—®åŒä¸€ä¸ªè®¡æ•°å™¨ï¼Œè¿™æ—¶å€™å¯¹å¯ä¼¸ç¼©æ€§å°±äº§ç”Ÿäº†ä¸€å®šå½±å“ï¼Œå› ä¸ºä¸ç®¡æ€ä¹ˆå¢åŠ å¹¶å‘èµ„æºï¼Œåœ¨è®¿é—®è®¡æ•°å™¨æ—¶éƒ½ä¼šæœ‰ç«äº‰ã€‚ ConcurrentHashMapä¸­çš„åšæ³•æ˜¯ä¸ºæ¯æ®µæ•°æ®å•ç‹¬ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç„¶åè·å–æ€»æ•°æ—¶å†å¯¹æ‰€æœ‰åˆ†æ®µçš„è®¡æ•°åšä¸€ä¸ªç´¯åŠ ï¼ˆçœŸå®æƒ…å†µä¼šæ›´å¤æ‚ï¼Œæ¯”å¦‚ConcurrentHashMapä¼šè®¡ç®—ä¸¤æ¬¡modCountå¹¶æ¯”è¾ƒï¼Œå¦‚æœä¸ç›¸ç­‰è¡¨ç¤ºè®¡ç®—è¿‡ç¨‹æœ‰å˜åŠ¨ï¼Œå°±ä¼šç»™æ‰€æœ‰åˆ†æ®µåŠ é”å†ç´¯åŠ ï¼‰ã€‚ å¯¹å…¨å±€è®¡æ•°å™¨çš„ä¾‹å­åšäº†ç®€å•çš„æ”¹å†™ï¼Œå»æ‰äº†çƒ­ç‚¹åŸŸã€‚ä½†æ¢ä¸ªè§’åº¦ï¼Œè¿™æ ·å´ä¹Ÿè®©è·å–æ€»æ•°çš„æ–¹æ³•æ€§èƒ½å—åˆ°äº†å½±å“ï¼Œå› æ­¤å®é™…æ“ä½œæ—¶è¿˜éœ€è¦æ ¹æ®ä¸šåŠ¡åœºæ™¯æƒè¡¡åˆ©å¼Šã€‚é±¼å’Œç†ŠæŒä¸å¯å…¼å¾—ï¼Œè™½ç„¶å¾ˆæƒ³è¯´æˆ‘å…¨éƒ½è¦ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public class Counter &#123; private int[] src; private Lock[] locks; /** * @param nSrc èµ„æºæ•°é‡ * @param nLocks åˆ†æˆå‡ æ®µé” */ public Counter(int nSrc, int nLocks) &#123; src = new int[nSrc]; locks = new Lock[nLocks]; for (int i = 0; i &lt; nLocks; i++) &#123; locks[i] = new Lock(); &#125; &#125; /** * @param idx è¦è®¿é—®çš„èµ„æºåºå· * @param n å¢é‡ */ public void incr(int idx, int n) &#123; // æ ¹æ®ä¸€å®šè§„åˆ™ï¼ˆæ¯”å¦‚hashï¼‰æ‰¾åˆ°ç›®æ ‡èµ„æºå½’è°ç®¡ int lockIdx = idx % locks.length; synchronized (locks[lockIdx]) &#123; src[idx] += n; locks[lockIdx].count++; &#125; &#125; public int count() &#123; // å°±ä¸åƒConcurrentHashMapé‚£ä¹ˆä¸¥è°¨äº†ï¼Œæ„æ€ä¸€ä¸‹ int sum = 0; for (Lock lock : locks) &#123; sum += lock.count; &#125; return sum; &#125; // é” private static class Lock &#123; volatile int count; &#125; //...&#125; æ›¿ä»£ç‹¬å é”æœ‰æ—¶å€™å¯ä»¥é€‰æ‹©æ”¾å¼ƒä½¿ç”¨ç‹¬å é”ï¼Œæ”¹ç”¨æ›´åŠ å‹å¥½çš„å¹¶å‘æ–¹å¼ã€‚ è¯»å†™é” è¯»å†™é”(ReentrantReadWriteLock)ç»´æŠ¤äº†ä¸€å¯¹é”ï¼ˆä¸€ä¸ªè¯»é”å’Œä¸€ä¸ªå†™é”ï¼‰ï¼Œé€šè¿‡åˆ†ç¦»è¯»é”å’Œå†™é”ï¼Œä½¿å¾—å¹¶å‘æ€§ç›¸æ¯”ä¸€èˆ¬çš„æ’ä»–é”æœ‰äº†å¾ˆå¤§æå‡ã€‚ åœ¨è¯»æ¯”å†™å¤šçš„åœºæ™¯ä¸‹ï¼Œä½¿ç”¨è¯»å†™é”å¾€å¾€æ¯”ä¸€èˆ¬çš„ç‹¬å é”æœ‰æ›´å¥½çš„æ€§èƒ½è¡¨ç°ã€‚ åŸå­å˜é‡ åŸå­å˜é‡å¯ä»¥é™ä½çƒ­ç‚¹åŸŸçš„æ›´æ–°å¼€é”€ï¼Œä½†æ— æ³•æ¶ˆé™¤ã€‚ java.util.concurrent.atomic.* åŒ…ä¸‹æœ‰ä¸€äº›å¯¹åº”åŸºæœ¬ç±»å‹çš„åŸå­å˜é‡ç±»ï¼Œä½¿ç”¨äº†æ“ä½œç³»ç»Ÿåº•å±‚çš„èƒ½åŠ›ï¼Œä½¿ç”¨CAS(æ¯”è¾ƒå¹¶äº¤æ¢ï¼Œcompare-and-swap)æ›´æ–°å€¼ã€‚ æ£€æµ‹CPUåˆ©ç”¨ç‡é€šè¿‡æ£€æµ‹CPUçš„åˆ©ç”¨ç‡ï¼Œåˆ†æå‡ºå¯èƒ½é™åˆ¶ç¨‹åºæ€§èƒ½çš„ç‚¹ï¼Œåšå‡ºç›¸åº”æªæ–½ã€‚ CPUåˆ©ç”¨ç‡ä¸å‡åŒ€å¤šæ ¸çš„æœºå™¨ä¸Šï¼Œå¦‚æœæŸä¸ªCPUå¿™æˆğŸ¶ï¼Œå…¶å®ƒCPUå°±åœ¨æ—è¾¹å–Š666ï¼Œé‚£è¯æ˜å½“å‰ç¨‹åºçš„çš„å¤§éƒ¨åˆ†è®¡ç®—å·¥ä½œéƒ½ç”±ä¸€å°ç»„çº¿ç¨‹åœ¨åšã€‚è¿™æ—¶å€™å¯ä»¥è€ƒè™‘æŠŠè¿™éƒ¨åˆ†å·¥ä½œå¤šæ‹†åˆ†å‡ ä¸ªçº¿ç¨‹æ¥åšï¼ˆæ¯”å¦‚å‚è€ƒCPUæ•°ï¼‰ã€‚ CPUåˆ©ç”¨ä¸å……åˆ†å’ŒCPUåˆ©ç”¨ç‡ä¸å‡åŒ€çš„åŒºåˆ«åœ¨äºï¼Œä»–å¯èƒ½æ˜¯å‡åŒ€çš„ï¼Œå°±æ˜¯å¤§å®¶éƒ½åœ¨ç£¨æ´‹å·¥ã€‚ CPUåˆ©ç”¨ä¸å……åˆ†ä¸€èˆ¬æœ‰ä¸€ä¸‹å‡ ä¸ªåŸå› ï¼š è´Ÿè½½ä¸å‡è¡¡ï¼šåƒ§å¤šç²¥å°‘ï¼Œä¸€äººèƒ½åˆ†ç‚¹äº‹åšå°±ä¸é”™äº†ã€‚è¿™ç§æƒ…å†µå¯ä»¥è€ƒè™‘å¢åŠ å·¥ä½œé‡ï¼Œä¸è¦æ€œæƒœå®ƒä»¬ï¼› I/Oå¯†é›†ï¼šç¨‹åºå°±ä¸æ˜¯CPUå¯†é›†å‹çš„ï¼Œè¿™ç§æƒ…å†µå¯ä»¥æƒ³åŠæ³•å¢åŠ I/Oæ•ˆç‡ï¼ˆæ¯”å¦‚å¢åŠ ä»»åŠ¡/å¹¶å‘ã€æé«˜å¸¦å®½ï¼‰ï¼Œä»¥æ­¤æ¥ä½¿CPUåˆ©ç”¨ç‡å¾—åˆ°ä¸€å®šæé«˜ï¼› å¤–éƒ¨ä¾èµ–é™åˆ¶ï¼šæ¯”å¦‚è°ƒç”¨å…¶å®ƒæœåŠ¡ç­‰å¾…å¤ªä¹…ï¼Œç“¶é¢ˆåœ¨åˆ«äººé‚£ã€‚å¯ä»¥åƒI/Oå¯†é›†é‚£æ ·è‡ªæˆ‘æå‡ï¼Œå®åŠ›è¶³å¤Ÿçš„è¯ä¹Ÿå¯ä»¥æ”¹å˜åˆ«äººï¼› é”ç«äº‰ï¼šæœ¬æ–‡æ¢ç´¢çš„ä¸»é¢˜ï¼Œå¯ä»¥åœ¨çº¿ç¨‹è½¬å‚¨ä¿¡æ¯ä¸­å¯»æ‰¾ç­‰å¾…é”çš„åœ°æ–¹ï¼Œå› åœ°åˆ¶å®œã€‚ CPUå¿™ç¢Œ é—²ä¹Ÿä¸è¡Œï¼Œå¿™ä¹Ÿä¸è¡Œï¼Œä½ è¿˜è¦æˆ‘æ€æ ·ï¼Ÿè¦æ€æ ·ï¼ å¦‚æœCPUä»¬å·²ç»å¾ˆå¿™äº†ï¼Œè¯æ˜å·¥ä½œè¿˜æ˜¯å¾ˆé¥±å’Œçš„ï¼Œå¦‚æœè¿˜æƒ³æé«˜æ•ˆç‡ï¼Œå¯ä»¥è€ƒè™‘åŠ æ´¾CPUäº†ã€‚ä¸è¿‡å¹¶ä¸æ˜¯å¢åŠ äº†CPUæ•ˆç‡å°±ä¸€å®šä¼šæå‡ï¼Œå¢åŠ CPUåå¯èƒ½åˆä¼šå˜æˆä¸Šé¢ä¸¤ç§æƒ…å†µï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œå½“å¾ªç¯åœæ­¢ï¼ˆæ— æ³•é€šè¿‡ä¸Šé¢çš„æ–¹å¼å¾—åˆ°æœ‰æ•ˆä¼˜åŒ–ï¼‰ï¼Œæˆ‘ä»¬çš„åº”ç”¨åŸºæœ¬ä¸Šè¾¾åˆ°ä¸€ä¸ªæ‰€è°“â€œæé™â€äº†ã€‚ ä¸ä½¿ç”¨å¯¹è±¡æ± çº¿ç¨‹æ± çš„åº”ç”¨èŒƒå›´å¾ˆå¹¿ï¼Œæ¯”å¦‚å„ç§è¿æ¥æ± ã€‚å½“åº”ç”¨åˆ›å»ºæ¯”è¾ƒè€—æ—¶ã€è€—èµ„æºæ—¶ä¹Ÿå¸¸ç”¨å¯¹è±¡æ± æŠ€æœ¯ã€‚ä½†æœ‰æ—¶å€™ï¼Œé«˜å¹¶å‘ä¸‹æ“ä½œå¯¹è±¡æ± å¸¦æ¥çš„æ€§èƒ½æŸè€—ï¼ˆçº¿ç¨‹åŒæ­¥ã€é”ç«äº‰ã€é˜»å¡â€¦ï¼‰å¯èƒ½æ¯”èµ·åœ¨éœ€è¦çš„æ—¶å€™ç›´æ¥newä¸€ç›´å¯¹è±¡æ›´å¤§ã€‚ é€šå¸¸ï¼Œå¯¹è±¡åˆ†é…æ“ä½œçš„å¼€é”€æ¯”çº¿ç¨‹åŒæ­¥çš„å¼€é”€æ›´ä½ã€‚ æ€»ç»“æ€»çš„æ¥è¯´æœ‰3ç§æ–¹å¼å¯ä»¥é™ä½é”çš„ç«äº‰ç¨‹åº¦ï¼Œä¸Šé¢çš„æ“ä½œåŸºæœ¬éƒ½æ˜¯å›´ç»•è¿™3ç§æ–¹å¼æ¥åšçš„ï¼š å‡å°‘é”çš„æŒæœ‰æ—¶é—´ï¼ˆå¦‚ï¼šç¼©å°é”èŒƒå›´ï¼‰ é™ä½é”çš„è¯·æ±‚é¢‘ç‡ï¼ˆå¦‚ï¼šé”åˆ†è§£ï¼Œé”åˆ†æ®µï¼‰ ä½¿ç”¨å¸¦æœ‰åè°ƒæœºåˆ¶çš„ç‹¬å é”ï¼ˆå¦‚ï¼šåˆ†æ®µé”ï¼Œè¯»å†™é”ï¼‰ å‚è€ƒä¹¦ç±: ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹","categories":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://acupt.github.io/categories/å¹¶å‘ç¼–ç¨‹/"}],"tags":[{"name":"çº¿ç¨‹","slug":"çº¿ç¨‹","permalink":"https://acupt.github.io/tags/çº¿ç¨‹/"},{"name":"å¹¶å‘","slug":"å¹¶å‘","permalink":"https://acupt.github.io/tags/å¹¶å‘/"},{"name":"é”","slug":"é”","permalink":"https://acupt.github.io/tags/é”/"}],"keywords":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://acupt.github.io/categories/å¹¶å‘ç¼–ç¨‹/"}]},{"title":"è·¨åŸŸAccess-Control-Allow-Originè§£å†³æ–¹æ¡ˆ","slug":"access-control-allow-origin","date":"2019-07-31T11:00:00.000Z","updated":"2019-07-31T15:19:43.301Z","comments":true,"path":"2019/07/31/access-control-allow-origin/","link":"","permalink":"https://acupt.github.io/2019/07/31/access-control-allow-origin/","excerpt":"","text":"å‰ç«¯è®¿é—®å…¶å®ƒåŸŸåçš„èµ„æºå¾€å¾€ä¼šå¤±è´¥ï¼Œé‚£æ˜¯å› ä¸ºæµè§ˆå™¨å‡ºäºå®‰å…¨è€ƒè™‘ç¦æ­¢äº†ä¸åŒæºçš„èµ„æºã€‚ åŒæºç­–ç•¥ åŒæºç­–ç•¥ï¼Œå®ƒæ˜¯ç”±Netscapeæå‡ºçš„ä¸€ä¸ªè‘—åçš„å®‰å…¨ç­–ç•¥ã€‚ç°åœ¨æ‰€æœ‰æ”¯æŒJavaScriptçš„æµè§ˆå™¨éƒ½ä¼šä½¿ç”¨è¿™ä¸ªç­–ç•¥ã€‚æ‰€è°“åŒæºæ˜¯æŒ‡ï¼ŒåŸŸåï¼Œåè®®ï¼Œç«¯å£ç›¸åŒã€‚åŒæºç­–ç•¥æ˜¯æµè§ˆå™¨çš„è¡Œä¸ºï¼Œæ˜¯ä¸ºäº†ä¿æŠ¤æœ¬åœ°æ•°æ®ä¸è¢«JavaScriptä»£ç è·å–å›æ¥çš„æ•°æ®æ±¡æŸ“ï¼Œå› æ­¤æ‹¦æˆªçš„æ˜¯å®¢æˆ·ç«¯å‘å‡ºçš„è¯·æ±‚å›æ¥çš„æ•°æ®æ¥æ”¶ï¼Œå³è¯·æ±‚å‘é€äº†ï¼ŒæœåŠ¡å™¨å“åº”äº†ï¼Œä½†æ˜¯æ— æ³•è¢«æµè§ˆå™¨æ¥æ”¶ã€‚ åŒæºï¼šåè®® + åŸŸå + ç«¯å£ æ—¢ç„¶æ˜¯æµè§ˆå™¨çš„ç­–ç•¥ï¼Œåˆ™è¯´æ˜èµ„æºè¯·æ±‚æ˜¯å¯ä»¥æ­£å¸¸è¿”å›çš„ï¼Œåªæ˜¯æµè§ˆå™¨ä¸ç»™ç”¨ã€‚ è·¨åŸŸæŠ¥é”™æœ¬åœ°å¯åŠ¨äº†ä¸€ä¸ªwebæœåŠ¡ï¼Œåœ°å€ä¸º 127.0.0.1:8882 ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªæœ¬åœ°é™æ€é¡µé¢å»è¯·æ±‚è¿™ä¸ªæ¥å£ã€‚è™½ç„¶åœ¨åŒä¸€å°ç”µè„‘ï¼Œä½†ä¾ç„¶æ˜¯è·¨åŸŸçš„ã€‚ ä¸Šé¢ä¹Ÿè¯´äº†è¿™ä¸ªé™åˆ¶æ˜¯æµè§ˆå™¨åšçš„ï¼Œçœ‹çœ‹æ¥å£ï¼Œå…¶å®å·²ç»è¯·æ±‚æˆåŠŸäº†ï¼Œåç«¯æ˜¯æ‰§è¡Œäº†ç›¸å…³ä»£ç çš„ã€‚ åç«¯ä¿®æ”¹Responseæ”¯æŒè·¨åŸŸä»ä¸Šé¢æ§åˆ¶å°çš„è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œé”™è¯¯åŸå› æ˜¯è¯·æ±‚çš„èµ„æºï¼ˆæ¥å£ï¼‰çš„headerä¸­æ²¡æœ‰â€Access-Control-Allow-Originâ€œï¼Œé‚£æˆ‘ä»¬å¯ä»¥ç»™å®ƒåŠ ä¸Šã€‚åœ¨å“ªåŠ ï¼Ÿæ—¢ç„¶è¯´æ˜¯è¯·æ±‚çš„èµ„æºæ²¡æœ‰ï¼Œé‚£å½“ç„¶æ˜¯åœ¨è¯·æ±‚çš„èµ„æºä¸ŠåŠ ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡ç«¯ã€‚ 1234567891011121314151617181920212223@SpringBootApplication@Configuration@RestControllerpublic class ApplicationA &#123; public static void main(String[] args) &#123; SpringApplication.run(ApplicationA.class, args); &#125; @RequestMapping(\"/test\") public Object test(HttpServletRequest request, HttpServletResponse response) &#123; // è·¨åŸŸæ”¯æŒ response.setHeader(\"Access-Control-Allow-Origin\", \"*\"); response.setHeader(\"Access-Control-Allow-Methods\", \"POST,GET,PUT,DELETE\"); response.setHeader(\"Access-Control-Max-Age\", \"3600\"); response.setHeader(\"Access-Control-Allow-Headers\", \"*\"); response.setHeader(\"Access-Control-Allow-Credentials\", \"true\"); Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(\"success\", true); map.put(\"msg\", \"æˆ‘æ¥è‡ªæœåŠ¡ç«¯\"); return map; &#125;&#125; å†çœ‹çœ‹æµè§ˆå™¨ï¼Œå·²ç»å¯ä»¥æ­£å¸¸è®¿é—®æ¥å£äº†ã€‚ å¦‚æœè§‰å¾—æ¯ä¸ªæ¥å£é‡Œé¢éƒ½è¦é…ç½®ä¸€ä¸‹responseå¾ˆéº»çƒ¦ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæ‹¦æˆªå™¨é‡Œé¢åšè¿™ä¸ªäº‹æƒ…ã€‚ springbootæ”¯æŒè·¨åŸŸæµ‹è¯•ç”¨ä¾‹æ˜¯ä¸€ä¸ªspringbooté¡¹ç›®ï¼Œå¯ä»¥ç”¨æ›´ç®€å•çš„æ–¹å¼ã€‚é€šè¿‡ä¸€ä¸ªç»§æ‰¿äº†WebMvcConfigurerAdapterçš„beanï¼Œé‡å†™addCorsMappingsæ–¹æ³•ï¼Œåœ¨æ–¹æ³•é‡Œé…ç½®ã€‚ 1234567891011121314151617181920212223242526@SpringBootApplication@Configuration@RestControllerpublic class ApplicationA extends WebMvcConfigurerAdapter &#123; public static void main(String[] args) &#123; SpringApplication.run(ApplicationA.class, args); &#125; @RequestMapping(\"/test\") public Object test(HttpServletRequest request, HttpServletResponse response) &#123; Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(\"success\", true); map.put(\"msg\", \"æˆ‘æ¥è‡ªæœåŠ¡ç«¯\"); return map; &#125; // è·¨åŸŸæ”¯æŒ @Override public void addCorsMappings(CorsRegistry registry) &#123; registry.addMapping(\"/**\") .allowedOrigins(\"*\") .allowCredentials(true) .allowedMethods(\"GET\", \"POST\", \"DELETE\", \"PUT\") .maxAge(3600); &#125; jsonpæ”¯æŒè·¨åŸŸæœ‰å‰ç«¯ç»éªŒçš„ç«¥é‹çŸ¥é“ï¼Œæœ‰æ—¶æˆ‘ä»¬ä¼šåœ¨è‡ªå·±çš„ä»£ç é‡Œç›´æ¥å¼•å…¥å…¶å®ƒåŸŸåçš„jsã€cssç­‰é™æ€æ–‡ä»¶ã€‚ä¸ºå•¥è¿™äº›é™æ€æ–‡ä»¶æ²¡è¢«æµè§ˆå™¨é™åˆ¶å‘¢ï¼Ÿé€šå¸¸ä¸ºäº†å‡è½»webæœåŠ¡å™¨çš„å‹åŠ›ï¼Œæˆ‘ä»¬ä¼šæŠŠjsã€cssï¼Œimgç­‰é™æ€èµ„æºåˆ†ç¦»åˆ°å¦ä¸€å°ç‹¬ç«‹åŸŸåçš„æœåŠ¡å™¨ä¸Šï¼Œä½¿å…¶å’Œå‰ç«¯åˆ†ç¦»å¼€ã€‚åŸºäºè¿™ä¸ªåŸå› ï¼Œæµè§ˆå™¨å¹¶æ²¡æœ‰é™åˆ¶è¿™ç±»é™æ€èµ„æºçš„è·¨åŸŸè®¿é—®ã€‚ æˆ‘ä»¬å¯ä»¥åŠ¨æ€åœ°åˆ›å»ºä¸€ä¸ªscriptï¼Œè®©æµè§ˆå™¨ä»¥ä¸ºæˆ‘ä»¬è¦è·å–é™æ€èµ„æºï¼Œä»è€Œç½‘å¼€ä¸€é¢ã€‚è€ŒæœåŠ¡å™¨ç«¯ä¹Ÿéœ€è¦åšä¸€ç‚¹æ”¹å˜ï¼Œä¸èƒ½ç›´æ¥è¿”å›jsonï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªç«‹å³æ‰§è¡Œçš„å‡½æ•°ï¼Œè€Œå‰ç«¯è¯·æ±‚çš„ç»“æœå°±ä½œä¸ºå‡½æ•°çš„å‚æ•°ã€‚ åç«¯æ¥å£è¿”å›12345678910111213141516171819@SpringBootApplication@Configuration@RestControllerpublic class ApplicationA &#123; public static void main(String[] args) &#123; SpringApplication.run(ApplicationA.class, args); &#125; @RequestMapping(\"/test\") public String test(HttpServletRequest request, HttpServletResponse response, String callback) throws IOException &#123; Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(\"success\", true); map.put(\"msg\", \"æˆ‘æ¥è‡ªæœåŠ¡ç«¯\"); // è¿”å›å€¼å¦‚ä¸‹ï¼š // callback(&#123;\"msg\":\"æˆ‘æ¥è‡ªæœåŠ¡ç«¯\",\"success\":true&#125;); return String.format(\"%s(%s);\", callback, JsonUtil.toJson(map)); &#125; jsåŸç”Ÿå®ç°jsonp12345678910111213141516function test() &#123; // å¤–éƒ¨åŸŸåï¼Œå‚æ•°æ˜¯å’Œåç«¯æ¥å£çº¦å®šçš„callbackæŒ‡å®šæ¥å£è¿”å›åçš„å›è°ƒå‡½æ•° url = \"http://localhost:8882/test?callback=_ajax_callback\"; // åˆ›å»ºä¸€ä¸ªscriptå…ƒç´  var script = document.createElement('script'); script.type = 'text/javascript'; script.src = url; document.head.appendChild(script);&#125;// æ¥å£å›è°ƒfunction _ajax_callback(res) &#123; console.log(\"è¢«å›è°ƒäº†\"); console.log(res);&#125; æ¥å£è¿”å›ï¼š å›è°ƒå‡½æ•°æ‰§è¡Œï¼š jQueryå®ç°jsonpä¸€èˆ¬æˆ‘ä»¬ä¼šä½¿ç”¨jQueryæ¥åšajaxè¯·æ±‚ï¼Œè¿™æ ·éœ€è¦å¢åŠ ä¸€ä¸ªjQueryçš„å¼•ç”¨ã€‚ 12345678// æ²¡æµ‹ï¼Œæ‡’å¾—æµ‹$.ajax(&#123; url: 'http://localhost:8882/test', type: 'get', dataType: 'jsonp', // è¯·æ±‚æ–¹å¼ jsonpCallback: \"_ajax_callback\", // å›è°ƒå‡½æ•°å data: &#123;&#125;&#125;); vue.jså®ç°jsonpç°åœ¨å‰ç«¯vue.jsç”¨çš„ä¹Ÿå¾ˆå¤šï¼Œå†è®°å½•ä¸€ä¸ªvue.jsçš„ç”¨æ³•ã€‚ 1234567// æ²¡æµ‹ï¼Œæ‡’å¾—æµ‹this.$http.jsonp('http://localhost:8882/test', &#123; params: &#123;&#125;, jsonp: '_ajax_callback'&#125;).then((res) =&gt; &#123; console.log(res); &#125;) jsonpç¼ºç‚¹åªèƒ½å®ç°getè¯·æ±‚ã€‚ å…¶å®ƒæ–¹å¼æ”¯æŒè·¨åŸŸ nginxåå‘ä»£ç†ï¼šå‰ç«¯è®¿é—®ç›¸åŒåŸŸåï¼Œnginxå†æ ¹æ®éœ€è¦æŠŠè¯·æ±‚è½¬å‘åˆ°å¤–éƒ¨åŸŸåï¼› åç«¯ä»£ç†ï¼šåœ¨åç«¯æ¥å£é‡Œå…ˆè¯·æ±‚å¤–éƒ¨èµ„æºï¼ˆæ¯”å¦‚ç”¨HttpClientï¼‰ï¼Œç„¶åæŠŠç»“æœè¿”å›ç»™å‰ç«¯ï¼Œè¿™æ ·å°±ä¸æ˜¯è·¨åŸŸäº†ï¼› å…¶å®ƒï¼šå€ŸåŠ©iframeã€postMessageç­‰ä¹Ÿå¯å®ç°è·¨åŸŸã€‚","categories":[{"name":"éšç¬”","slug":"éšç¬”","permalink":"https://acupt.github.io/categories/éšç¬”/"}],"tags":[{"name":"è·¨åŸŸ","slug":"è·¨åŸŸ","permalink":"https://acupt.github.io/tags/è·¨åŸŸ/"}],"keywords":[{"name":"éšç¬”","slug":"éšç¬”","permalink":"https://acupt.github.io/categories/éšç¬”/"}]},{"title":"æ¢ç´¢JAVAå¹¶å‘ - çº¿ç¨‹æ± è¯¦è§£","slug":"concurrent-thread-pool","date":"2019-07-30T13:55:00.000Z","updated":"2019-08-02T07:59:10.107Z","comments":true,"path":"2019/07/30/concurrent-thread-pool/","link":"","permalink":"https://acupt.github.io/2019/07/30/concurrent-thread-pool/","excerpt":"","text":"çº¿ç¨‹æ± æ˜¯å¹¶å‘ç¼–ç¨‹ä¸­å¿…ä¸å¯å°‘çš„ä¸€ç§å·¥å…·ï¼Œä¹Ÿæ˜¯é¢è¯•é«˜é¢‘è¯é¢˜ã€‚ çº¿ç¨‹æ± ï¼Œå³ç®¡ç†ç€è‹¥å¹²çº¿ç¨‹çš„èµ„æºæ± ï¼ˆå­—é¢æ„æ€ï¼‰ã€‚ç›¸æ¯”äºä¸ºæ¯ä¸ªä»»åŠ¡åˆ†é…ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œä»»åŠ¡ä¼˜åŠ¿æ›´å¤šï¼š çº¿ç¨‹å¤ç”¨ï¼šçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œçœå»äº†åˆ›å»ºã€é”€æ¯çº¿ç¨‹çš„å¼€é”€ï¼Œæé«˜äº†èµ„æºåˆ©ç”¨ç‡ï¼ˆåˆ›å»ºã€é”€æ¯ç­‰æ“ä½œéƒ½æ˜¯è¦æ¶ˆè€—ç³»ç»Ÿèµ„æºçš„ï¼‰å’Œå“åº”é€Ÿåº¦ï¼ˆä»»åŠ¡æäº¤è¿‡æ¥çº¿ç¨‹å·²å­˜åœ¨å°±ä¸ç”¨ç­‰å¾…çº¿ç¨‹åˆ›å»ºäº†ï¼‰ï¼› åˆç†åˆ©ç”¨èµ„æºï¼šé€šè¿‡è°ƒæ•´çº¿ç¨‹æ± å¤§å°ï¼Œè®©æ‰€æœ‰å¤„ç†å™¨å°½é‡ä¿æŒå¿™ç¢Œï¼Œåˆèƒ½é˜²æ­¢è¿‡å¤šçº¿ç¨‹äº§ç”Ÿè¿‡å¤šç«äº‰æµªè´¹èµ„æºï¼› å¸¸ç”¨çš„çº¿ç¨‹æ± ä¸»è¦æ˜¯ThreadPoolExecutor å’Œ ScheduledThreadPoolExecutor(å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± ï¼Œç»§æ‰¿ThreadPoolExecutor)ã€‚ Executoræ¡†æ¶ åœ¨JAVAä¸­ï¼Œä»»åŠ¡æ‰§è¡Œçš„ä¸»è¦æŠ½è±¡ä¸æ˜¯Threadï¼Œè€Œæ˜¯Executorã€‚ExecutoråŸºäºç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œæäº¤ä»»åŠ¡çš„æ“ä½œç›¸å½“äºç”Ÿäº§è€…ï¼Œæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ç›¸å½“äºæ¶ˆè´¹è€…ã€‚ æ‰€è°“Executoræ¡†æ¶ï¼Œå…¶å®å°±æ˜¯å®šä¹‰äº†ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„çº¿ç¨‹æ± ThreadPoolExecutorå°±æ˜¯å¯¹è¿™ä¸ªæ¥å£çš„ä¸€ç§å®ç°ã€‚ 12345678910111213public interface Executor &#123; /** * Executes the given command at some time in the future. The command * may execute in a new thread, in a pooled thread, or in the calling * thread, at the discretion of the &#123;@code Executor&#125; implementation. * * @param command å¯æ‰§è¡Œçš„ä»»åŠ¡ * @throws RejectedExecutionException ä»»åŠ¡å¯èƒ½è¢«æ‹’ç»ï¼ˆå½“Executorå¤„ç†ä¸äº†çš„æ—¶å€™ï¼‰ * @throws NullPointerException if command is null */ void execute(Runnable command);&#125; Executorsä¸å¸¸ç”¨çº¿ç¨‹æ±  Executorså…¶å®å°±æ˜¯Executor(åŠ s) Executorsæ˜¯ä¸€ä¸ªExecutorçš„å·¥å‚ï¼Œæœ‰å¾ˆå¤šå®šä¹‰å¥½çš„å·¥å‚æ–¹æ³•ï¼Œå¯ä»¥å¸®åŠ©æ‡’æƒ°çš„å¼€å‘è€…å¿«é€Ÿåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ã€‚ä¸‹é¢æ˜¯å‡ ä¸ªå¸¸ç”¨çš„å·¥å‚æ–¹æ³•ï¼š newFixedThreadPool å›ºå®šé•¿åº¦çº¿ç¨‹æ± ï¼Œæ¯æ¬¡æäº¤ä»»åŠ¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œç›´åˆ°çº¿ç¨‹æ•°é‡è¾¾åˆ°æŒ‡å®šé˜ˆå€¼åˆ™ä¸å†åˆ›å»ºæ–°çš„ï¼› newCachedThreadPool å¯ç¼“å­˜çº¿ç¨‹æ± ï¼Œæ¯æ¬¡æäº¤ä»»åŠ¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼ˆç†è®ºä¸Šæ— é™åˆ¶ï¼‰ï¼Œéƒ¨åˆ†ä»»åŠ¡æ‰§è¡Œå®Œåå¦‚æœæ²¡æœ‰æ–°çš„ä»»åŠ¡ï¼Œå¯¼è‡´æŸäº›çº¿ç¨‹æ— ç”¨æ­¦ä¹‹åœ°ï¼Œå®ƒä»¬å°†è¢«ç»ˆç»“ï¼› newSingleThreadExecutor åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ï¼› newScheduledThreadPool å¯ä»¥å»¶æ—¶æˆ–è€…å®šæ—¶æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± ã€‚ 12345678910111213141516171819202122232425public class Executors &#123; public static ExecutorService newFixedThreadPool(int nThreads) &#123; return new ThreadPoolExecutor(nThreads, nThreads, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;Runnable&gt;()); &#125; public static ExecutorService newCachedThreadPool() &#123; return new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60L, TimeUnit.SECONDS, new SynchronousQueue&lt;Runnable&gt;()); &#125; public static ExecutorService newSingleThreadExecutor() &#123; return new FinalizableDelegatedExecutorService (new ThreadPoolExecutor(1, 1, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;Runnable&gt;())); &#125; public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize) &#123; return new ScheduledThreadPoolExecutor(corePoolSize); &#125;&#125; å¦‚æœæŸ¥çœ‹ä¸Šè¿°å·¥å‚æ–¹æ³•çš„æºç ï¼Œä¼šå‘ç°åªæ˜¯newäº†ä¸€ä¸ªçº¿ç¨‹æ± å¯¹è±¡è¿”å›ç»™è°ƒç”¨è€…è€Œå·²ï¼Œæ²¡ä»€ä¹ˆèŠ±é‡Œèƒ¡å“¨çš„ä¸œè¥¿ã€‚ä¸è¿‡çœ‹çœ‹æ„é€ å‚æ•°è¿˜çœŸä¸å°‘ï¼Œé€šè¿‡è¿™ç§æ–¹å¼æ¯”èµ·æˆ‘ä»¬è‡ªå·±newä¸€ä¸ªçº¿ç¨‹æ± è¦ç®€å•å¤šäº†ï¼ˆæ‰æ€ªï¼‰ã€‚ çº¿ç¨‹æ± æ„é€ å‚æ•°äº†è§£çº¿ç¨‹æ± æ„é€ å‚æ•°çš„æ„ä¹‰ï¼Œèƒ½è®©æˆ‘ä»¬æ›´æ¸…æ¥šç¨‹åºæ‰§è¡Œé€»è¾‘ã€‚ int corePoolSize : æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæœ‰æ–°ä»»åŠ¡æ¥æ—¶ï¼Œå¦‚æœå½“å‰çº¿ç¨‹å°äºæ ¸å¿ƒçº¿ç¨‹ï¼Œåˆ™æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œè¯¥ä»»åŠ¡ int maximumPoolSize : æœ€å¤§çº¿ç¨‹æ•°ï¼Œçº¿ç¨‹æ± æœ€å¤šæ‹¥æœ‰çš„çº¿ç¨‹æ•° long keepAliveTime : ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ TimeUnit unit : ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´çš„å•ä½ BlockingQueue workQueue : å­˜æ”¾å¾…æ‰§è¡Œä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ–°ä»»åŠ¡æ¥æ—¶ï¼Œè‹¥å½“å‰çº¿ç¨‹æ•°&gt;=æœ€å¤§æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™æ”¾åˆ°è¿™ä¸ªé˜Ÿåˆ—(å…·ä½“é€»è¾‘æ›´å¤æ‚ï¼Œè¯·çœ‹ä¸‹é¢æºç åˆ†æ) ThreadFactory threadFactory : åˆ›å»ºæ–°çº¿ç¨‹çš„å·¥å‚ï¼Œä¸€èˆ¬ç”¨æ¥ç»™çº¿ç¨‹å–ä¸ªåå­—æ–¹ä¾¿æ’æŸ¥é—®é¢˜ RejectedExecutionHandler handler : ä»»åŠ¡è¢«æ‹’ç»åçš„å¤„ç†å™¨ï¼Œé»˜è®¤çš„å¤„ç†å™¨ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œå»ºè®®é‡æ–°å®ç° é…åˆæºç ï¼Œæ•ˆæœæ›´ä½³ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970public class ThreadPoolExecutor extends AbstractExecutorService &#123; // æ„é€ å‡½æ•° public ThreadPoolExecutor(int corePoolSize, // æ ¸å¿ƒçº¿ç¨‹æ•° int maximumPoolSize, // æœ€å¤§çº¿ç¨‹æ•° long keepAliveTime, // ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ TimeUnit unit, // ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´çš„å•ä½ BlockingQueue&lt;Runnable&gt; workQueue, // å­˜æ”¾å¾…æ‰§è¡Œä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ— ThreadFactory threadFactory, // åˆ›å»ºæ–°çº¿ç¨‹çš„å·¥å‚ RejectedExecutionHandler handler // ä»»åŠ¡è¢«æ‹’ç»åçš„å¤„ç†å™¨ ) &#123; // ... &#125; // æäº¤ä»»åŠ¡ public void execute(Runnable command) &#123; if (command == null) throw new NullPointerException(); /* * æ²¡ç¿»ï¼Œæ‡’å¾—ç¿» * Proceed in 3 steps: * * 1. If fewer than corePoolSize threads are running, try to * start a new thread with the given command as its first * task. The call to addWorker atomically checks runState and * workerCount, and so prevents false alarms that would add * threads when it shouldn't, by returning false. * * 2. If a task can be successfully queued, then we still need * to double-check whether we should have added a thread * (because existing ones died since last checking) or that * the pool shut down since entry into this method. So we * recheck state and if necessary roll back the enqueuing if * stopped, or start a new thread if there are none. * * 3. If we cannot queue task, then we try to add a new * thread. If it fails, we know we are shut down or saturated * and so reject the task. */ // å½“å‰çŠ¶æ€å€¼ int c = ctl.get(); // å½“å‰çº¿ç¨‹æ•° = workerCountOf(c) å°äº æ ¸å¿ƒçº¿ç¨‹æ•° çš„ä¸Šé™æ—¶ // ç›´æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ if (workerCountOf(c) &lt; corePoolSize) &#123; // å¹¶å‘æäº¤åœºæ™¯ä¸‹å¯èƒ½ä¼šå¤±è´¥ if (addWorker(command, true)) return; // æ–°å¢æˆåŠŸå°±å¯ä»¥ç»“æŸäº† // å¤±è´¥å°±æ›´æ–°ä¸‹çº¿ç¨‹æ± çŠ¶æ€ c = ctl.get(); &#125; // ä¸èƒ½åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ¥æ‰§è¡Œï¼Œå¹¶ä¸ä¼šç›´æ¥åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹ï¼Œè€Œæ˜¯æŠŠä»»åŠ¡æš‚å­˜åˆ°é˜»å¡é˜Ÿåˆ— // isRunning(c)åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦è¿˜åœ¨è¿è¡Œ // workQueue.offer(command)è¿”å›å€¼è¡¨ç¤ºæ˜¯å¦æˆåŠŸæäº¤åˆ°é˜Ÿåˆ— if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123; // æˆåŠŸæ”¾åˆ°é˜Ÿåˆ—é‡Œäº†ï¼Œå†æ£€æŸ¥ä¸€ä¸‹çº¿ç¨‹æ± çŠ¶æ€ int recheck = ctl.get(); // å¦‚æœçº¿ç¨‹æ± å·²ç»æ²¡æœ‰è¿è¡Œäº†ï¼Œåˆ™å°è¯•æŠŠæ–°å¢çš„ä»»åŠ¡ä»é˜Ÿåˆ—ç§»é™¤ // remove(command)è¿”å›å€¼è¡¨ç¤ºæ˜¯å¦ç§»é™¤æˆåŠŸ if (! isRunning(recheck) &amp;&amp; remove(command)) reject(command); // ç§»é™¤æˆåŠŸåï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥ // æ£€æŸ¥ä¸‹å½“å‰çº¿ç¨‹æ•°æ˜¯å¦ä¸º0ï¼Œå¦‚æœæ˜¯çš„è¯æ–°å»ºä¸€ä¸ªçº¿ç¨‹ else if (workerCountOf(recheck) == 0) addWorker(null, false); &#125; // çº¿ç¨‹æ± æ²¡æœ‰è¿è¡Œï¼Œæˆ–è€…æ”¾å…¥é˜Ÿåˆ—å¤±è´¥ï¼ˆæ¯”å¦‚é˜Ÿåˆ—å·²æ»¡ï¼‰ // åˆ™åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œè¿™ä¹Ÿå¤±è´¥å°±åªèƒ½æ‹’ç»äº† else if (!addWorker(command, false)) reject(command); &#125; å½“å¯¹çº¿ç¨‹æ± çš„æ„é€ å‚æ•°å’Œä»»åŠ¡å¤„ç†é€»è¾‘æœ‰äº†ä»¥ä¸Šå¤§è‡´çš„äº†è§£åï¼Œå›æƒ³Executorsæä¾›çš„å‡ ä¸ªå·¥å‚æ–¹æ³•ï¼Œæˆ–è®¸ä¼šæ„Ÿåˆ°æ‰€è°“æä¾›ä¾¿åˆ©æ€§çš„æ–¹æ³•å¹¶ä¸é‚£ä¹ˆä¾¿åˆ©ã€‚å› ä¸ºä»æ–¹æ³•çš„åå­—ä¸Šæ¥çœ‹å¾ˆéš¾å’Œçº¿ç¨‹æ± çš„é…ç½®å‡†ç¡®å…³è”ï¼Œæƒ³è¦æ¸…é™¤åœ°çŸ¥é“è¿™äº›æ–¹æ³•åˆ›å»ºçš„çº¿ç¨‹æ± å¦‚ä½•è¿ä½œï¼Œå°±éœ€è¦çŸ¥é“ä»–ä»¬ç”¨äº†æ€æ ·çš„æ„é€ å‚æ•°ï¼Œé‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨æ„é€ æ–¹æ³•å‘¢ï¼Ÿ æ‰€ä»¥å°½é‡ä½¿ç”¨æ„é€ æ–¹æ³•æ˜¯æ›´å¥½çš„ç¼–ç¨‹ä¹ æƒ¯ï¼Œè¿™æ ·ä¸ç®¡æ˜¯ä½œè€…è¿˜æ˜¯å…¶ä»–å¼€å‘è€…ï¼Œåªè¦çœ‹çœ‹ä¼ äº†ä»€ä¹ˆå‚æ•°ï¼Œå°±çŸ¥é“è¿™ä¸ªçº¿ç¨‹æ± æ˜¯æ€ä¹ˆè¿ä½œçš„äº†ã€‚ çº¿ç¨‹æ± åˆ›å»ºç¤ºä¾‹1234567891011121314151617181920212223242526272829303132import java.util.concurrent.*;import java.util.concurrent.atomic.AtomicInteger;public class Main &#123; public static void main(String[] args) throws Exception &#123; AtomicInteger threadCount = new AtomicInteger(); ThreadPoolExecutor executor = new ThreadPoolExecutor( 5, // æ ¸å¿ƒçº¿ç¨‹æ•° 10, // æœ€å¤§çº¿ç¨‹æ•° 1, // ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ TimeUnit.MINUTES, // ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´å•ä½ new ArrayBlockingQueue&lt;&gt;(100), // ä¸€ä¸ªæŒ‡å®šä¸Šé™çš„é˜»å¡é˜Ÿåˆ—ï¼Œå­˜æ”¾å¾…æ‰§è¡Œä»»åŠ¡ new ThreadFactory() &#123; // è‡ªå®šä¹‰ä¸€ä¸ªçº¿ç¨‹å·¥å‚æ¥ç»™çº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹å–åå­— @Override public Thread newThread(Runnable r) &#123; return new Thread(r, \"pool-thread-\" + threadCount.incrementAndGet()); &#125; &#125;, new RejectedExecutionHandler() &#123; // è‡ªå®šä¹‰ä¸€ä¸ªæ‹’ç»å¤„ç†ç­–ç•¥ï¼Œå®‰æ…°è¢«çº¿ç¨‹æ± æ‹’ä¹‹é—¨å¤–çš„å°å¯æ€œ @Override public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) &#123; System.out.println(\"çº¿ç¨‹æ± æ‹’ç»äº†ä»»åŠ¡: \" + r); &#125; &#125; ); &#125;&#125; æœ‰è¿”å›å€¼çš„æäº¤æ–¹å¼submitThreadPoolExecutor.execute()æ–¹æ³•æ˜¯æ²¡æœ‰è¿”å›å€¼çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æŠŠä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± åï¼Œæˆ‘ä»¬å°±å¤±å»äº†å®ƒçš„æ¶ˆæ¯ï¼Œé™¤éä½ è¿˜ä¿ç•™ç€å®ƒçš„å¼•ç”¨ï¼Œå¹¶ä¸”åœ¨é‡Œé¢æœ‰ç»´æŠ¤çŠ¶æ€ã€‚å¦‚æœä¸æƒ³è¿™ä¹ˆéº»çƒ¦ï¼Œå¯ä»¥ä½¿ç”¨ThreadPoolExecutor.submit()æ¥æäº¤ä»»åŠ¡ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªFutureå¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ªå¯¹è±¡å¯ä»¥çŸ¥é“ä»»åŠ¡ä½•æ—¶è¢«æ‰§è¡Œå®Œã€‚ 123456789101112131415161718192021222324252627282930313233import java.util.concurrent.*;import java.util.concurrent.atomic.AtomicInteger;public class Main &#123; public static void main(String[] args) throws Exception &#123; // çº¿ç¨‹æ± å®šä¹‰ // ... Future&lt;?&gt; future = executor.submit(new Runnable() &#123; @Override public void run() &#123; try &#123; Thread.sleep(2000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(\"æˆ‘è¦å…³æ³¨: ä¸€æ¯82å¹´çš„JAVA\"); &#125; &#125;); Object r = future.get(); System.out.println(\"è¿”å›ï¼š\" + r); executor.shutdown(); &#125;&#125;/* è¾“å‡º: æˆ‘è¦å…³æ³¨: ä¸€æ¯82å¹´çš„JAVAè¿”å›ï¼šnull*/ å¯ä»¥çœ‹åˆ°Future.get()æ˜¯æœ‰è¿”å›å€¼çš„ï¼Œä½†æ˜¯ä¸Šé¢çš„ä¾‹å­è¿”å›äº†nullï¼Œå› ä¸ºä»»åŠ¡æ˜¯ä¸€ä¸ªRunnableå®ç°ï¼Œrunæ–¹æ³•æ²¡æœ‰è¿”å›å€¼ã€‚ submit Callableå¦‚æœæƒ³ä»»åŠ¡æœ‰è¿”å›å€¼ï¼Œå¯ä»¥ä½¿ç”¨Callableä½œä¸ºä»»åŠ¡å®šä¹‰ã€‚ 12345678910111213141516171819202122232425262728293031323334import java.util.concurrent.*;import java.util.concurrent.atomic.AtomicInteger;public class Main &#123; public static void main(String[] args) throws Exception &#123; // çº¿ç¨‹æ± å®šä¹‰ // ... Future&lt;String&gt; future = executor.submit(new Callable&lt;String&gt;() &#123; @Override public String call() throws Exception &#123; try &#123; Thread.sleep(2000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(\"I'm fine, and you?\"); return \"æˆ‘è¦å…³æ³¨: ä¸€æ¯82å¹´çš„JAVA\"; &#125; &#125;); String r = future.get(); System.out.println(\"è¿”å›ï¼š\" + r); executor.shutdown(); &#125;&#125;/* è¿”å›:I'm fine, and you?è¿”å›ï¼šæˆ‘è¦å…³æ³¨: ä¸€æ¯82å¹´çš„JAVA*/ submitå®ç°åŸç†ä¸ºä»€ä¹ˆsubmitå°±å¯ä»¥è®©ç”¨æˆ·ç­‰å¾…ã€è·å–ä»»åŠ¡è¿”å›ï¼Ÿä»æºç è®²èµ·ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667public abstract class AbstractExecutorService implements ExecutorService &#123; public &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task) &#123; if (task == null) throw new NullPointerException(); // æŠŠä»»åŠ¡ç”¨ä¸€ä¸ªRunnableFutureåˆç»™åŒ…è£…äº†ä¸€ä¸‹ RunnableFuture&lt;T&gt; ftask = newTaskFor(task); // æœ€åè¿˜æ˜¯è°ƒç”¨äº†æ²¡æœ‰è¿”å›å€¼çš„execute execute(ftask); return ftask; &#125; protected &lt;T&gt; RunnableFuture&lt;T&gt; newTaskFor(Callable&lt;T&gt; callable) &#123; return new FutureTask&lt;T&gt;(callable); &#125;&#125;// çœ‹çœ‹è¿™ä¸ªåŒ…è£…ç±»public class FutureTask&lt;V&gt; implements RunnableFuture&lt;V&gt; &#123; private Callable&lt;V&gt; callable; private volatile int state; // ä¹Ÿæ˜¯Runableçš„ä¸€ç§å®ç°ï¼Œæ‰€ä»¥èƒ½åœ¨çº¿ç¨‹æ± ä¸­è¢«æ‰§è¡Œ public void run() &#123; // æœ‰ä¸ªè¡¨ç¤ºçŠ¶æ€çš„æ ‡è¯† if (state != NEW || !UNSAFE.compareAndSwapObject(this, runnerOffset, null, Thread.currentThread())) return; try &#123; Callable&lt;V&gt; c = callable; if (c != null &amp;&amp; state == NEW) &#123; V result; boolean ran; try &#123; // æ‰§è¡Œç”¨æˆ·çš„é€»è¾‘ï¼Œè·å¾—è¿”å›å€¼ // è¿™ä¸ªæ­¥éª¤å¯èƒ½éœ€è¦ç‚¹æ—¶é—´ result = c.call(); ran = true; &#125; catch (Throwable ex) &#123; result = null; ran = false; setException(ex); &#125; if (ran) set(result); &#125; &#125; finally &#123; // runner must be non-null until state is settled to // prevent concurrent calls to run() runner = null; // state must be re-read after nulling runner to prevent // leaked interrupts int s = state; if (s &gt;= INTERRUPTING) handlePossibleCancellationInterrupt(s); &#125; &#125; // è·å–æ‰§è¡Œç»“æœï¼Œé˜»å¡ç›´åˆ°çŠ¶æ€æ”¹å˜ public V get() throws InterruptedException, ExecutionException &#123; int s = state; if (s &lt;= COMPLETING) s = awaitDone(false, 0L); return report(s); &#125;&#125; å°ç»“ï¼šsubmitæ—¶ç”¨ä¸€ä¸ªFutureTaskæŠŠç”¨æˆ·æäº¤çš„CallableåŒ…è£…èµ·æ¥ï¼Œå†æŠŠFutureTaskæäº¤ç»™çº¿ç¨‹æ± æ‰§è¡Œï¼ŒFutureTask.runè¿è¡Œæ—¶ä¼šæ‰§è¡ŒCallableä¸­çš„ä¸šåŠ¡ä»£ç ï¼Œå¹¶ä¸”è¿‡ç¨‹ä¸­FutureTaskä¼šç»´æŠ¤ä¸€ä¸ªçŠ¶æ€æ ‡è¯†ï¼Œæ ¹æ®çŠ¶æ€æ ‡è¯†ï¼Œå¯ä»¥çŸ¥é“ä»»åŠ¡æ˜¯å¦æ‰§è¡Œå®Œæˆï¼Œä¹Ÿå¯ä»¥é˜»å¡åˆ°çŠ¶æ€ä¸ºå®Œæˆè·å–è¿”å›å€¼ã€‚ å…³é—­çº¿ç¨‹æ± ä¸ºä»€ä¹ˆéœ€è¦å…³é—­çº¿ç¨‹æ± ï¼Ÿ å¦‚æœçº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹ä¸€ç›´å­˜æ´»ï¼Œè€Œä¸”è¿™äº›çº¿ç¨‹åˆä¸æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´è™šæ‹Ÿæœºæ— æ³•æ­£å¸¸é€€å‡ºï¼› å¦‚æœç›´æ¥ç²—æš´åœ°ç»“æŸåº”ç”¨ï¼Œçº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡å¯èƒ½æ²¡æ‰§è¡Œå®Œï¼Œä¸šåŠ¡å°†å¤„äºæœªçŸ¥çŠ¶æ€ï¼› çº¿ç¨‹ä¸­æœ‰äº›è¯¥é‡Šæ”¾çš„èµ„æºæ²¡æœ‰è¢«é‡Šæ”¾ã€‚ æ€ä¹ˆå…³é—­çº¿ç¨‹æ± ï¼Ÿ shutdown åœæ­¢æ¥æ”¶æ–°ä»»åŠ¡ï¼ˆç»§ç»­æäº¤ä¼šè¢«æ‹’ç»ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥ï¼‰ï¼Œä½†å·²æäº¤çš„ä»»åŠ¡ä¼šç»§ç»­æ‰§è¡Œï¼Œå…¨éƒ¨å®Œæˆåçº¿ç¨‹æ± å½»åº•å…³é—­ï¼› shutdownNow ç«‹å³åœæ­¢çº¿ç¨‹æ± ï¼Œå¹¶å°è¯•ç»ˆæ­¢æ­£åœ¨è¿›è¡Œçš„çº¿ç¨‹ï¼ˆé€šè¿‡ä¸­æ–­ï¼‰ï¼Œè¿”å›æ²¡æ‰§è¡Œçš„ä»»åŠ¡é›†åˆï¼› awaitTermination é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°å…¨éƒ¨ä»»åŠ¡æ‰§è¡Œå®Œï¼Œæˆ–è€…ç­‰å¾…è¶…æ—¶ï¼Œæˆ–è€…è¢«ä¸­æ–­ã€‚ ç”±äºshutdownNowçš„ç»ˆæ­¢çº¿ç¨‹æ˜¯é€šè¿‡ä¸­æ–­ï¼Œè¿™ä¸ªæ–¹å¼å¹¶ä¸èƒ½ä¿è¯çº¿ç¨‹ä¼šæå‰åœæ­¢ã€‚ï¼ˆå…³äºä¸­æ–­: å¦‚ä½•å¤„ç†çº¿ç¨‹ä¸­æ–­ï¼‰ ä¸€èˆ¬å…ˆè°ƒç”¨shutdownè®©çº¿ç¨‹æ± åœæ­¢æ¥å®¢ï¼Œç„¶åè°ƒç”¨awaitTerminationç­‰å¾…æ­£åœ¨å·¥ä½œçš„çº¿ç¨‹å®Œäº‹ã€‚ 123456// ä½ çš„æ± å­å¯¹æˆ‘æ‰“äº†çƒŠexecutor.shutdown();// ç­‰å¾…ä¸€é¦–æ­Œçš„æ—¶é—´ï¼ˆbei~bei~~ï¼‰// å¦‚æœè¶…æ—¶è¿˜æ²¡ç»“æŸè¿”å›falseï¼Œä½ å¯ä»¥é€‰æ‹©å†ç­‰ä¸€é¦–é•¿ç‚¹çš„æ­Œï¼Œæˆ–è€…ä¸ç­‰äº†boolean ok = executor.awaitTermination(4, TimeUnit.SECONDS); æ‰©å±•çº¿ç¨‹æ± çº¿ç¨‹æ± æä¾›äº†ä¸€äº›æ‰©å±•çš„æ–¹æ³•ï¼Œé€šè¿‡é‡å†™è¿™äº›æ–¹æ³•å¯ä»¥æ·»åŠ å‰ç½®ã€åç½®æ“ä½œï¼Œè®©ä½¿ç”¨æ›´çµæ´»ã€‚å¦‚beforeExecuteã€afterExecuteã€terminated â€¦ æ€»ç»“çº¿ç¨‹æ± å¾ˆå¥½ç”¨ï¼Œä½†ä½¿ç”¨ä¸å½“ä¼šé€ æˆä¸¥é‡çš„åæœï¼Œäº†è§£å®ƒå„ä¸ªå±æ€§è¡¨ç¤ºçš„å«ä¹‰ä»¥åŠæ‰§è¡Œçš„æµç¨‹èƒ½å¸®åŠ©æˆ‘ä»¬å°‘è¸©å‘ã€‚ ä¸¾ä¸ªä¾‹å­ï¼šå¦‚æœè®¾ç½®äº†æ ¸å¿ƒçº¿ç¨‹ &lt; æœ€å¤§çº¿ç¨‹æ•°ä¸ç­‰ï¼ˆä¸€èˆ¬éƒ½è¿™ä¹ˆè®¾ç½®ï¼‰ï¼Œä½†æ˜¯åˆè®¾ç½®äº†ä¸€ä¸ªå¾ˆå¤§çš„é˜»å¡é˜Ÿåˆ—ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½åªæœ‰å‡ ä¸ªæ ¸å¿ƒçº¿ç¨‹åœ¨å·¥ä½œï¼Œæ™®é€šçº¿ç¨‹ä¸€ç›´æ²¡æœºä¼šè¢«åˆ›å»ºï¼Œå› ä¸ºæ ¸å¿ƒçº¿ç¨‹æ»¡äº†ä¼šä¼˜å…ˆæ”¾åˆ°é˜Ÿåˆ—é‡Œï¼Œè€Œä¸æ˜¯åˆ›å»ºæ™®é€šçº¿ç¨‹ã€‚","categories":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://acupt.github.io/categories/å¹¶å‘ç¼–ç¨‹/"}],"tags":[{"name":"çº¿ç¨‹","slug":"çº¿ç¨‹","permalink":"https://acupt.github.io/tags/çº¿ç¨‹/"},{"name":"çº¿ç¨‹æ± ","slug":"çº¿ç¨‹æ± ","permalink":"https://acupt.github.io/tags/çº¿ç¨‹æ± /"}],"keywords":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://acupt.github.io/categories/å¹¶å‘ç¼–ç¨‹/"}]},{"title":"æºç åˆ†æ - JVMå…³é—­é’©å­çš„æ³¨å†Œå’Œè°ƒç”¨","slug":"jvm-shutdown-hook","date":"2019-07-29T14:00:00.000Z","updated":"2019-07-29T15:22:52.264Z","comments":true,"path":"2019/07/29/jvm-shutdown-hook/","link":"","permalink":"https://acupt.github.io/2019/07/29/jvm-shutdown-hook/","excerpt":"","text":"é€šè¿‡å…³é—­é’©å­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åº”ç”¨å…³é—­æ—¶åšä¸€äº›è‡ªå®šä¹‰çš„æ“ä½œï¼Œè®©ç¨‹åºæ›´ä¼˜é›…çš„ç»“æŸã€‚ JAVAç¨‹åºè¿è¡Œåœ¨è™šæ‹Ÿæœºä¸Š(JVM)ï¼ŒJAVAç¨‹åºæ‰§è¡Œå®Œæˆï¼ŒJVMä¹Ÿéšä¹‹å…³é—­ã€‚å…³é—­çš„æ–¹å¼æœ‰å¤šç§ï¼Œæ ¹æ®å…¶è¡Œä¸ºçš„æ–‡æ˜ç¨‹åº¦å¯å¤§æ¦‚åˆ†ä¸ºä¸¤ç§ï¼š æ­£å¸¸å…³é—­ æ‰€æœ‰æ™®é€šçº¿ç¨‹ï¼ˆéå®ˆæŠ¤çº¿ç¨‹ï¼‰æ‰§è¡Œå®Œæ¯• System.exit(status) Ctrl - C â€¦ å¼ºè¡Œå…³é—­ killè¿›ç¨‹ Runtime.halt(status) â€¦ JVMå…³é—­é’©å­DEMO123456789101112131415161718192021public class Main &#123; public static void main(String[] args) throws Exception &#123; Runtime.getRuntime().addShutdownHook(new MyHook()); System.out.println(\"ç»“æŸå§\"); &#125; public static class MyHook extends Thread &#123; @Override public void run() &#123; System.out.println(\"ä½ å…ˆèµ°ï¼Œæˆ‘å«å\"); &#125; &#125;&#125;/* è¾“å‡º:ç»“æŸå§ä½ å…ˆèµ°ï¼Œæˆ‘å«å*/ è‡ªå®šä¹‰é’©å­å¦‚ä½•æ³¨å†Œ12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879public class Runtime &#123; // é’©å­å¯¹è±¡å¿…é¡»æ˜¯ä¸€ä¸ªThreadï¼ˆæˆ–å…¶å­ç±»ï¼‰ public void addShutdownHook(Thread hook) &#123; // çœ‹èµ·æ¥æ˜¯ä¸ªæƒé™æ£€æŸ¥ SecurityManager sm = System.getSecurityManager(); if (sm != null) &#123; sm.checkPermission(new RuntimePermission(\"shutdownHooks\")); &#125; // çœŸæ­£çš„æ³¨å†Œé€»è¾‘åœ¨è¿™ä¸ªç±»é‡Œé¢ ApplicationShutdownHooks.add(hook); &#125;&#125;class ApplicationShutdownHooks &#123; // é’©å­é›†åˆ private static IdentityHashMap&lt;Thread, Thread&gt; hooks; // æ³¨å†Œä¸€ä¸ªé’©å­ static synchronized void add(Thread hook) &#123; if(hooks == null) throw new IllegalStateException(\"Shutdown in progress\"); // çœ‹æ¥æ³¨å†Œå‰ä¸èƒ½è®©Threadè·‘èµ·æ¥ if (hook.isAlive()) throw new IllegalArgumentException(\"Hook already running\"); // åŒä¸€ä¸ªé’©å­ä¸èƒ½é‡å¤æ³¨å†Œ if (hooks.containsKey(hook)) throw new IllegalArgumentException(\"Hook previously registered\"); // æ”¾è¿›é›†åˆå°±ç®—æ³¨å†ŒæˆåŠŸäº†ï¼Ÿç»§ç»­å¾€ä¸‹çœ‹ hooks.put(hook, hook); &#125; // åˆå§‹åŒ–ï¼Œæœ¬æ¥åœ¨æœ€å‰é¢ï¼Œä¸ºäº†è·Ÿéšæˆ‘çš„èŠ‚å¥è¢«æˆ‘ç§»åˆ°åé¢äº† static &#123; try &#123; // çœ‹æ¥è¿™ä¸ªç±»ä¹Ÿä¸æ˜¯çœŸæ­£å®ç°é’©å­å›è°ƒçš„åœ°æ–¹ // åˆåœ¨Shutdownæ³¨å†Œäº†ä¸€ä¸ªâ€œé’©å­â€ï¼Œé€šè¿‡è¿™ä¸ªâ€œé’©å­â€æ¥æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„é’©å­ Shutdown.add(1 /* shutdown hook invocation order */, false /* not registered if shutdown in progress */, new Runnable() &#123; public void run() &#123; runHooks(); &#125; &#125; ); hooks = new IdentityHashMap&lt;&gt;(); &#125; catch (IllegalStateException e) &#123; // application shutdown hooks cannot be added if // shutdown is in progress. hooks = null; &#125; &#125; // æ‰§è¡Œç”¨æˆ·é’©å­çš„é’©å­å‡½æ•° static void runHooks() &#123; Collection&lt;Thread&gt; threads; synchronized(ApplicationShutdownHooks.class) &#123; threads = hooks.keySet(); hooks = null; &#125; for (Thread hook : threads) &#123; hook.start(); &#125; for (Thread hook : threads) &#123; while (true) &#123; try &#123; hook.join(); break; &#125; catch (InterruptedException ignored) &#123; &#125; &#125; &#125; &#125;&#125; ç®€å•è¿½è¸ªäº†ä¸€ä¸‹æ³¨å†Œé’©å­çš„æºç ï¼Œå‘ç°æ˜¯é€šè¿‡åœ¨Shutdownæ³¨å†Œä¸€ä¸ªé’©å­æ¥æ‰§è¡Œç”¨æˆ·çš„é’©å­ã€‚é‚£ä¹ˆShutdownåˆæ˜¯æ€ä¹ˆåœ¨å…³é—­æ—¶æ‰§è¡Œé’©å­çš„å‘¢ï¼Ÿ é’©å­å¦‚ä½•è¢«è°ƒç”¨123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145package java.lang;class Shutdown &#123; /* Shutdown state */ private static final int RUNNING = 0; private static final int HOOKS = 1; private static final int FINALIZERS = 2; private static int state = RUNNING; /* Should we run all finalizers upon exit? */ private static boolean runFinalizersOnExit = false; // The system shutdown hooks are registered with a predefined slot. // The list of shutdown hooks is as follows: // (0) Console restore hook // (1) Application hooks // (2) DeleteOnExit hook // é’©å­é›†åˆå®¹é‡ï¼Œæœ‰ç‚¹å°ï¼Œä½†æ˜¯çœ‹æ³¨é‡Šç›®å‰å°±3ä¸ªï¼Œå€’æ˜¯è¶³å¤Ÿäº†ï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰æ²¡åˆ—å‡ºæ¥çš„ private static final int MAX_SYSTEM_HOOKS = 10; // é’©å­é›†åˆ private static final Runnable[] hooks = new Runnable[MAX_SYSTEM_HOOKS]; // æ³¨å†Œä¸€ä¸ªé’©å­ static void add(int slot, boolean registerShutdownInProgress, Runnable hook) &#123; synchronized (lock) &#123; if (hooks[slot] != null) throw new InternalError(\"Shutdown hook at slot \" + slot + \" already registered\"); if (!registerShutdownInProgress) &#123; if (state &gt; RUNNING) throw new IllegalStateException(\"Shutdown in progress\"); &#125; else &#123; if (state &gt; HOOKS || (state == HOOKS &amp;&amp; slot &lt;= currentRunningHook)) throw new IllegalStateException(\"Shutdown in progress\"); &#125; // åˆšæ‰ApplicationShutdownHooksä¼ çš„æ˜¯ï¼š(1) Application hooks hooks[slot] = hook; &#125; &#125; // é™¤äº†addï¼Œè¿™æ˜¯å”¯ä¸€å¼•ç”¨hooksçš„åœ°æ–¹äº† // å¯ä»¥çœ‹å‡ºæ˜¯é¡ºåºæ‰§è¡Œ3ç§é’©å­ private static void runHooks() &#123; for (int i=0; i &lt; MAX_SYSTEM_HOOKS; i++) &#123; try &#123; Runnable hook; synchronized (lock) &#123; // acquire the lock to make sure the hook registered during // shutdown is visible here. currentRunningHook = i; hook = hooks[i]; &#125; if (hook != null) hook.run(); &#125; catch(Throwable t) &#123; if (t instanceof ThreadDeath) &#123; ThreadDeath td = (ThreadDeath)t; throw td; &#125; &#125; &#125; &#125; // æ‰§è¡Œé’©å­çš„åœ°æ–¹ private static void sequence() &#123; synchronized (lock) &#123; /* Guard against the possibility of a daemon thread invoking exit * after DestroyJavaVM initiates the shutdown sequence */ if (state != HOOKS) return; &#125; runHooks();//æ‰§è¡Œé’©å­ boolean rfoe; synchronized (lock) &#123; state = FINALIZERS; rfoe = runFinalizersOnExit; &#125; if (rfoe) runAllFinalizers(); &#125; // ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•æ˜¯æˆ‘ä»¬è§¦å‘åº”ç”¨å…³é—­çš„é€”å¾„ï¼Œå‡å¯æ‰§è¡Œé’©å­ /* Invoked by Runtime.exit, which does all the security checks. * Also invoked by handlers for system-provided termination events, * which should pass a nonzero status code. */ // å¼ºè¡Œç¿»è¯‘ï¼šé€šè¿‡Runtime.exitè°ƒç”¨ // è¿™æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨ç¨‹åºä¸­è°ƒç”¨åˆ°çš„ static void exit(int status) &#123; boolean runMoreFinalizers = false; synchronized (lock) &#123; if (status != 0) runFinalizersOnExit = false; switch (state) &#123; case RUNNING: /* Initiate shutdown */ state = HOOKS; break; case HOOKS: /* Stall and halt */ break; case FINALIZERS: if (status != 0) &#123; /* Halt immediately on nonzero status */ halt(status); &#125; else &#123; /* Compatibility with old behavior: * Run more finalizers and then halt */ runMoreFinalizers = runFinalizersOnExit; &#125; break; &#125; &#125; if (runMoreFinalizers) &#123; runAllFinalizers(); halt(status); &#125; synchronized (Shutdown.class) &#123; /* Synchronize on the class object, causing any other thread * that attempts to initiate shutdown to stall indefinitely */ sequence();//æ‰§è¡Œé’©å­ halt(status); &#125; &#125; /* Invoked by the JNI DestroyJavaVM procedure when the last non-daemon * thread has finished. Unlike the exit method, this method does not * actually halt the VM. */ // å¼ºè¡Œç¿»è¯‘ï¼šæœ€åä¸€ä¸ªéå®ˆæŠ¤çº¿ç¨‹ç»“æŸåé€šè¿‡æœ¬åœ°æ¥å£ï¼ˆJNIï¼‰è°ƒç”¨ã€‚å’Œexitæ–¹æ³•ä¸åŒï¼Œæ­¤æ–¹æ³•æ²¡æœ‰çœŸæ­£åœæ­¢è™šæ‹Ÿæœº // è¿™ä¸ªæ–¹æ³•æ²¡æœ‰æ‰¾åˆ°è°ƒç”¨çš„ä»£ç  static void shutdown() &#123; synchronized (lock) &#123; switch (state) &#123; case RUNNING: /* Initiate shutdown */ state = HOOKS; break; case HOOKS: /* Stall and then return */ case FINALIZERS: break; &#125; &#125; synchronized (Shutdown.class) &#123; sequence();// æ‰§è¡Œé’©å­ &#125; &#125; ç®€å•çš„çœ‹äº†ä¸‹æºç ï¼ŒçŸ¥é“äº†exitå’Œshutdownæ—¶éƒ½ä¼šé€šè¿‡æŸç§æµç¨‹å’Œè§„åˆ™å»æ‰§è¡Œåˆ°ç”¨æˆ·å®šä¹‰çš„é’©å­ã€‚","categories":[{"name":"JAVA","slug":"JAVA","permalink":"https://acupt.github.io/categories/JAVA/"}],"tags":[{"name":"jvm","slug":"jvm","permalink":"https://acupt.github.io/tags/jvm/"}],"keywords":[{"name":"JAVA","slug":"JAVA","permalink":"https://acupt.github.io/categories/JAVA/"}]},{"title":"JAVAæ³›å‹ä¸ç±»å‹æ“¦é™¤","slug":"java-generics-type-erasure","date":"2019-07-28T14:30:00.000Z","updated":"2019-07-28T16:00:10.665Z","comments":true,"path":"2019/07/28/java-generics-type-erasure/","link":"","permalink":"https://acupt.github.io/2019/07/28/java-generics-type-erasure/","excerpt":"","text":"æ³›å‹çš„æœ¬è´¨æ˜¯å‚æ•°åŒ–ç±»å‹ï¼Œè¿™ç§å‚æ•°ç±»å‹å¯ä»¥ç”¨åœ¨ç±»ã€æ¥å£å’Œæ–¹æ³•çš„åˆ›å»ºä¸­ã€‚æ³›å‹æ˜¯åœ¨JAVA 1.5ç‰ˆæœ¬ä¸­æ‰å¼•å…¥çš„ï¼Œå®ƒèƒ½å’Œä»¥å‰çš„ç‰ˆæœ¬å…¼å®¹çš„åŸå› æ˜¯æ³›å‹ä¿¡æ¯åªå­˜åœ¨äºä»£ç ç¼–è¯‘é˜¶æ®µï¼Œåœ¨è¿›å…¥ JVM ä¹‹å‰ï¼Œä¸æ³›å‹ç›¸å…³çš„ä¿¡æ¯ä¼šè¢«æ“¦é™¤æ‰ï¼Œå³ç±»å‹æ“¦é™¤ã€‚ æ³›å‹çš„å®šä¹‰ä¸ä½¿ç”¨æ ¹æ®ä½¿ç”¨æƒ…å†µå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š æ³›å‹ç±» æ³›å‹æ–¹æ³• æ³›å‹æ¥å£ ä¸‹é¢æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„æ³›å‹ç±»ï¼š 1234567891011121314151617181920212223242526// ä¸€ä¸ªæ³›å‹ç±»ï¼Œå¯ä»¥æ ¹æ®éœ€è¦åŒ…è£…ä¸åŒç»“æœçš„è¿”å›å€¼public class Result&lt;T&gt; &#123; private boolean success; private String message; private T data; // ä¸€ä¸ªæ³›å‹æ–¹æ³• // è¿”å›å€¼ç±»å‹å®šä¹‰å‰çš„&lt;T&gt;æ˜¯å¿…é¡»çš„ï¼Œç”¨æ¥å£°æ˜ä¸€ä¸ªç±»å‹æŒæœ‰è€…åç§°ï¼Œç„¶åå°±å¯ä»¥æŠŠTå½“ä½œä¸€ä¸ªç±»å‹ä»£è¡¨æ¥å£°æ˜æˆå‘˜ã€å‚æ•°å’Œè¿”å›å€¼ç±»å‹ã€‚ public static &lt;T&gt; Result&lt;T&gt; success(T data) &#123; Result&lt;T&gt; r = new Result&lt;&gt;(); r.success = true; r.data = data; return r; &#125; public static &lt;T&gt; Result&lt;T&gt; error(String message) &#123; Result&lt;T&gt; r = new Result&lt;&gt;(); r.message = message; return r; &#125; // getter &amp; setter&#125; ç±»å‹å‚æ•°ä¸Šé¢å°–æ‹¬å·ä¸­çš„Tå³ç±»å‹å‚æ•°ï¼Œä»£æŒ‡ä»»ä½•ç±»ï¼Œä½¿ç”¨æ—¶å¯ä»¥æ›¿æ¢æˆä»»æ„ç±»ï¼Œå¦‚ï¼š 12345678public class Main &#123; public static void main(String[] args) &#123; Result&lt;Date&gt; r1 = Result.success(new Date()); Result&lt;List&lt;String&gt;&gt; r2 = Result.success(Arrays.asList(\"s1\", \"s2\")); &#125;&#125; ä¸ºä»€ä¹ˆè¦ç”¨Tè€Œä¸æ˜¯å…¶å®ƒå­—æ¯ï¼Ÿäº‹å®ä¸Šæ˜¯å¯ä»¥ä»»æ„å­—ç¬¦ä¸²ï¼ˆå¦‚Result&lt; something &gt;ï¼‰ï¼Œä½†æ˜¯ä¸ºäº†æ˜¾å¾—ä¸“ä¸šï¼Œä¸€èˆ¬çº¦å®šå‡ ä¸ªå¤§å†™å­—æ¯åœ¨ä¸åŒåœºæ™¯ä½¿ç”¨ã€‚ T æœ€å¸¸ç”¨ï¼Œä¸€èˆ¬ä»£æŒ‡ä»»æ„ç±»ï¼Œä¸çŸ¥é“ç”¨å•¥å°±ç”¨å®ƒ E ä»£è¡¨Elementï¼Œä¸€èˆ¬ç”¨åœ¨é›†åˆçš„æ³›å‹åœºæ™¯ K ä»£è¡¨Keyï¼Œä¸€èˆ¬å’ŒValueä¸€èµ·å‡ºç°åœ¨é”®å€¼å¯¹åœºæ™¯ï¼ˆå¦‚Entry&lt;K,V&gt;ï¼‰ V ä»£è¡¨Valueï¼Œä¸€èˆ¬å’ŒKeyä¸€èµ·å‡ºç°åœ¨é”®å€¼å¯¹åœºæ™¯ï¼ˆå¦‚Entry&lt;K,V&gt;ï¼‰ è¿˜æœ‰äº›ä¸å¤ªå¸¸è§çš„å¦‚Sï¼ŒUâ€¦ æ³›å‹é€šé…ç¬¦å¦‚æœåœ¨æŸäº›åœºæ™¯ä¸‹æˆ‘ä»¬ä¸å…³æ³¨ï¼ˆæˆ–è€…ä¸é‚£ä¹ˆå…³æ³¨ï¼‰æ³›å‹å¯¹è±¡çš„ç±»å‹å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨æ³›å‹é€šé…ç¬¦ã€‚ &lt;?&gt; æ— é™åˆ¶çš„é€šé…ç¬¦ï¼Œè¡¨ç¤ºæ“ä½œå’Œç±»å‹æ— å…³ &lt;? extends T&gt; ç±»å‹å‚æ•°å¿…é¡»æ˜¯Tæˆ–è€…Tçš„å­ç±» &lt;? super T&gt; ç±»å‹å‚æ•°å¿…é¡»æ˜¯Tæˆ–è€…Tçš„çˆ¶ç±» 123456789101112131415161718import java.util.Date;public class Main &#123; public static void main(String[] args) &#123; // ç”±äºè¿™é‡Œåªéœ€è¦çŸ¥é“æ–¹æ³•æ˜¯å¦æˆåŠŸï¼Œä¸éœ€è¦å¤„ç†è¿”å›çš„å¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨é€šé…ç¬¦ï¼Œè¿™æ ·å°±ç®—ä»¥åè¿”å›å€¼æ”¹äº†è¿™é‡Œä¹Ÿä¸ç”¨æ”¹ Result&lt;?&gt; r1 = checkDate(); System.out.println(r1.isSuccess() ? \"æˆåŠŸ\" : \"å¤±è´¥\"); &#125; private static Result&lt;Date&gt; checkDate() &#123; if (Math.random() &gt; 0.5) &#123; return Result.success(new Date()); &#125; return Result.error(\"system error\"); &#125;&#125; ç±»å‹æ“¦é™¤ åœ¨Java SE 1.5ä¹‹å‰ï¼Œæ²¡æœ‰æ³›å‹çš„æƒ…å†µçš„ä¸‹ï¼Œé€šè¿‡å¯¹ç±»å‹Objectçš„å¼•ç”¨æ¥å®ç°å‚æ•°çš„â€œä»»æ„åŒ–â€ï¼Œâ€œä»»æ„åŒ–â€å¸¦æ¥çš„ç¼ºç‚¹æ˜¯è¦åšæ˜¾å¼çš„å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œè€Œè¿™ç§è½¬æ¢æ˜¯è¦æ±‚å¼€å‘è€…å¯¹å®é™…å‚æ•°ç±»å‹å¯ä»¥é¢„çŸ¥çš„æƒ…å†µä¸‹è¿›è¡Œçš„ã€‚å¯¹äºå¼ºåˆ¶ç±»å‹è½¬æ¢é”™è¯¯çš„æƒ…å†µï¼Œç¼–è¯‘å™¨å¯èƒ½ä¸æç¤ºé”™è¯¯ï¼Œåœ¨è¿è¡Œçš„æ—¶å€™æ‰å‡ºç°å¼‚å¸¸ï¼Œè¿™æ˜¯ä¸€ä¸ªå®‰å…¨éšæ‚£ã€‚æ³›å‹çš„å¥½å¤„æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™æ£€æŸ¥ç±»å‹å®‰å…¨ï¼Œå¹¶ä¸”æ‰€æœ‰çš„å¼ºåˆ¶è½¬æ¢éƒ½æ˜¯è‡ªåŠ¨å’Œéšå¼çš„ï¼Œä»¥æé«˜ä»£ç çš„é‡ç”¨ç‡ã€‚ 12345678910111213141516171819202122232425import java.lang.reflect.Field;import java.util.Date;public class Main &#123; public static void main(String[] args) throws NoSuchFieldException &#123; Result&lt;Date&gt; r1 = Result.success(new Date()); Result&lt;Number&gt; r2 = Result.success(2.333); dataType(r1); dataType(r2); &#125; private static void dataType(Result&lt;?&gt; result) throws NoSuchFieldException &#123; Field field = result.getClass().getDeclaredField(\"data\"); System.out.println(field.getType().toString()); &#125;&#125;/* è¾“å‡º:class java.lang.Objectclass java.lang.Object*/ é€šè¿‡åå°„æˆ‘ä»¬åœ¨è¿è¡Œæ—¶å¾—åˆ°äº†dataçš„ç±»å‹ï¼Œå‘ç°éƒ½æ˜¯Objectï¼Œè¯æ˜ä»£ç ç¼–è¯‘åæ‰€è°“æ³›å‹éƒ½æ²¡äº†ï¼Œè¿™å°±æ˜¯æ³›å‹æ“¦é™¤ã€‚ ä½†å¹¶ä¸æ˜¯ä»»ä½•æ—¶å€™éƒ½æ˜¯Obejctï¼Œå¦‚æœç”¨äº†å¸¦é™åˆ¶çš„æ³›å‹åˆå°†ä¸ä¸€æ ·ï¼Œå¤§æ¦‚è¿™ä¹ˆä¸ªæ„æ€ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546public class Result&lt;T extends Number&gt; &#123; private boolean success; private String message; private T data; public static &lt;T extends Number&gt; Result&lt;T&gt; success(T data) &#123; Result&lt;T&gt; r = new Result&lt;&gt;(); r.success = true; r.data = data; return r; &#125; public static &lt;T extends Number&gt; Result&lt;T&gt; error(String message) &#123; Result&lt;T&gt; r = new Result&lt;&gt;(); r.message = message; return r; &#125; // getter &amp; setter&#125;public class Main &#123; public static void main(String[] args) throws NoSuchFieldException &#123; Result&lt;Double&gt; r1 = Result.success(2.333); Result&lt;Long&gt; r2 = Result.success(Long.MAX_VALUE); dataType(r1); dataType(r2); &#125; private static void dataType(Result&lt;?&gt; result) throws NoSuchFieldException &#123; Field field = result.getClass().getDeclaredField(\"data\"); System.out.println(field.getType().toString()); &#125;&#125;/* è¾“å‡º:class java.lang.Numberclass java.lang.Number*/ é€šè¿‡åå°„ç»•è¿‡æ³›å‹é™åˆ¶ä»ä¸Šé¢ä¾‹å­å¯ä»¥æ„Ÿå—åˆ°ï¼Œæ‰€è°“æ³›å‹ï¼Œä¸è¿‡æ˜¯ç¼–è¯‘è¿‡ç¨‹åŠå…¶ä¹‹å‰æ‰æœ‰çš„æ¦‚å¿µï¼Œä¸»è¦è¿˜æ˜¯ä¸ºäº†æ–¹ä¾¿å¼€å‘ã€‚ æœ€åæä¸ªéªšæ“ä½œï¼Œé€šè¿‡åå°„ç»•è¿‡æ³›å‹é™åˆ¶ã€‚ 12345678910111213141516171819202122232425262728293031import java.lang.reflect.Method;import java.util.ArrayList;import java.util.Date;public class Main &#123; public static void main(String[] args) throws Exception &#123; ArrayList&lt;Integer&gt; list = new ArrayList&lt;Integer&gt;(); //æ­£è§„é€”å¾„ list.add(1); //åå°„å¤§æ³• Method m = list.getClass().getMethod(\"add\", Object.class); m.invoke(list, 2); m.invoke(list, 3.21); m.invoke(list, \"å¯¹ä¸èµ·ï¼Œæˆ‘æ˜¯å­—ç¬¦ä¸²\"); m.invoke(list, new Date()); for (Integer x : list) &#123; System.out.println(x.getClass().getName() + \":\\t\" + x); &#125; &#125;&#125;/* è¾“å‡º:java.lang.Integer: 1java.lang.Integer: 2Exception in thread \"main\" java.lang.ClassCastException: java.lang.Double cannot be cast to java.lang.Integer at Main.main(Main.java:20)*/ ç«Ÿç„¶æŠ¥é”™äº†ï¼ˆå½“ç„¶æ˜¯æ•…æ„çš„ï¼ŒçœŸçš„ï¼‰ï¼Œçœ‹çœ‹é”™è¯¯ä¿¡æ¯ï¼Œå› ä¸ºè¦æŠŠDoubleè½¬ä¸ºIntegerå¯¼è‡´å¼‚å¸¸ã€‚ä½†æˆ‘ä»¬å‘ç°å‰é¢çš„ä¸¤ä¸ªè¾“å‡ºæ˜¯æˆåŠŸçš„ï¼Œè¯æ˜ç¨‹åºèƒ½ç¼–è¯‘æˆåŠŸå¹¶è¿è¡Œã€‚ ç•¥ä½œè°ƒæ•´ï¼š 1234567891011121314151617181920212223242526272829303132import java.lang.reflect.Method;import java.util.ArrayList;import java.util.Date;public class Main &#123; public static void main(String[] args) throws Exception &#123; ArrayList&lt;Integer&gt; list = new ArrayList&lt;Integer&gt;(); //æ­£è§„é€”å¾„ list.add(1); //åå°„å¤§æ³• Method m = list.getClass().getMethod(\"add\", Object.class); m.invoke(list, 2); m.invoke(list, 3.21); m.invoke(list, \"å¯¹ä¸èµ·ï¼Œæˆ‘æ˜¯å­—ç¬¦ä¸²\"); m.invoke(list, new Date()); for (Object x : list) &#123; System.out.println(x.getClass().getName() + \":\\t\" + x); &#125; &#125;&#125;/* è¾“å‡º:java.lang.Integer: 1java.lang.Integer: 2java.lang.Double: 3.21java.lang.String: å¯¹ä¸èµ·ï¼Œæˆ‘æ˜¯å­—ç¬¦ä¸²java.util.Date: Sun Jul 28 23:49:34 CST 2019*/ æ€»ç»“","categories":[{"name":"JAVA","slug":"JAVA","permalink":"https://acupt.github.io/categories/JAVA/"}],"tags":[{"name":"æ³›å‹","slug":"æ³›å‹","permalink":"https://acupt.github.io/tags/æ³›å‹/"},{"name":"ç±»å‹æ“¦é™¤","slug":"ç±»å‹æ“¦é™¤","permalink":"https://acupt.github.io/tags/ç±»å‹æ“¦é™¤/"}],"keywords":[{"name":"JAVA","slug":"JAVA","permalink":"https://acupt.github.io/categories/JAVA/"}]},{"title":"æ¢ç´¢JAVAå¹¶å‘ - å¦‚ä½•å¤„ç†çº¿ç¨‹ä¸­æ–­","slug":"concurrent-interrupt","date":"2019-07-25T14:40:00.000Z","updated":"2019-07-25T16:00:22.032Z","comments":true,"path":"2019/07/25/concurrent-interrupt/","link":"","permalink":"https://acupt.github.io/2019/07/25/concurrent-interrupt/","excerpt":"","text":"ä¸­æ–­æ˜¯ä¸€ç§åä½œæœºåˆ¶ï¼Œé€šè¿‡è¿™ç§æœºåˆ¶å¯ä»¥è¦æ±‚æŒ‡å®šçº¿ç¨‹åœ¨å¯ä»¥æš‚åœçš„åœ°æ–¹åœæ­¢å½“å‰ä»»åŠ¡ï¼Œä½†è¿™ä¸ªè¦æ±‚å¯ä»¥æ— è§†ï¼Œæˆ‘ä»¬ä¹Ÿç»å¸¸è¿™ä¹ˆåšï¼ˆè™½ç„¶ä¸å¥½ï¼‰ï¼Œé‚£åº”è¯¥è¿™ä¹ˆå¯¹å¾…å…¶å®ƒçº¿ç¨‹å‘æ¥çš„ä¸­æ–­è¦æ±‚å‘¢ï¼Ÿ åœ¨ä¸Šä¸€ç¯‡å¦‚ä½•ä¼˜é›…åœ°å–æ¶ˆçº¿ç¨‹ä»»åŠ¡ä¸­æåˆ°äº†é€šè¿‡ä¸­æ–­å¯ä»¥å–æ¶ˆçº¿ç¨‹æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡ï¼Œç°åœ¨é’ˆå¯¹ä¸­æ–­è¿™ä»¶äº‹æƒ…å†æ¥ç®€å•èŠèŠã€‚ é˜»å¡åº“å¦‚ä½•æŠ›å‡ºä¸­æ–­JAVAä¸­æœ‰å¾ˆå¤šå¸¦é˜»å¡æ–¹æ³•çš„å·¥å…·ç±»ï¼Œè¿™ç§æ–¹æ³•å¾€å¾€ä¼šå£°æ˜ä¸€ä¸ªå—æ£€æŸ¥çš„å¼‚å¸¸InterruptedExceptionï¼Œå¦‚æœè¢«ä¸­æ–­ï¼Œå®ƒä¼šå°è¯•æå‰ç»“æŸé˜»å¡çŠ¶æ€ï¼Œå¹¶æŠ›ç»™è°ƒç”¨è€…ä¸€ä¸ªInterruptedExceptionå¼‚å¸¸ï¼Œè®©å¯¹æ–¹å†³å®šä½•å»ä½•ä»ã€‚ ç”¨ArrayBlockingQueue.offer(E, long, TimeUnit)ä¸ºä¾‹ã€‚ 1234567891011121314151617181920212223242526public class ArrayBlockingQueue&lt;E&gt; extends AbstractQueue&lt;E&gt; implements BlockingQueue&lt;E&gt;, java.io.Serializable &#123; public boolean offer(E e, long timeout, TimeUnit unit) throws InterruptedException &#123; checkNotNull(e); long nanos = unit.toNanos(timeout); final ReentrantLock lock = this.lock; // è¿™é‡Œå¯èƒ½æŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼š // è·å–é”æ—¶å¦‚æœçº¿ç¨‹å·²ä¸­æ–­ or ç­‰å¾…é”æ—¶çº¿ç¨‹è¢«ä¸­æ–­ lock.lockInterruptibly(); try &#123; while (count == items.length) &#123; if (nanos &lt;= 0) return false; // è¿™é‡Œå¯èƒ½æŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼šå¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ nanos = notFull.awaitNanos(nanos); &#125; enqueue(e); return true; &#125; finally &#123; lock.unlock(); &#125; &#125;&#125; ä¼ é€’ä¸­æ–­å¦‚æœæ•è·åˆ°ä¸€ä¸ªä¸­æ–­å¼‚å¸¸ä¸çŸ¥é“æ€ä¹ˆå¤„ç†å®ƒï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘æŠŠè¿™ä¸ªçƒ«æ‰‹å±±èŠ‹æ‰”å‡ºå»ï¼Œæ‰”ç»™ä½ çš„ä¸Šçº§ï¼ˆè°ƒç”¨è€…ï¼‰ï¼Œå³ä¼ é€’ä¸­æ–­ã€‚ ä¼ é€’æ–¹å¼1: ä¸æ•è·ä¸­æ–­å¼‚å¸¸åªè¦åœ¨æ–¹æ³•ä¸Šæ·»åŠ ä¸€ä¸ªInterruptedExceptionçš„å£°æ˜ï¼Œå°±èƒ½è½»æ¾æŠŠè¿™ä¸ªé”…ç”©ç»™è°ƒç”¨è€…ï¼Œå› ä¸ºæ­¤æ—¶ä½ ä¹Ÿæˆä¸ºäº†å¯ä¸­æ–­å¤§å†›çš„ä¸€å‘˜ã€‚æ—¢ç„¶è§£å†³ä¸äº†ï¼Œé‚£å°±åŠ å…¥ã€‚ 12345678910import java.util.concurrent.ArrayBlockingQueue;import java.util.concurrent.TimeUnit;public class Main &#123; public static void main(String[] args) throws InterruptedException &#123; ArrayBlockingQueue&lt;Object&gt; queue = new ArrayBlockingQueue&lt;&gt;(100); queue.offer(new Object(), 1L, TimeUnit.MINUTES); &#125;&#125; ä¼ é€’æ–¹å¼2: æ•è·å†æŠ›å‡ºå¦‚æœå¸Œæœ›å‘ç”Ÿä¸­æ–­æ—¶è‡ªå·±å¯ä»¥åšç‚¹æ‰«å°¾æ“ä½œï¼Œé‚£ä¹ˆå¯ä»¥æ•è·ä¸­æ–­å¼‚å¸¸ï¼Œåšç‚¹å°åŠ¨ä½œåå†æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ï¼ˆä½ ä¹Ÿå¯ä»¥æŠ›å‡ºå…¶å®ƒè‡ªå®šä¹‰å¼‚å¸¸ï¼‰ã€‚ 123456789101112131415import java.util.concurrent.ArrayBlockingQueue;import java.util.concurrent.TimeUnit;public class Main &#123; public static void main(String[] args) throws InterruptedException &#123; ArrayBlockingQueue&lt;Object&gt; queue = new ArrayBlockingQueue&lt;&gt;(100); try &#123; queue.offer(new Object(), 1L, TimeUnit.MINUTES); &#125; catch (InterruptedException e) &#123; System.out.println(\"æœ‰äººæƒ³ä¸­æ–­æˆ‘ï¼Œæˆ‘ä»äº†\"); throw e; &#125; &#125;&#125; æ¢å¤ä¸­æ–­å½“æˆ‘ä»¬æ•è·åˆ°ä¸­æ–­å¼‚å¸¸çš„æ—¶å€™ï¼Œå¦‚æœå†å»è°ƒç”¨Thread.isInterrupted()å¾€å¾€å¾—åˆ°çš„æ˜¯falseï¼Œå› ä¸ºè¿™ä»¶äº‹åªæœ‰ä¸€ä¸ªäººæ¥å¤„ç†å°±å¤Ÿäº†ï¼Œæ‰€ä»¥æŠ›å‡ºå¼‚å¸¸åä¼šæ¸…é™¤ä¸­æ–­çŠ¶æ€ï¼Œæ¯”å¦‚Thread,sleep()ã€‚ 123456789public class Thread implements Runnable &#123; /** * å¼ºè¡Œç¿»è¯‘: ç®—äº†ä¸ç¿»è¯‘äº†ï¼Œä¸Šç¯‡å†™è¿‡ * @throws InterruptedException * if any thread has interrupted the current thread. The * &lt;i&gt;interrupted status&lt;/i&gt; of the current thread is * cleared when this exception is thrown. */ public static native void sleep(long millis) throws InterruptedException; å› æ­¤ï¼Œçº¿ç¨‹ä¸æ–¹ä¾¿æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™ï¼ˆæ¯”å¦‚åœ¨å®ç°Runnableï¼Œæˆ‘ä»¬çŸ¥é“run()æ–¹æ³•æ²¡æœ‰å£°æ˜å¼‚å¸¸ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥æ•è·åˆ°ä¸­æ–­å¼‚å¸¸åå†æ¬¡æŠŠçº¿ç¨‹çŠ¶æ€ç½®ä¸ºä¸­æ–­ã€‚è¿™ä»¶äº‹æˆ‘ç®¡ä¸äº†ï¼Œ è°çˆ±ç®¡è°ç®¡ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243public class Main &#123; public static void main(String[] args) throws InterruptedException &#123; Thread thread = new Thread() &#123; @Override public void run() &#123; while (true) &#123; try &#123; System.out.println(\"å¯æœ‰äººæƒ³ä¸­æ–­æˆ‘ï¼Ÿ\" + isInterrupted()); sleep(1000); &#125; catch (InterruptedException e) &#123; System.out.println(\"æœ‰äººæƒ³ä¸­æ–­æˆ‘ï¼Œæˆ‘æ‹’ç»\"); System.out.println(isInterrupted()); interrupt(); &#125; &#125; &#125; &#125;; thread.start(); Thread.sleep(3000); thread.interrupt(); &#125;&#125;/* è¾“å‡ºå¯æœ‰äººæƒ³ä¸­æ–­æˆ‘ï¼Ÿfalseå¯æœ‰äººæƒ³ä¸­æ–­æˆ‘ï¼Ÿfalseå¯æœ‰äººæƒ³ä¸­æ–­æˆ‘ï¼Ÿfalse // è™½ç„¶ä¸‹ä¸€æ­¥å°±æ•è·åˆ°ä¸­æ–­ï¼Œä½†è¿™é‡Œä¾ç„¶æ˜¯falseï¼Œè¯æ˜æ˜¯åœ¨sleepæ—¶æ‰è¢«ä¸­æ–­çš„æœ‰äººæƒ³ä¸­æ–­æˆ‘ï¼Œæˆ‘æ‹’ç»false // æ•è·åˆ°å¼‚å¸¸åï¼Œå½“å‰çº¿ç¨‹çŠ¶æ€æ˜¯â€œéä¸­æ–­â€ï¼Œä½†è¢«æˆ‘è®¾ä¸ºä¸­æ–­äº†å¯æœ‰äººæƒ³ä¸­æ–­æˆ‘ï¼Ÿtrue // å› ä¸ºå·²ç»è¢«æˆ‘è®¾ä¸ºä¸­æ–­äº†æœ‰äººæƒ³ä¸­æ–­æˆ‘ï¼Œæˆ‘æ‹’ç» // é‚£äººå°±æ˜¯ä½ è‡ªå·±å•Šfalse // æ— é™æ¨¡å¼å¯åŠ¨å¯æœ‰äººæƒ³ä¸­æ–­æˆ‘ï¼Ÿtrueæœ‰äººæƒ³ä¸­æ–­æˆ‘ï¼Œæˆ‘æ‹’ç»false(ç•¥...)*/ æ€»ç»“ çº¿ç¨‹å¤„äºä¸­æ–­çŠ¶æ€è¡¨æ˜æœ‰äººæƒ³è®©å®ƒèµ¶ç´§ç»“æŸï¼Œä½†å¾—åˆ°è¿™ä¸ªä¿¡å·çš„çº¿ç¨‹å¯ä»¥åšå‡ºè‡ªå·±çš„é€‰æ‹©ï¼› ä¸è¦æ•è·åˆ°å®ƒå´å†·æ¼ çš„ä¸åšä»»ä½•å“åº”ï¼ˆå¯ä»¥ä¸çˆ±ï¼Œè«è¦ä¼¤å®³ï¼‰ã€‚","categories":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://acupt.github.io/categories/å¹¶å‘ç¼–ç¨‹/"}],"tags":[{"name":"çº¿ç¨‹","slug":"çº¿ç¨‹","permalink":"https://acupt.github.io/tags/çº¿ç¨‹/"}],"keywords":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://acupt.github.io/categories/å¹¶å‘ç¼–ç¨‹/"}]},{"title":"æ¢ç´¢JAVAå¹¶å‘ - å¦‚ä½•ä¼˜é›…åœ°å–æ¶ˆçº¿ç¨‹ä»»åŠ¡","slug":"concurrent-thread-cancel","date":"2019-07-24T14:00:00.000Z","updated":"2019-07-24T16:06:01.840Z","comments":true,"path":"2019/07/24/concurrent-thread-cancel/","link":"","permalink":"https://acupt.github.io/2019/07/24/concurrent-thread-cancel/","excerpt":"","text":"é€šè¿‡çº¿ç¨‹å¯åŠ¨ä¸€ä¸ªå¼‚æ­¥çš„ä»»åŠ¡å¾ˆå®¹æ˜“ï¼Œä½†æƒ³è®©å®ƒæå‰å®‰å…¨ä¸”å¿«é€Ÿåœ°ç»“æŸç¡®å¹¶ä¸ç®€å•ã€‚å¦‚æœçº¿ç¨‹å¤–éƒ¨çš„ä»£ç å¯ä»¥æå‰æŠŠç›®æ ‡çº¿ç¨‹ç½®ä¸ºâ€œå®Œæˆâ€çŠ¶æ€ï¼Œé‚£ä¹ˆè¿™ä¸ªç›®æ ‡çº¿ç¨‹å°±æ˜¯å¯å–æ¶ˆçš„ã€‚ çº¿ç¨‹ä»»åŠ¡å–æ¶ˆçš„åŸå› ä¸€èˆ¬æœ‰å¦‚ä¸‹å‡ ç§ï¼š ç”¨æˆ·è¯·æ±‚å–æ¶ˆ: æ¯”å¦‚ç”¨æˆ·å‘èµ·ä¸€ä¸ªè€—æ—¶æ“ä½œåï¼Œä¸æƒ³ç­‰äº†ï¼Œå°±ç‚¹å‡»äº†å–æ¶ˆæŒ‰é’®ï¼Œæ­¤æ—¶æˆ‘ä»¬åº”è¯¥æŠŠè¿˜åœ¨æ‰§è¡Œçš„ä»»åŠ¡å«åœï¼› æ—¶é—´é™åˆ¶: æŸäº›æµç¨‹å¯èƒ½å¾ˆè´¹æ—¶ï¼Œæˆ‘ä»¬è¦æ§åˆ¶ç­‰å¾…æ—¶é—´ï¼Œå½“è¶…æ—¶åéœ€è¦å–æ¶ˆæ‰ä»»åŠ¡ï¼› ç¨‹åºäº‹ä»¶: æŸäº›çº¿ç¨‹ä¹‹é—´å¯èƒ½æ­£åœ¨é…åˆå®ŒæˆæŸé¡¹å·¥ä½œï¼Œå…¶ä¸­ä¸€ä¸ªè¾¾åˆ°ç›®æ ‡åå‘Šè¯‰å…¶å®ƒåŒäº‹å¯ä»¥æå‰ä¸‹ç­äº†ï¼› ç³»ç»Ÿå¼‚å¸¸: å¦‚æœç”±äºä¾èµ–çš„æœåŠ¡æˆ–èµ„æºå‘ç”Ÿå¼‚å¸¸ï¼Œå¯¼è‡´å·¥ä½œå¹²ä¸ä¸‹å»äº†ï¼Œé‚£ä¹ˆå¯ä»¥æå‰å–æ¶ˆï¼› ç¨‹åºå…³é—­: æ¯”å¦‚ç³»ç»Ÿè¦é‡å¯ï¼Œé‚£ä¹ˆè¿˜åœ¨è¿›è¡Œçš„ä»»åŠ¡åº”è¯¥å–æ¶ˆã€‚ å–æ¶ˆæ ‡å¿—ä¸€ç§å¸¸ç”¨çš„æ–¹æ³•æ˜¯åœ¨ä»»åŠ¡ä»£ç ä¸­åŠ å…¥ä¸€ä¸ªâ€œæ˜¯å¦å–æ¶ˆâ€çš„æ ‡å¿—ï¼Œä»»åŠ¡å®šæœŸå»æŸ¥çœ‹è¿™ä¸ªæ ‡å¿—æ˜¯å¦æ”¹å˜ï¼Œå¦‚æœè¢«æ”¹å˜äº†å°±å–æ¶ˆå‰©ä¸‹çš„ä»»åŠ¡ï¼Œæ­¤æ—¶å¦‚æœæƒ³å–æ¶ˆè¿™ä¸ªä»»åŠ¡åªéœ€è¦ä¿®æ”¹å®ƒçš„æ ‡å¿—ï¼Œç„¶åå®‰é™åœ°ç­‰å¾…å…¶é€€å‡ºå³å¯ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445public class Main &#123; public static void main(String[] args) throws InterruptedException &#123; Worker worker = new Worker(); worker.start(); Thread.sleep(3000); worker.cancel(); &#125; public static class Worker extends Thread &#123; private volatile boolean cancelled; @Override public void run() &#123; while (!cancelled) &#123; System.out.println(\"æ¬ç –äº”åˆ†é’Ÿï¼Œåˆ’æ°´ä¸¤å°æ—¶\"); try &#123; sleep(1000); &#125; catch (InterruptedException e) &#123; // æ³¨æ„è¿™é‡Œï¼Œåé¢ä¼šæåˆ° e.printStackTrace(); &#125; &#125; System.out.println(\"æºœäº†æºœäº†\"); &#125; /** * å–æ¶ˆä»»åŠ¡ */ public void cancel() &#123; cancelled = true; &#125; &#125;&#125;/* è¾“å‡º:æ¬ç –äº”åˆ†é’Ÿï¼Œåˆ’æ°´ä¸¤å°æ—¶æ¬ç –äº”åˆ†é’Ÿï¼Œåˆ’æ°´ä¸¤å°æ—¶æ¬ç –äº”åˆ†é’Ÿï¼Œåˆ’æ°´ä¸¤å°æ—¶æºœäº†æºœäº†*/ è¿™ç§æ–¹å¼æœ€ä¸ºç®€å•ï¼Œè€Œä¸”éå¸¸å®‰å…¨ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥è‡ªå·±åœ¨ä»£ç ä¸­æ§åˆ¶ä»€ä¹ˆæ—¶å€™å¯ä»¥å–æ¶ˆï¼ˆå¦‚ç¤ºä¾‹ä¸­æ¯æ¬¡æ‰§è¡Œä¸€ä¸ªå¾ªç¯éƒ½å¯ä»¥å–æ¶ˆï¼‰ã€‚ ç¼ºç‚¹ï¼šè°ƒç”¨å–æ¶ˆçš„æ–¹æ³•åçº¿ç¨‹å¹¶ä¸èƒ½ä¿è¯å¾ˆå¿«å°±é€€å‡ºï¼Œè¿™å–å†³äºä¸€ä¸ªå¾ªç¯çš„æ‰§è¡Œé€Ÿåº¦ï¼Œæ›´å¯æ€•çš„æ˜¯ï¼Œå¦‚æœé‡Œé¢æœ‰ä¸ªé˜»å¡æ“ä½œï¼Œå®ƒå¯èƒ½æ°¸è¿œæ— æ³•é€€å‡ºã€‚ è§£å†³ï¼šå¯¹äºé˜»å¡æ“ä½œè®¾ç½®è¶…æ—¶ç­‰å¾…ï¼Œé˜²æ­¢æ°¸è¿œé˜»å¡ã€‚ ä¸­æ–­çº¿ç¨‹ä¸­æ–­æ˜¯ä¸€ç§åä½œæœºåˆ¶ï¼Œé€šè¿‡è¿™ä¸ªæœºåˆ¶é€šçŸ¥æŸä¸ªçº¿ç¨‹ï¼Œè®©å®ƒå¯ä»¥åœ¨åˆé€‚çš„æˆ–å¯èƒ½çš„æƒ…å†µä¸‹åœæ­¢ä»»åŠ¡ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯åˆé€‚/å¯èƒ½çš„æƒ…å†µå‘¢ï¼Ÿ çº¿ç¨‹æœ‰ä¸ªâ€œinterruptedâ€ï¼ˆè¢«æ‰“æ–­/ä¸­æ–­ï¼‰çš„çŠ¶æ€ï¼Œé€šè¿‡Threadçš„ä»¥ä¸‹æ–¹æ³•å¯ä»¥æŸ¥çœ‹/ä¿®æ”¹è¿™ä¸ªçŠ¶æ€ 12345678910111213141516171819202122232425public class Thread implements Runnable &#123; // ä¸­æ–­ç›®æ ‡çº¿ç¨‹ public void interrupt() &#123; //... &#125; // è¿”å›æ˜¯å¦ä¸­æ–­ public boolean isInterrupted() &#123; return isInterrupted(false); &#125; // æ¸…é™¤ä¸­æ–­çŠ¶æ€ï¼Œå¹¶è¿”å›åœ¨æ­¤ä¹‹å‰æ˜¯å¦ä¸­æ–­ // å¦‚æœè¿”å›trueï¼Œè¯æ˜æœ‰äººæƒ³ä¸­æ–­è¿™ä¸ªçº¿ç¨‹ï¼Œä½ éœ€è¦æ­£å¼è¿™ä¸ªé—®é¢˜: // 1.æ— è§†è¿™ä¸ªäººçš„è¯·æ±‚ // 2.å¸®ä»–ç»§ç»­è¿™ä¸ªè¯·æ±‚(å†æ¬¡è°ƒç”¨interruptæ¢å¤ä¸ºä¸­æ–­çŠ¶æ€) // 3.å…¶å®ƒå¤„ç†æ–¹å¼ // PS: æ³¨æ„è¿™æ˜¯ä¸ªstaticæ–¹æ³• public static boolean interrupted() &#123; return currentThread().isInterrupted(true); &#125; // è¿”å›æ˜¯å¦ä¸­æ–­ï¼Œå‚æ•°ä¸ºæ˜¯å¦æ¸…é™¤ä¸­æ–­çŠ¶æ€ private native boolean isInterrupted(boolean ClearInterrupted);&#125; è°ƒç”¨ä¸­æ–­æ–¹æ³• interrupt() å¹¶ä¸ä¼šè®©ç›®æ ‡çº¿ç¨‹ç«‹å³åœæ­¢ä»»åŠ¡ï¼Œåªæ˜¯ä¼ é€’ä¸€ä¸ªâ€œå¯ä»¥åœæ­¢â€çš„ä¿¡æ¯ç»™å®ƒã€‚ å½“çº¿ç¨‹è°ƒç”¨waitã€sleepã€joinç­‰ä¼šæŠ›å‡ºInterruptedExceptionçš„æ–¹æ³•æ—¶ï¼Œå°±æ˜¯å¯ä»¥å“åº”ä¸­æ–­ä¿¡å·çš„æ—¶åˆ»ï¼ˆå› æ­¤è¿™äº›æ—¶åˆ»ä¹Ÿè¢«ç§°ä¸ºå–æ¶ˆç‚¹ï¼‰ 12345678910111213public class Thread implements Runnable &#123; /** * å­¦æ¸£å¼ºè¡Œç¿»è¯‘ï¼š * å¦‚æœä»»æ„çº¿ç¨‹ä¸­æ–­äº†å½“å‰çº¿ç¨‹å°±ä¼šæŠ›å‡ºæ­¤å¼‚å¸¸ï¼› * è¿™ä¸ªå¼‚å¸¸æŠ›å‡ºåå½“å‰çº¿ç¨‹çš„â€œä¸­æ–­â€çŠ¶æ€ä¼šè¢«æ¸…ç©ºï¼Œå³æ•è·å¼‚å¸¸åå†è°ƒç”¨isInterrupted()è¿”å›false * @throws InterruptedException * if any thread has interrupted the current thread. The * &lt;i&gt;interrupted status&lt;/i&gt; of the current thread is * cleared when this exception is thrown. */ public static native void sleep(long millis) throws InterruptedException;&#125; å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨ç¨‹åºä¸­é€‚å½“ä½¿ç”¨â€œå–æ¶ˆç‚¹â€æ–¹æ³•ï¼Œå¹¶å¯¹ä¸­æ–­å¼‚å¸¸è¿›è¡Œå¤„ç†ï¼Œå›åˆ°ä¸Šé¢çš„ä»£ç ï¼Œçº¿ç¨‹æ¯æ¬¡è¾“å‡ºä¸€å¥è¯åéƒ½ä¼šsleepä¸€ç§’ï¼Œé’ˆå¯¹sleepæ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ï¼Œçº¿ç¨‹è¡¥æ•è·åˆ°åå¹¶æ²¡æœ‰åšä»»ä½•å¤„ç†ï¼Œè€Œæ˜¯æŠŠå®ƒåƒäº†ï¼Œç°åœ¨æˆ‘è¦å……åˆ†åˆ©ç”¨å®ƒã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public class Main &#123; public static void main(String[] args) throws InterruptedException &#123; Worker worker = new Worker(); worker.start(); Thread.sleep(3000); worker.interrupt(); &#125; public static class Worker extends Thread &#123; private volatile boolean cancelled; @Override public void run() &#123; while (!cancelled) &#123; System.out.println(\"æ¬ç –äº”åˆ†é’Ÿï¼Œåˆ’æ°´ä¸¤å°æ—¶\"); try &#123; sleep(1000); &#125; catch (InterruptedException e) &#123; System.out.println(\"è€æ¿è®©æˆ‘æå‰ä¸‹ç­å’¯\"); break; &#125; &#125; System.out.println(\"æºœäº†æºœäº†\"); &#125; /** * å–æ¶ˆä»»åŠ¡ */ public void cancel() &#123; cancelled = true; &#125; &#125;&#125;/* è¾“å‡º: æ¬ç –äº”åˆ†é’Ÿï¼Œåˆ’æ°´ä¸¤å°æ—¶æ¬ç –äº”åˆ†é’Ÿï¼Œåˆ’æ°´ä¸¤å°æ—¶æ¬ç –äº”åˆ†é’Ÿï¼Œåˆ’æ°´ä¸¤å°æ—¶è€æ¿è®©æˆ‘æå‰ä¸‹ç­å’¯æºœäº†æºœäº†*/ ä½¿ç”¨äº†ä¸­æ–­ï¼Œæˆ‘ä»¬çš„ç¨‹åºä¼¼ä¹æå‡äº†äº›è®¸é€¼æ ¼ï¼Œä½†é˜»å¡æ“ä½œå¸¦æ¥çš„é—®é¢˜ä¾ç„¶æ²¡æœ‰è§£å†³ã€‚ä¸è¿‡æˆ‘ä»¬è¿˜æ˜¯å»ºè®®ä½¿ç”¨ä¸­æ–­æ¥å–æ¶ˆçº¿ç¨‹ï¼Œç”šè‡³è¯´é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸­æ–­æ˜¯å®ç°å–æ¶ˆçš„æœ€åˆç†æ–¹å¼ã€‚ ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´ï¼Œå› ä¸ºå¾ˆå¤šåŒ…å«é˜»å¡æ“ä½œçš„åº“å‡½æ•°å®ç°äº†å’Œä¸­æ–­æœºåˆ¶çš„äº¤äº’ï¼Œç®€å•è¯´å°±æ˜¯å¾ˆå¤šé˜»å¡æ“ä½œæœ¬èº«å°±ä¼šæŠ›å‡ºInterruptedExceptionå¼‚å¸¸ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œé˜»å¡é˜Ÿåˆ—ï¼Œå®ƒçš„é˜»å¡æ–¹æ³•å®šä¹‰äº†æŠ›å‡ºå¼‚å¸¸InterruptedExceptionï¼Œé€šè¿‡æ³¨é‡ŠçŸ¥é“åœ¨ç­‰å¾…æ—¶å¦‚æœè¢«ä¸­æ–­äº†å°±ä¼šæŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ã€‚ 12345678910111213public interface BlockingQueue&lt;E&gt; extends Queue&lt;E&gt; &#123; /** * (å»æ‰æ— å…³æ³¨é‡Š) * * Inserts the specified element into this queue, waiting up to the * specified wait time if necessary for space to become available. * * @throws InterruptedException if interrupted while waiting */ boolean offer(E e, long timeout, TimeUnit unit) throws InterruptedException;&#125; è®©æˆ‘ä»¬å–„ç”¨çº¿ç¨‹ä¸­æ–­æœºåˆ¶å§~","categories":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://acupt.github.io/categories/å¹¶å‘ç¼–ç¨‹/"}],"tags":[{"name":"çº¿ç¨‹","slug":"çº¿ç¨‹","permalink":"https://acupt.github.io/tags/çº¿ç¨‹/"}],"keywords":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://acupt.github.io/categories/å¹¶å‘ç¼–ç¨‹/"}]},{"title":"æ¢ç´¢JAVAå¹¶å‘ - åŒæ­¥å·¥å…·ç±»","slug":"concurrent-sync-tool","date":"2019-07-23T14:00:00.000Z","updated":"2019-07-23T16:36:58.325Z","comments":true,"path":"2019/07/23/concurrent-sync-tool/","link":"","permalink":"https://acupt.github.io/2019/07/23/concurrent-sync-tool/","excerpt":"","text":"åŒæ­¥å·¥å…·ç±»æ˜¯ä¸ªç¬¼ç»Ÿçš„æ¦‚å¿µï¼Œå®ƒå¯ä»¥æ ¹æ®è‡ªèº«çŠ¶æ€æ¥åè°ƒçº¿ç¨‹çš„æ§åˆ¶æµï¼Œäº†è§£JAVAä¸­å¸¸ç”¨çš„åŒæ­¥å·¥å…·èƒ½å¸®åŠ©å¼€å‘è€…å†™å‡ºæ›´å¥½çš„å¹¶å‘ä»£ç ã€‚ é—­é” CountDownLatché—­é”çš„ä½œç”¨ç›¸å½“äºä¸€æ‰‡é—¨ï¼Œåœ¨è¿™æ‰‡é—¨æ²¡æ‰“å¼€å‰ï¼Œä»»ä½•çº¿ç¨‹æ‰§è¡Œåˆ°è¿™é‡Œéƒ½ä¼šè¢«æ— æƒ…æ‰£æŠ¼ï¼Œç›´åˆ°æœ‰äººæ‰“å¼€äº†è¿™æ‰‡é—¨ï¼Œé‚£äº›é˜»å¡åœ¨é—¨å¤–çš„çº¿ç¨‹æ‰ä¼šç»§ç»­è¿›è¡Œé—¨åçš„æµç¨‹ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344import java.util.concurrent.CountDownLatch;public class Main &#123; public static void main(String[] args) throws InterruptedException &#123; //ç¬¬ä¸€æ‰‡é—¨ï¼Œéœ€è¦1æ¬¡è§¦å‘å³å¯æ‰“å¼€ CountDownLatch firstDoor = new CountDownLatch(1); //ç¬¬äºŒæ‰‡é—¨ï¼Œéœ€è¦3æ¬¡è§¦å‘æ‰å¯æ‰“å¼€ CountDownLatch lastDoor = new CountDownLatch(3); //å¯åŠ¨3ä¸ªçº¿ç¨‹ for (int i = 1; i &lt;= 3; i++) &#123; int id = i; new Thread(() -&gt; &#123; try &#123; System.out.println(id + \"å·é“ä»”åˆ°è¾¾ç¬¬ä¸€æ‰‡é—¨å‰\"); firstDoor.await(); Thread.sleep((long) (Math.random() * 5000));//éšæœºä¼‘æ¯ä¸€ä¼š System.out.println(id + \"å·é“ä»”åˆ°è¾¾ç¬¬äºŒæ‰‡é—¨å‰å¹¶è§¦å‘\"); lastDoor.countDown(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;).start(); &#125; Thread.sleep(1000); //ä¸»çº¿ç¨‹æ‰“å¼€ç¬¬ä¸€æ‰‡é—¨ï¼Œè®©å…¶ä»–çº¿ç¨‹å¯ä»¥é€šè¿‡ firstDoor.countDown(); //ç­‰å¾…å…¶ä»–çº¿ç¨‹åˆåŠ›æ‰“å¼€ç¬¬äºŒæ‰‡é—¨ lastDoor.await(); System.out.println(\"bye~\"); &#125;&#125;/* è¾“å‡º:1å·é“ä»”åˆ°è¾¾ç¬¬ä¸€æ‰‡é—¨å‰3å·é“ä»”åˆ°è¾¾ç¬¬ä¸€æ‰‡é—¨å‰2å·é“ä»”åˆ°è¾¾ç¬¬ä¸€æ‰‡é—¨å‰1å·é“ä»”åˆ°è¾¾ç¬¬äºŒæ‰‡é—¨å‰å¹¶è§¦å‘2å·é“ä»”åˆ°è¾¾ç¬¬äºŒæ‰‡é—¨å‰å¹¶è§¦å‘3å·é“ä»”åˆ°è¾¾ç¬¬äºŒæ‰‡é—¨å‰å¹¶è§¦å‘bye~*/ é—­é” FutureTaskFutureTaskä¹Ÿå¯ä»¥ç”¨ä½œé—­é”ï¼Œå¸¸ä¸çº¿ç¨‹æ± ä¸€èµ·ä½¿ç”¨ï¼Œæäº¤åˆ°çº¿ç¨‹æ± åï¼Œä¸»çº¿ç¨‹ï¼ˆæäº¤ä»»åŠ¡çš„çº¿ç¨‹ï¼‰è°ƒç”¨get()æ–¹æ³•é˜»å¡çº¿ç¨‹ç›´åˆ°å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•æˆ–è¶…æ—¶ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566import java.util.concurrent.Callable;import java.util.concurrent.CountDownLatch;import java.util.concurrent.ExecutionException;import java.util.concurrent.FutureTask;public class Main &#123; public static void main(String[] args) throws InterruptedException, ExecutionException &#123; // æ–¹å¼1ï¼šä¼ å…¥ä¸€ä¸ªCallableï¼Œå³ä¸šåŠ¡ä»£ç æ‰§è¡Œå®Œç›´æ¥return FutureTask&lt;Liangzai&gt; callableTask = new FutureTask&lt;&gt;(new Callable&lt;Liangzai&gt;() &#123; @Override public Liangzai call() throws Exception &#123; Thread.sleep(1000); Liangzai liangzai = new Liangzai(); liangzai.name = \"callable\"; return liangzai; &#125; &#125;); // æ–¹å¼2ï¼šä¼ å…¥ä¸€ä¸ªrunnableå’Œä¸€ä¸ªå­˜å‚¨ç»“æœçš„å¯¹è±¡ï¼Œåœ¨runnableä¸­ä¿®æ”¹ç»“æœå¯¹è±¡ Liangzai runableLiangzai = new Liangzai(); FutureTask&lt;Liangzai&gt; runableTask = new FutureTask&lt;&gt;(new Runnable() &#123; @Override public void run() &#123; try &#123; Thread.sleep(1000); runableLiangzai.name = \"runable\"; &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; &#125;, runableLiangzai); // å¼‚æ­¥ç»™é“ä»”å–å new Thread(callableTask).start(); // ç­‰å¾…åå­—ç¡®å®šå®Œæ¯• Liangzai liangzai = callableTask.get(); System.out.println(liangzai); // å¼‚æ­¥ç»™é“ä»”å–å new Thread(runableTask).start(); // ç­‰å¾…åå­—ç¡®å®šå®Œæ¯• liangzai = runableTask.get(); System.out.println(liangzai); &#125; public static class Liangzai &#123; String name; @Override public String toString() &#123; return \"Liangzai&#123;\" + \"name='\" + name + '\\'' + '&#125;'; &#125; &#125;&#125;/* è¾“å‡º:Liangzai&#123;name='callable'&#125;Liangzai&#123;name='runable'&#125;*/ ä¿¡å·é‡ Semaphoreä¿¡å·é‡ç”¨æ¥æ§åˆ¶åŒæ—¶â€œè®¿é—®èµ„æºâ€æˆ–â€œæ‰§è¡Œæ“ä½œâ€çš„çº¿ç¨‹æ•°é‡ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥å®ç°èµ„æºæ± ç­‰ã€‚å®ƒç®¡ç†ç€ä¸€ç»„è™šæ‹Ÿçš„â€œè®¸å¯â€ï¼Œæ¯å½“çº¿ç¨‹æƒ³è®¿é—®æŸä¸ªç‰¹æ®Šèµ„æºï¼Œéœ€è¦å…ˆå‘å®ƒç”³è¯·ä¸€ä¸ªè®¸å¯ï¼Œç”¨å®Œåå†è¿”è¿˜è®¸å¯ï¼Œè®¸å¯ä¸è¶³æ—¶å°†é˜»å¡ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374import java.util.concurrent.*;public class Main &#123; public static void main(String[] args) throws InterruptedException, ExecutionException &#123; // åˆå§‹åŒ–2ä¸ªè®¸å¯ Semaphore semaphore = new Semaphore(2); // ä¸æƒ³ç”¨çº¿ç¨‹æ± ï¼Œç”¨è¿™ä¸ªå®ç°ä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯• int n = 10; CountDownLatch countDownLatch = new CountDownLatch(n); for (int i = 1; i &lt;= n; i++) &#123; int id = i; new Thread(() -&gt; &#123; try &#123; // ç”³è¯·ä¸€ä¸ªè®¸å¯ System.out.println(id + \"å·æƒ³è¦1ä¸ªè®¸å¯\"); semaphore.acquire(); System.out.println(id + \"å·å¾—åˆ°1ä¸ªè®¸å¯\"); // æŒæœ‰è®¸å¯ä¸€æ®µæ—¶é—´ Thread.sleep((long) (Math.random() * 10000)); // å½’è¿˜è®¸å¯ semaphore.release(); System.out.println(id + \"å·å½’è¿˜1ä¸ªè®¸å¯\"); // æ­¤çº¿ç¨‹å®Œæ¯• countDownLatch.countDown(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;).start(); &#125; countDownLatch.await(); System.out.println(\"done~\"); &#125;&#125;/* è¾“å‡º:1å·æƒ³è¦1ä¸ªè®¸å¯2å·æƒ³è¦1ä¸ªè®¸å¯1å·å¾—åˆ°1ä¸ªè®¸å¯2å·å¾—åˆ°1ä¸ªè®¸å¯3å·æƒ³è¦1ä¸ªè®¸å¯4å·æƒ³è¦1ä¸ªè®¸å¯5å·æƒ³è¦1ä¸ªè®¸å¯6å·æƒ³è¦1ä¸ªè®¸å¯7å·æƒ³è¦1ä¸ªè®¸å¯8å·æƒ³è¦1ä¸ªè®¸å¯9å·æƒ³è¦1ä¸ªè®¸å¯10å·æƒ³è¦1ä¸ªè®¸å¯2å·å½’è¿˜1ä¸ªè®¸å¯3å·å¾—åˆ°1ä¸ªè®¸å¯1å·å½’è¿˜1ä¸ªè®¸å¯4å·å¾—åˆ°1ä¸ªè®¸å¯3å·å½’è¿˜1ä¸ªè®¸å¯5å·å¾—åˆ°1ä¸ªè®¸å¯4å·å½’è¿˜1ä¸ªè®¸å¯6å·å¾—åˆ°1ä¸ªè®¸å¯5å·å½’è¿˜1ä¸ªè®¸å¯7å·å¾—åˆ°1ä¸ªè®¸å¯6å·å½’è¿˜1ä¸ªè®¸å¯8å·å¾—åˆ°1ä¸ªè®¸å¯7å·å½’è¿˜1ä¸ªè®¸å¯9å·å¾—åˆ°1ä¸ªè®¸å¯9å·å½’è¿˜1ä¸ªè®¸å¯10å·å¾—åˆ°1ä¸ªè®¸å¯10å·å½’è¿˜1ä¸ªè®¸å¯8å·å½’è¿˜1ä¸ªè®¸å¯done~*/ ä¸Šé¢çš„ä»£ç ï¼Œç”±äºåªæœ‰ä¸¤ä¸ªè®¸å¯ï¼Œæ‰€æœ‰å‰ä¸¤ä¸ªçº¿ç¨‹ä¸€è¯´æƒ³è¦é©¬ä¸Šå°±å¾—åˆ°äº†ï¼Œç¬¬ä¸‰ä¸ªå¼€å§‹å°±å¼€å§‹äº†ä¸ç®—æ¼«é•¿çš„ç­‰å¾…ï¼Œä¸‹ä¸€æ¬¡æœ‰çº¿ç¨‹å¾—åˆ°è®¸å¯æ˜¯åœ¨æœ‰ä¸€ä¸ªçº¿ç¨‹å½’è¿˜è®¸å¯ä¹‹åã€‚ æ …æ  CyclicBarrierCyclicBarrierç±»ä¼¼äºCountDownLatchï¼Œä¹Ÿæ˜¯é˜»å¡ä¸€ç»„çº¿ç¨‹ç›´åˆ°æŸä¸ªæ—¶é—´ç‚¹ï¼ŒåŒºåˆ«å¦‚ä¸‹ã€‚ é—­é” CountDownLatchï¼šç­‰å¾…ä¸€ç»„çº¿ç¨‹å…¨éƒ¨å®ŒæˆæŸä¸ªä»»åŠ¡ï¼Œç„¶åç­‰å¾…çº¿ç¨‹ç»§ç»­æ‰§è¡Œåç»­åŠ¨ä½œã€‚ç»“æŸåçŠ¶æ€ä¸ä¼šå†æ”¹å˜ æ …æ  CyclicBarrierï¼šç­‰å¾…ä¸€ç»„çº¿ç¨‹å…¨éƒ¨åˆ°è¾¾æŸä¸ªä½ç½®ï¼Œç„¶åè¯¥ç»„çº¿ç¨‹ç»§ç»­æ‰§è¡Œåç»­åŠ¨ä½œï¼Œè¯¥ç»„çº¿ç¨‹äº’ç›¸ç­‰å¾…ã€‚çŠ¶æ€å¯ä»¥é‡ç½®ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253import java.util.concurrent.*;public class Main &#123; public static void main(String[] args) throws InterruptedException, ExecutionException &#123; // å®šä¹‰ä¸€ä¸ªæ …æ ï¼Œç­‰å¾…3ä¸ªäººåˆ°è¾¾åä¸€èµ·å—¨çš® int n = 3; CyclicBarrier barrier = new CyclicBarrier(n, new Runnable() &#123; @Override public void run() &#123; // å…¨éƒ¨äººå°±ç»ªåæ‰§è¡Œçš„æ“ä½œ System.out.println(\"å¤§å®¶éƒ½åˆ°é½äº†ï¼Œå¼€å§‹happyå»\"); &#125; &#125;); // ä¸æƒ³ç”¨çº¿ç¨‹æ± ï¼Œç”¨è¿™ä¸ªå®ç°ä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯• CountDownLatch countDownLatch = new CountDownLatch(n); for (int i = 1; i &lt;= n; i++) &#123; int id = i; new Thread(() -&gt; &#123; try &#123; // æ¯ä¸ªäººå‡ºé—¨æ‰“æ‰®éœ€è¦çš„æ—¶é—´éƒ½æ˜¯ä¸åŒçš„ Thread.sleep((long) (Math.random() * 5000)); // ç­‰å¾…å…¶ä»–äººåˆ°è¾¾è¿™é‡Œ System.out.println(id + \": æˆ‘åˆ°åœ°æ–¹äº†\"); barrier.await(); System.out.println(id + \": let's go\"); // æ­¤çº¿ç¨‹å®Œæ¯• countDownLatch.countDown(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;).start(); &#125; countDownLatch.await(); System.out.println(\"done~\"); &#125;&#125;/* è¾“å‡º:3: æˆ‘åˆ°åœ°æ–¹äº†2: æˆ‘åˆ°åœ°æ–¹äº†1: æˆ‘åˆ°åœ°æ–¹äº†å¤§å®¶éƒ½åˆ°é½äº†ï¼Œå¼€å§‹happyå»1: let's go3: let's go2: let's godone~*/ æ …æ  ExchangerExchangeræ˜¯ä¸€ç§ä¸¤æ–¹çš„æ …æ ï¼Œç”¨äºä¸¤æ–¹ä¹‹é—´äº¤æ¢æ•°æ®ï¼Œä¸€æ–¹å‘å‡ºæ¶ˆæ¯åä¼šé˜»å¡ç›´åˆ°å¯¹æ–¹æ¥å—åˆ°æ¶ˆæ¯å¹¶è¿”å›ä¸€ä¸ªæ¶ˆæ¯ï¼Œè¾¾åˆ°ä¸€äººä¸€å¥çš„å’Œè°äº¤æµã€‚å½“ä¸¤æ–¹çš„æ“ä½œä¸å¯¹ç§°æ—¶å¾ˆæœ‰ç”¨ï¼Œæ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹å¾€ç¼“å†²åŒºå†™æ•°æ®ï¼Œä¸€ä¸ªçº¿ç¨‹ä»ç¼“å†²åŒºè¯»æ•°æ®ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051import java.util.concurrent.*;public class Main &#123; public static void main(String[] args) throws InterruptedException, ExecutionException &#123; Exchanger&lt;String&gt; exchanger = new Exchanger&lt;&gt;(); CountDownLatch countDownLatch = new CountDownLatch(2); new Thread(() -&gt; &#123; try &#123; for (int i = 0; i &lt; 5; i++) &#123; Thread.sleep((long) (Math.random() * 5000)); String fromKun = exchanger.exchange(\"æˆ‘æ˜¯å°èœï¼ŒNo.\" + i); System.out.println(\"å°èœæ”¶åˆ°æ¶ˆæ¯ï¼š\" + fromKun); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; countDownLatch.countDown(); &#125;).start(); new Thread(() -&gt; &#123; try &#123; for (int i = 0; i &lt; 5; i++) &#123; Thread.sleep((long) (Math.random() * 5000)); String fromKun = exchanger.exchange(\"æˆ‘æ˜¯é˜¿å¤ï¼ŒNo.\" + i); System.out.println(\"é˜¿å¤æ”¶åˆ°æ¶ˆæ¯ï¼š\" + fromKun); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; countDownLatch.countDown(); &#125;).start(); countDownLatch.await(); System.out.println(\"done~\"); &#125;&#125;/* è¾“å‡º:å°èœæ”¶åˆ°æ¶ˆæ¯ï¼šæˆ‘æ˜¯é˜¿å¤ï¼ŒNo.0é˜¿å¤æ”¶åˆ°æ¶ˆæ¯ï¼šæˆ‘æ˜¯å°èœï¼ŒNo.0é˜¿å¤æ”¶åˆ°æ¶ˆæ¯ï¼šæˆ‘æ˜¯å°èœï¼ŒNo.1å°èœæ”¶åˆ°æ¶ˆæ¯ï¼šæˆ‘æ˜¯é˜¿å¤ï¼ŒNo.1é˜¿å¤æ”¶åˆ°æ¶ˆæ¯ï¼šæˆ‘æ˜¯å°èœï¼ŒNo.2å°èœæ”¶åˆ°æ¶ˆæ¯ï¼šæˆ‘æ˜¯é˜¿å¤ï¼ŒNo.2å°èœæ”¶åˆ°æ¶ˆæ¯ï¼šæˆ‘æ˜¯é˜¿å¤ï¼ŒNo.3é˜¿å¤æ”¶åˆ°æ¶ˆæ¯ï¼šæˆ‘æ˜¯å°èœï¼ŒNo.3é˜¿å¤æ”¶åˆ°æ¶ˆæ¯ï¼šæˆ‘æ˜¯å°èœï¼ŒNo.4å°èœæ”¶åˆ°æ¶ˆæ¯ï¼šæˆ‘æ˜¯é˜¿å¤ï¼ŒNo.4done~*/ æ€»ç»“æ‰€è°“åŒæ­¥å·¥å…·ç±»å¹¶ä¸ç‰¹æŒ‡å®ç°æŸç§åŠŸèƒ½çš„ç±»ï¼Œå®ƒä»¬ä¸»è¦çš„ä»·å€¼å°±åœ¨äºèƒ½å¸®åŠ©å¤šçº¿ç¨‹ä¹‹é—´æ›´å¥½åœ°ç›¸äº’é…åˆå®Œæˆå·¥ä½œï¼Œåªè¦å¯¹è‡ªå·±çš„éœ€æ±‚æ¸…æ™°ï¼Œå¯¹JAVAè‡ªå¸¦çš„ç±»ç†Ÿæ‚‰ï¼Œå°±èƒ½é€‰æ‹©åˆé€‚çš„åŒæ­¥å·¥å…·ç±»ï¼Œç”šè‡³å®ç°è‡ªå·±éœ€è¦çš„åŒæ­¥å·¥å…·ç±»ã€‚","categories":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://acupt.github.io/categories/å¹¶å‘ç¼–ç¨‹/"}],"tags":[{"name":"çº¿ç¨‹","slug":"çº¿ç¨‹","permalink":"https://acupt.github.io/tags/çº¿ç¨‹/"},{"name":"å¹¶å‘","slug":"å¹¶å‘","permalink":"https://acupt.github.io/tags/å¹¶å‘/"},{"name":"åŒæ­¥","slug":"åŒæ­¥","permalink":"https://acupt.github.io/tags/åŒæ­¥/"}],"keywords":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://acupt.github.io/categories/å¹¶å‘ç¼–ç¨‹/"}]},{"title":"æ¢ç´¢JAVAå¹¶å‘ - ThreadLocal","slug":"concurrent_threadlocal","date":"2019-07-22T14:00:00.000Z","updated":"2019-07-22T16:30:10.048Z","comments":true,"path":"2019/07/22/concurrent_threadlocal/","link":"","permalink":"https://acupt.github.io/2019/07/22/concurrent_threadlocal/","excerpt":"","text":"ä½¿ç”¨ThreadLocalå¯ä»¥ç»´æŒçº¿ç¨‹å°é—­æ€§ï¼Œä½¿çº¿ç¨‹ä¸­çš„æŸä¸ªå€¼ä¸ä¿å­˜å€¼çš„å¯¹è±¡å…³è”ï¼Œé˜²æ­¢å¯¹å¯å˜çš„å•ä¾‹å˜é‡æˆ–å…¨å±€å˜é‡è¿›è¡Œå…±äº«ï¼Œä½†ä½¿ç”¨ä¸å½“ä¹Ÿä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Œå…ˆäº†è§£å®ƒï¼Œå†ä½¿ç”¨å®ƒâ€‹ã€‚â€‹ ä»SimpleDateFormatè¯´èµ·SimpleDateFormatæ˜¯æˆ‘ä»¬å¸¸ç”¨çš„æ—¥æœŸæ ¼å¼åŒ–å·¥å…·ï¼Œä½†ç†Ÿæ‚‰çš„æœ‹å‹éƒ½çŸ¥é“å®ƒæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚ SimpleDateFormatç”¨æ³•1234567public class Acuptest &#123; public static void main(String[] args) &#123; SimpleDateFormat sdf = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss,SSS\"); System.out.println(sdf.format(new Date())); &#125;&#125; SimpleDateFormatçº¿ç¨‹ä¸å®‰å…¨åœºæ™¯ä¸Šé¢çš„ç”¨æ³•å®Œå…¨æ²¡æœ‰é—®é¢˜ï¼Œä½†ç°åœ¨springæ— å¤„ä¸åœ¨ï¼Œå¾ˆå¤šç±»éƒ½æ˜¯ä»¥beançš„å½¢å¼å­˜åœ¨äºspringå®¹å™¨è¢«å„ç§å…±äº«ï¼Œä¸€ä¸å°å¿ƒå°±ä¼šå†™æˆä¸‹é¢è¿™ç§æ ·å­ã€‚ 12345678public class Acuptest &#123; private SimpleDateFormat sdf = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss,SSS\"); public String format(Date date) &#123; return sdf.format(date); &#125;&#125; åªæ˜¯è¿™æ ·è¿˜çœ‹ä¸å‡ºä»€ä¹ˆé—®é¢˜ï¼Œä½†æ—¢ç„¶æåˆ°äº†SimpleDateFormatæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œé‚£ä¹ˆå°±çœ‹çœ‹ä¸ºä»€ä¹ˆä¸å®‰å…¨ã€‚ SimpleDateFormatçº¿ç¨‹ä¸å®‰å…¨åˆ†æè¿›å…¥æºç ï¼Œåªçœ‹å…³é”®éƒ¨åˆ†ã€‚ 1234567891011121314151617181920212223242526272829303132333435public abstract class DateFormat extends Format &#123; // ä¸€ä¸ªæˆå‘˜å˜é‡ protected Calendar calendar; // ä¸€ä¸ªæŠ½è±¡æ–¹æ³• public abstract StringBuffer format(Date date, StringBuffer toAppendTo, FieldPosition fieldPosition); // æä¾›ç»™å¤–éƒ¨ä½¿ç”¨çš„æ–¹æ³• public final String format(Date date)&#123; return format(date, new StringBuffer(), DontCareFieldPosition.INSTANCE).toString(); &#125;&#125;public class SimpleDateFormat extends DateFormat &#123; // å®ç°äº†çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³• @Override public StringBuffer format(Date date, StringBuffer toAppendTo, FieldPosition pos)&#123; pos.beginIndex = pos.endIndex = 0; return format(date, toAppendTo, pos.getFieldDelegate()); &#125; private StringBuffer format(Date date, StringBuffer toAppendTo, FieldDelegate delegate) &#123; // åˆ°è¿™é‡Œå°±èƒ½å‘ç°é—®é¢˜äº†ï¼Œç«Ÿç„¶ç»™æˆå‘˜å˜é‡è®¾ç½®æˆäº†ä¼ è¿›æ¥çš„å‚æ•° // åœ¨å¹¶å‘æƒ…å†µä¸‹calendarçš„å€¼å°±ä¸å¯ä¿¡äº†ï¼Œå¯èƒ½çº¿ç¨‹Aå‰è„šåˆšè®¾ç½®å®Œå‡†å¤‡æ‰§è¡Œä¸‹ä¸€æ¡è¯­å¥ï¼Œçº¿ç¨‹Bç´§éšå…¶åå°±æŠŠå€¼ç»™æ”¹äº† // Convert input date to time field list calendar.setTime(date); boolean useDateFormatSymbols = useDateFormatSymbols(); // ç•¥ &#125;&#125; SimpleDateFormatçº¿ç¨‹å®‰å…¨ç”¨æ³•ä½¿ç”¨å±€éƒ¨å˜é‡åªè¦ä¸è®©å¤šçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå¯¹è±¡ï¼Œæ¯æ¬¡è¦ç”¨å°±newä¸€ä¸ªå¯¹è±¡å³å¯ã€‚ ä½¿ç”¨ThreadLocalå¾ˆå¤šæ—¶å€™æŸäº›å¯¹è±¡å¾€å¾€ä¸é€‚åˆé¢‘ç¹åˆ›å»ºã€é”€æ¯ï¼Œä½†å®ƒåˆåƒSimpleDateFormaté‚£æ ·çº¿ç¨‹ä¸å®‰å…¨ã€‚è¿™æ—¶å€™ThreadLocalå°±æœ‰ç”¨æ­¦ä¹‹åœ°äº†ã€‚ 1234567891011121314public class Acuptest &#123; // ä¸ºæ¯ä¸ªçº¿ç¨‹å•ç‹¬åˆ†é…ä¸€ä¸ªSimpleDateFormatï¼Œçº¿ç¨‹å†…éƒ¨å¯ä»¥å¤ç”¨ï¼Œçº¿ç¨‹ä¹‹é—´ä¸èƒ½å…±äº«ã€‚ private ThreadLocal&lt;SimpleDateFormat&gt; sdf = new ThreadLocal&lt;SimpleDateFormat&gt;() &#123; @Override protected SimpleDateFormat initialValue() &#123; // get()æ–¹æ³•è·å–ä¸åˆ°å½“å‰çº¿ç¨‹çš„SimpleDateFormatå¯¹è±¡æ—¶ï¼Œä¼šè°ƒç”¨æ­¤æ–¹æ³•åˆ›å»ºä¸€ä¸ªå¹¶ç»‘å®šåˆ°çº¿ç¨‹ return new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss,SSS\"); &#125; &#125;; public String format(Date date) &#123; return sdf.get().format(date); &#125; ThreadLocalæºç åˆ†æ12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849public class ThreadLocal&lt;T&gt; &#123; //... // è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°†è°ƒç”¨initialValueç”Ÿæˆä¸€ä¸ªå¹¶ç»‘å®š public T get() &#123; // è·å–å½“å‰çº¿ç¨‹ Thread t = Thread.currentThread(); // ä»å½“å‰çº¿ç¨‹ä¸­å–åˆ°ä¸€ä¸ªMAP // key: ThreadLocal // value: ThreadLocalçš„æ³›å‹ &lt;T&gt; ThreadLocalMap map = getMap(t); if (map != null) &#123; ThreadLocalMap.Entry e = map.getEntry(this); if (e != null) &#123; @SuppressWarnings(\"unchecked\") T result = (T)e.value; return result; &#125; &#125; // Threadå¯¹è±¡å¯èƒ½è¿˜æ²¡åˆ›å»ºThreadLocalMapæˆå‘˜å˜é‡ // æˆ–è€…ThreadLocalMapé‡Œæ²¡æœ‰å½“å‰ThreadLocalå¯¹è±¡å¯¹åº”çš„&lt;T&gt;å€¼ // æ­¤æ—¶éœ€è¦è®¾ç½®åˆå§‹å€¼ return setInitialValue(); &#125; // è·å–çº¿ç¨‹é‡Œçš„MAP ThreadLocalMap getMap(Thread t) &#123; return t.threadLocals; &#125; // è®¾ç½®åˆå§‹å€¼ private T setInitialValue() &#123; // åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ T value = initialValue(); // é‡æ–°è·å–å½“å‰çº¿ç¨‹ï¼Œå› ä¸ºæ²¡æœ‰å‚æ•°æ¥æ”¶çº¿ç¨‹ä¿¡æ¯ Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) map.set(this, value); // è®¾ç½®åˆå§‹å€¼ else createMap(t, value); // åˆ›å»ºMAPå¹¶è®¾ç½®åˆå§‹å€¼ return value; &#125; // åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œé»˜è®¤è¿”å›nullï¼Œå¯åœ¨ä½¿ç”¨æ—¶é‡å†™æ­¤æ–¹æ³• protected T initialValue() &#123; return null; &#125; // ...&#125; Threadæºç åˆ†æä¸Šé¢çš„æºç ä¸­çœ‹åˆ°ThreadLocalå¤šæ¬¡ä½¿ç”¨Threadä¸­çš„æˆå‘˜å˜é‡threadLocalsï¼Œäºæ˜¯å¯¹Threadå¯¹è±¡çš„ç»“æ„å†åšä¸ªç®€å•äº†è§£ã€‚ 123456789101112131415161718192021222324252627282930313233343536public class Thread implements Runnable &#123; /* ThreadLocal values pertaining to this thread. This map is maintained * by the ThreadLocal class. */ ThreadLocal.ThreadLocalMap threadLocals = null; /* * InheritableThreadLocal values pertaining to this thread. This map is * maintained by the InheritableThreadLocal class. */ ThreadLocal.ThreadLocalMap inheritableThreadLocals = null; // ç•¥&#125;public class ThreadLocal&lt;T&gt; &#123; static class ThreadLocalMap &#123; static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; &#123; /** The value associated with this ThreadLocal. */ Object value; Entry(ThreadLocal&lt;?&gt; k, Object v) &#123; super(k); value = v; &#125; &#125; /** * The table, resized as necessary. * table.length MUST always be a power of two. */ private Entry[] table; &#125;&#125; threadLocalså’ŒinheritableThreadLocalsä»Threadæºç ä¸­å¯ä»¥çœ‹åˆ°ThreadLocal.ThreadLocalMaç±»å‹çš„æˆå‘˜å˜é‡æœ‰ä¸¤ä¸ªï¼Œæœ‰ä¸ªæ˜¯ä¹‹å‰æ²¡æœ‰è§è¿‡çš„inheritableThreadLocalsï¼Œè¿™ä¸ªå˜é‡ä¸æ˜¯ç»™ThreadLocalç”¨çš„ï¼Œè€Œæ˜¯ç»™å¦ä¸€ä¸ªç±»ä¼¼çš„å·¥å…·InheritableThreadLocalç”¨çš„ã€‚ 1234567891011121314public class InheritableThreadLocal&lt;T&gt; extends ThreadLocal&lt;T&gt; &#123; protected T childValue(T parentValue) &#123; return parentValue; &#125; ThreadLocalMap getMap(Thread t) &#123; return t.inheritableThreadLocals; &#125; void createMap(Thread t, T firstValue) &#123; t.inheritableThreadLocals = new ThreadLocalMap(this, firstValue); &#125;&#125; ä»æºç ä¸Šçœ‹ï¼ŒInheritableThreadLocalç»§æ‰¿äº†ThreadLocalï¼Œç„¶åä½¿ç”¨çš„MAPæ¢äº†ï¼Œå…¶ä»–å°±æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ã€‚ ä½†InheritableThreadLocalæœ‰ç€ç‰¹æ®Šçš„åŠŸèƒ½ï¼šå®ƒå¯ä»¥ä½¿ç”¨çˆ¶çº¿ç¨‹çš„inheritableThreadLocalså˜é‡ï¼Œå®ç°çˆ¶å­çº¿ç¨‹å…±äº«å˜é‡ã€‚ InheritableThreadLocalä¸ºä»€ä¹ˆå¯ä»¥è®©å­çº¿ç¨‹ä½¿ç”¨çˆ¶çº¿ç¨‹çš„å˜é‡ï¼Œå…³é”®çš„åœ°æ–¹ä¸åœ¨å®ƒï¼Œè€Œåœ¨Threadç±»çš„åˆå§‹åŒ–æµç¨‹ï¼ŒThreadåˆå§‹åŒ–æ—¶ï¼Œ 123456789101112131415161718public class Thread implements Runnable &#123; private void init(ThreadGroup g, Runnable target, String name, long stackSize, AccessControlContext acc, boolean inheritThreadLocals) &#123; // ç•¥ Thread parent = currentThread(); // ç•¥ // inheritThreadLocalsé»˜è®¤ä¸ºtrue // çˆ¶çº¿ç¨‹inheritableThreadLocalsä¸ä¸ºç©ºåˆ™å¤åˆ¶ä¸€ä»½ // å€¼å¤åˆ¶ï¼Œéå¼•ç”¨å¤åˆ¶ // åªæ˜¯å¤åˆ¶çˆ¶çº¿ç¨‹å½“å‰æ‹¥æœ‰çš„å¯¹è±¡ if (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != null) this.inheritableThreadLocals = ThreadLocal.createInheritedMap(parent.inheritableThreadLocals); // ç•¥ &#125;&#125; ThreadLocalä¸­çš„å¼±å¼•ç”¨(WeakReference)ä»ä¸Šé¢çš„æºç ä¸­æ³¨æ„åˆ°: ThreadLocal.ThreadLocalMap.Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; Entryçš„keyæ˜¯ThreadLocal&lt;?&gt;ï¼Œæ˜¯ä¸ªå¼±å¼•ç”¨ï¼ˆè¢«GCæ‰«æåˆ°å°±å›æ”¶ï¼‰ã€‚å¦‚æœä¸è¿™æ ·ï¼Œå½“ThreadLocal&lt;?&gt;ç”¨å®Œäº†ï¼Œä½†çº¿ç¨‹è¿˜æ²¡ç»“æŸï¼Œå› æ­¤Threadé‡Œé¢è¿˜æŒæœ‰ç€ThreadLocal&lt;?&gt;çš„å¼ºå¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒæ°¸è¿œä¸ä¼šè¢«å›æ”¶ï¼Œå¯ä»¥è®¤ä¸ºå†…å­˜æ³„æ¼äº†ã€‚ ThreadLocalçš„å†…å­˜æ³„æ¼å°±ç®—æ˜¯ä½¿ç”¨äº†å¼±å¼•ç”¨ï¼Œä¾ç„¶å­˜åœ¨å†…å­˜æ³„æ¼çš„å¯èƒ½ã€‚å› ä¸ºå¼±å¼•ç”¨ä»…ä»…æ˜¯Entryçš„key(ThreadLocal)ï¼Œvalueï¼ˆæ³›å‹Tï¼‰å¹¶ä¸æ˜¯å¼±å¼•ç”¨ã€‚æœ€ç»ˆå¯èƒ½å‡ºç°çš„ç»“æœå°±æ˜¯ï¼ŒThreadLocalè¢«å›æ”¶äº†ï¼ŒThreadé‡Œçš„MAPä¸­KEYå°±æ²¡äº†ï¼Œä½†valueè¿˜åœ¨ï¼Œè¿™æ ·ä¸€æ¥è¿™ä¸ªvalueæ°¸è¿œä¸ä¼šè¢«get()æ–¹æ³•è¿”å›ï¼Œç¡®åˆå­˜åœ¨äºå†…å­˜ä¸æ„¿æ¶ˆæ•£ã€‚ å†…éƒ¨å®ç°å°½é‡é¿å…å†…å­˜æ³„æ¼ï¼š åœ¨ThreadLocalçš„get()ã€set()ã€remove()æ–¹æ³•è°ƒç”¨çš„æ—¶å€™ä¼šæ¸…é™¤æ‰çº¿ç¨‹ThreadLocalMapä¸­æ‰€æœ‰Entryä¸­Keyä¸ºnullçš„Valueï¼Œå¹¶å°†æ•´ä¸ªEntryè®¾ç½®ä¸ºnullï¼Œåˆ©äºä¸‹æ¬¡å†…å­˜å›æ”¶ã€‚ å¦‚æœæ²¡æœ‰è°ƒç”¨è¿™äº›æ–¹æ³•å»è§¦å‘è¿™ä¸ªè¿‡ç¨‹ï¼Œä¾ç„¶ä¼šå†…å­˜æ³„æ¼ï¼Œæ‰€ä»¥åœ¨çº¿ç¨‹ç”¨å®Œè¿™ä¸ªå¯¹è±¡åï¼Œå¯ä»¥æ˜¾ç¤ºè°ƒç”¨removeæ–¹æ³•ä½¿å…¶æ¸…é™¤ã€‚","categories":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://acupt.github.io/categories/å¹¶å‘ç¼–ç¨‹/"}],"tags":[{"name":"çº¿ç¨‹","slug":"çº¿ç¨‹","permalink":"https://acupt.github.io/tags/çº¿ç¨‹/"},{"name":"å¹¶å‘","slug":"å¹¶å‘","permalink":"https://acupt.github.io/tags/å¹¶å‘/"}],"keywords":[{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","permalink":"https://acupt.github.io/categories/å¹¶å‘ç¼–ç¨‹/"}]},{"title":"æ­»é”çš„å››å¤§æ¡ä»¶ä¸å¤„ç†ç­–ç•¥","slug":"deadlock","date":"2019-07-21T14:40:00.000Z","updated":"2019-07-21T15:33:08.997Z","comments":true,"path":"2019/07/21/deadlock/","link":"","permalink":"https://acupt.github.io/2019/07/21/deadlock/","excerpt":"","text":"æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±äºç«äº‰èµ„æºæˆ–è€…ç”±äºå½¼æ­¤é€šä¿¡è€Œé€ æˆçš„ä¸€ç§é˜»å¡çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ã€‚æ­¤æ—¶ç§°ç³»ç»Ÿå¤„äºæ­»é”çŠ¶æ€æˆ–ç³»ç»Ÿäº§ç”Ÿäº†æ­»é”ï¼Œè¿™äº›æ°¸è¿œåœ¨äº’ç›¸ç­‰å¾…çš„è¿›ç¨‹ç§°ä¸ºæ­»é”è¿›ç¨‹ã€‚ æ¯”å¦‚ï¼šä¸¤ä¸ªçº¿ç¨‹Aã€Bå„è‡ªæŒæœ‰ä¸€ä¸ªæ— æ³•å…±äº«çš„èµ„æºï¼Œå¹¶ä¸”ä»–ä»¬éƒ½éœ€è¦è·å–å¯¹æ–¹ç°åœ¨æŒæœ‰çš„èµ„æºæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œä½†æ˜¯ä»–ä»¬åˆå¿…é¡»ç­‰å¯¹æ–¹é‡Šæ”¾äº†æ‰èƒ½å»è·å–ï¼Œäºæ˜¯Aç­‰å¾…Bï¼ŒBä¹Ÿåœ¨ç­‰å¾…Aã€‚å¦‚æ­¤è¿™èˆ¬ï¼Œæ­»é”å°±äº§ç”Ÿäº†ã€‚ äº§ç”Ÿæ­»é”çš„å››ä¸ªæ¡ä»¶æ­»é”çš„å‘ç”Ÿå¿…é¡»å…·å¤‡ä»¥ä¸‹å››ä¸ªå¿…è¦æ¡ä»¶ äº’æ–¥æ¡ä»¶ï¼ˆMutual exclusionï¼‰èµ„æºä¸èƒ½è¢«å…±äº«ï¼Œåªèƒ½ç”±ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ã€‚ è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼ˆHold and waitï¼‰å·²ç»å¾—åˆ°èµ„æºçš„è¿›ç¨‹å¯ä»¥å†æ¬¡ç”³è¯·æ–°çš„èµ„æºã€‚ ä¸å¯å‰¥å¤ºæ¡ä»¶ï¼ˆNo pre-emptionï¼‰å·²ç»åˆ†é…çš„èµ„æºä¸èƒ½ä»ç›¸åº”çš„è¿›ç¨‹ä¸­è¢«å¼ºåˆ¶åœ°å‰¥å¤ºã€‚ ç¯è·¯/å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼ˆCircular waitï¼‰ç³»ç»Ÿä¸­è‹¥å¹²è¿›ç¨‹ç»„æˆç¯è·¯ï¼Œè¯¥ç¯è·¯ä¸­æ¯ä¸ªè¿›ç¨‹éƒ½åœ¨ç­‰å¾…ç›¸é‚»è¿›ç¨‹æ­£å ç”¨çš„èµ„æºã€‚ äº†è§£å››ä¸ªå¿…è¦æ¡ä»¶åå†æ¥çœ‹çœ‹å¼€å§‹çš„ä¾‹å­ï¼š ä¸¤ä¸ªçº¿ç¨‹å„è‡ªæŒæœ‰ä¸€ä¸ªæ— æ³•å…±äº«(äº’æ–¥æ¡ä»¶)çš„èµ„æºï¼Œå¹¶ä¸”ä»–ä»¬éƒ½éœ€è¦è·å–ï¼ˆè¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼‰å¯¹æ–¹ç°åœ¨æŒæœ‰çš„èµ„æºæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œä½†æ˜¯ä»–ä»¬åˆå¿…é¡»ç­‰å¯¹æ–¹é‡Šæ”¾äº†æ‰èƒ½å»è·å–(ä¸å¯å‰¥å¤ºæ¡ä»¶)ï¼Œäºæ˜¯Aç­‰å¾…Bï¼ŒBä¹Ÿåœ¨ç­‰å¾…Aï¼ˆç¯è·¯ç­‰å¾…æ¡ä»¶ï¼‰ã€‚å¦‚æ­¤è¿™èˆ¬ï¼Œæ­»é”å°±äº§ç”Ÿäº†ã€‚ é¢„é˜²æ­»é”é€šè¿‡ç ´åå››ä¸ªå¿…è¦æ¡ä»¶ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªï¼Œä½¿æ­»é”æ°¸è¿œæ— æ³•æ»¡è¶³ã€‚å®ç°ç®€å•ï¼Œä½†æ˜¯ç”±äºæ‰€æ–½åŠ çš„é™åˆ¶æ¡ä»¶å¾€å¾€å¤ªä¸¥æ ¼ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿèµ„æºåˆ©ç”¨ç‡å’Œç³»ç»Ÿååé‡é™ä½ã€‚ é¢„å…ˆèµ„æºåˆ†é…æ³•ä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰éœ€è¦çš„èµ„æºï¼Œåªè¦æœ‰ä¸€ç§èµ„æºä¸æ»¡è¶³è¦æ±‚ï¼Œå“ªæ€•å…¶å®ƒéœ€è¦çš„èµ„æºéƒ½è¶³å¤Ÿï¼Œä¹Ÿä¸åšä»»ä½•åˆ†é…ã€‚è¿™æ ·ä¸€æ¥å°±æ²¡æœ‰â€œä¿æŒâ€èµ„æºçš„çŠ¶æ€ï¼Œåªæœ‰â€œè¯·æ±‚â€èµ„æºçš„çŠ¶æ€ï¼Œç ´åäº†è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ã€‚ æœ‰åºèµ„æºåˆ†é…æ³•åœ¨ç”³è¯·ä¸åŒç±»èµ„æºæ—¶ï¼Œå¿…é¡»æŒ‰æŒ‡å®šé¡ºåºç”³è¯·ï¼Œç ´åäº†ç¯è·¯ç­‰å¾…æ¡ä»¶ã€‚ æ­£ä¾‹ï¼šçº¿ç¨‹Aã€Bç”³è¯·èµ„æºé¡ºåºå‡ä¸ºR1-&gt;R2ï¼› åä¾‹ï¼šAç”³è¯·é¡ºåºä¸ºR1-&gt;R2ï¼ŒBç”³è¯·é¡ºåºä¸ºR2-&gt;R1ã€‚ é¿å…æ­»é”ä¹Ÿæ˜¯é¢„å‘æ­»é”ï¼Œä½†ä¸ä¼šäº‹å…ˆå»ç ´åæ­»é”çš„å¿…è¦æ¡ä»¶ï¼Œåªæ˜¯æœ‰äººè¯·æ±‚èµ„æºæ—¶ï¼Œç”¨æŸç§æ–¹æ³•é˜²æ­¢ç³»ç»Ÿè¿›å…¥ä¸å®‰å…¨çš„çŠ¶æ€ï¼ˆæ­»é”ï¼‰ï¼Œä»è€Œé¿å…å‘ç”Ÿæ­»é”ã€‚ é“¶è¡Œå®¶ç®—æ³•åŸºæœ¬æ€æƒ³æ˜¯åˆ†é…èµ„æºä¹‹å‰ï¼Œåˆ¤æ–­ç³»ç»Ÿæ˜¯å¦æ˜¯å®‰å…¨çš„ï¼›è‹¥æ˜¯ï¼Œæ‰åˆ†é…ã€‚ æ£€æµ‹æ­»é”å’Œè§£é™¤ä¸é‡‡å–æªæ–½é˜²æ­¢æ­»é”äº§ç”Ÿï¼Œå…è®¸ç³»ç»Ÿäº§ç”Ÿæ­»é”ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ä¸€äº›æ‰‹æ®µæ£€æµ‹å‡ºæ­»é”ï¼Œç„¶åå°†æ­»é”è§£é™¤ã€‚ æ£€æµ‹æ–¹æ³•ï¼š å®šæ—¶æ£€æµ‹ æ•ˆç‡ä½æ—¶æ£€æµ‹ è¿›ç¨‹ç­‰å¾…æ—¶æ£€æµ‹ è§£é™¤æ­»é”æ–¹æ³•ï¼š æ ¹æ®å…·ä½“ä¸šåŠ¡åœºæ™¯ï¼Œå¯ä»¥æ’¤é”€æˆ–æŒ‚èµ·æ­»é”çš„è¿›ç¨‹/çº¿ç¨‹ï¼Œä½¿èµ„æºé‡Šæ”¾ã€‚","categories":[{"name":"é¢è¯•æ‚è°ˆ","slug":"é¢è¯•æ‚è°ˆ","permalink":"https://acupt.github.io/categories/é¢è¯•æ‚è°ˆ/"}],"tags":[{"name":"æ­»é”","slug":"æ­»é”","permalink":"https://acupt.github.io/tags/æ­»é”/"}],"keywords":[{"name":"é¢è¯•æ‚è°ˆ","slug":"é¢è¯•æ‚è°ˆ","permalink":"https://acupt.github.io/categories/é¢è¯•æ‚è°ˆ/"}]},{"title":"JAVAä¸­çš„StringçœŸçš„ä¸å¯å˜å—","slug":"java-string","date":"2019-07-17T15:00:00.000Z","updated":"2019-07-18T16:19:15.719Z","comments":true,"path":"2019/07/17/java-string/","link":"","permalink":"https://acupt.github.io/2019/07/17/java-string/","excerpt":"","text":"Stringæ˜¯ä¸å¯å˜çš„å—ï¼Ÿæ˜¯çš„ï¼çœŸæƒ³å˜ï¼Ÿä¹Ÿè¡Œ~ æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒStringæ˜¯ä¸å¯å˜å¯¹è±¡ï¼Œå³ä¸€æ—¦åˆ›å»ºï¼Œé‚£ä¹ˆå°±ä¸èƒ½æ”¹å˜å®ƒçš„çŠ¶æ€ã€‚å¯¹æ­¤ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€æ³¢ã€‚ Stringçš„å†…éƒ¨æ„é€ å°å¿ƒç¿¼ç¿¼è¿›å…¥Stringçš„å†…éƒ¨ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæ˜¯ä¸€ä¸ªfinalç±»ï¼Œé‚£ä¹ˆæ²¡äººèƒ½ç»§æ‰¿å®ƒï¼Œå¾ˆå¥½ï¼Œå¾ˆä¸å…‹ã€‚ ç„¶åç›´æ¥çœ‹å‘å®ƒçš„çµé­‚ï¼Œä¸€ä¸ªcharæ•°ç»„ï¼Œä¹Ÿæ˜¯finalï¼Œäºæ˜¯æˆ‘ä»¬çŸ¥é“å®ƒæ€ä¹ˆä¸å¯å˜äº†ã€‚ 1234567891011121314public final class String implements java.io.Serializable, Comparable&lt;String&gt;, CharSequence &#123; /** The value is used for character storage. */ private final char value[]; /** Cache the hash code for the string */ private int hash; // Default to 0 /** use serialVersionUID from JDK 1.0.2 for interoperability */ private static final long serialVersionUID = -6849794470754667710L; // ç•¥...&#125; åˆ›å»ºå¯¹è±¡ç›´æ¥ç”¨å¸¸é‡ç»™Stringå˜é‡èµ‹å€¼ï¼Œä¸ç®¡åœ¨å‡ ä¸ªåœ°æ–¹ï¼Œå‡ æ¬¡ï¼Œå®ƒä»¬éƒ½æ˜¯ç”¨çš„åŒä¸€ä¸ªæ•°æ®ã€‚ é™¤énewä¸€ä¸ªæ–°çš„Stringã€‚ 123456789101112public class StringTest &#123; public static void main(String[] args) &#123; String s1 = \"abcd\"; String s2 = \"abcd\"; String s3 = new String(\"abcd\"); String s4 = new String(\"abcd\"); System.out.println(\"ä¸¤ä¸ªå¸¸é‡èµ‹å€¼\\t s1==s2:\" + (s1 == s2)); System.out.println(\"å¸¸é‡ä¸æ–°å¯¹è±¡\\t s1==s3:\" + (s1 == s3)); System.out.println(\"ä¸¤ä¸ªæ–°å¯¹è±¡\\t s3==s4:\" + (s3 == s4)); &#125;&#125; è¾“å‡º 123ä¸¤ä¸ªå¸¸é‡èµ‹å€¼ s1==s2:trueå¸¸é‡ä¸æ–°å¯¹è±¡ s1==s3:falseä¸¤ä¸ªæ–°å¯¹è±¡ s3==s4:false åˆ©ç”¨åå°„ä¿®æ”¹å€¼ä¸Šé¢çš„ä»£ç åé¢å†åŠ ç‚¹ä¸œè¥¿ï¼Œå°è¯•ä¿®æ”¹s1çš„å€¼ã€‚ 123456789101112131415161718192021222324252627282930313233public class StringTest &#123; public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException &#123; String s1 = \"abcd\"; String s2 = \"abcd\"; String s3 = new String(\"abcd\"); String s4 = new String(\"abcd\"); System.out.println(\"ä¸¤ä¸ªå¸¸é‡èµ‹å€¼\\t s1==s2:\" + (s1 == s2)); System.out.println(\"å¸¸é‡ä¸æ–°å¯¹è±¡\\t s1==s3:\" + (s1 == s3)); System.out.println(\"ä¸¤ä¸ªæ–°å¯¹è±¡\\t s3==s4:\" + (s3 == s4)); // é€šè¿‡åå°„å¾—åˆ°è¢«Stringè—èµ·æ¥çš„valueå­—æ®µ Field f = String.class.getDeclaredField(\"value\"); // è®©å®ƒæ•å¼€å¿ƒæ‰‰ f.setAccessible(true); // è·å–s1çš„å†…éƒ¨valueæ•°ç»„ char[] v = (char[]) f.get(s1); // æ”¹æ‰å®ƒç¬¬ä¸€ä¸ªå­—æ¯ v[0] = 'x'; System.out.println(\"æ”¹å˜è¿‡å...\"); System.out.println(\"s1 = \" + s1); System.out.println(\"s2 = \" + s2); System.out.println(\"s3 = \" + s3); System.out.println(\"s4 = \" + s4); System.out.println(\"ä¸¤ä¸ªå¸¸é‡èµ‹å€¼\\t s1==s2:\" + (s1 == s2)); System.out.println(\"å¸¸é‡ä¸æ–°å¯¹è±¡\\t s1==s3:\" + (s1 == s3)); System.out.println(\"ä¸¤ä¸ªæ–°å¯¹è±¡\\t s3==s4:\" + (s3 == s4)); &#125;&#125; è¾“å‡º 1234567891011ä¸¤ä¸ªå¸¸é‡èµ‹å€¼ s1==s2:trueå¸¸é‡ä¸æ–°å¯¹è±¡ s1==s3:falseä¸¤ä¸ªæ–°å¯¹è±¡ s3==s4:falseæ”¹å˜è¿‡å...s1 = xbcds2 = xbcds3 = xbcds4 = xbcdä¸¤ä¸ªå¸¸é‡èµ‹å€¼ s1==s2:trueå¸¸é‡ä¸æ–°å¯¹è±¡ s1==s3:falseä¸¤ä¸ªæ–°å¯¹è±¡ s3==s4:false æ€»ç»“1ã€Stringå†…éƒ¨çš„valueé€šè¿‡åå°„çœŸçš„å¯ä»¥æ”¹å˜2ã€ç›´æ¥æ”¹åŠ¨valueä¼šå¯¼è‡´å…¶å®ƒç›¸åŒå€¼çš„Stringå¯¹è±¡ä¹Ÿè¢«æ”¹å˜ï¼ˆæ‰€ä»¥å¯ä»¥çŒœæµ‹åº•å±‚å®é™…ä¸Šç”¨çš„åŒä¸€ä»½æ•°æ®ï¼Ÿï¼‰3ã€è™½ç„¶å€¼éƒ½æ”¹å˜äº†ï¼Œä½†ä½œä¸ºå¯¹è±¡ï¼Œ4ä¸ªå˜é‡çš„å…³ç³»ä¾ç„¶æ²¡æœ‰æ”¹å˜ï¼ˆnewçš„ä¸¤ä¸ªStringå’Œå…¶ä»–ä¸¤ä¸ªä¾ç„¶ä¸ç­‰ï¼‰4ã€è¿™æ ·åšå¾ˆå±é™©5ã€è¿™æ ·åšå¾ˆæ— èŠ","categories":[{"name":"JAVA","slug":"JAVA","permalink":"https://acupt.github.io/categories/JAVA/"}],"tags":[{"name":"java","slug":"java","permalink":"https://acupt.github.io/tags/java/"}],"keywords":[{"name":"JAVA","slug":"JAVA","permalink":"https://acupt.github.io/categories/JAVA/"}]},{"title":"CPUå ç”¨é«˜å¦‚ä½•æ’æŸ¥","slug":"interview-cup-thread","date":"2019-07-17T14:30:00.000Z","updated":"2019-07-17T14:59:39.306Z","comments":true,"path":"2019/07/17/interview-cup-thread/","link":"","permalink":"https://acupt.github.io/2019/07/17/interview-cup-thread/","excerpt":"","text":"ç¨‹åºé‡Œå°‘ä¸äº†è¿ç®—ï¼Œå¦‚æœä¸æ˜¯ç¯å¢ƒå¤ªæ¶åŠ£ï¼ŒCPUåŸºæœ¬æ˜¯èƒ½æ”¯æ’‘åº”ç”¨è¿è¡Œçš„ã€‚ä½†å¦‚æœå‘ç°CPUå±…é«˜ä¸ä¸‹ï¼Œå°±éœ€è¦æ€è€ƒæ˜¯å¦ç¨‹åºæœ‰é—®é¢˜ã€‚ å½“æœåŠ¡å™¨CPUå±…é«˜ä¸ä¸‹ï¼Œå¯ä»¥ä»ä¸‹é¢å‡ ä¸ªæ–¹é¢å…¥æ‰‹å®šä½é—®é¢˜ã€‚ æ‰¾åˆ°JAVAè¿›ç¨‹ pidæ–¹æ³•ä¸€: jpsé‚£ä¸ªjarå°±æ˜¯æˆ‘çš„ä¸€ä¸ªjavaç¨‹åº 123456[root@iZba13i1mo82ot7a3lhq5oZ ~]# jps17616 Jps26016 jar9353 Bootstrap26028 Bootstrap16812 Bootstrap æ–¹æ³•äºŒ: ps -ef|grep åº”ç”¨å…³é”®è¯å’Œæ–¹æ³•ä¸€æ‰¾åˆ°çš„pidæ˜¯ç›¸åŒçš„ï¼Œ26016 123[root@iZba13i1mo82ot7a3lhq5oZ ~]# ps -ef|grep acupjavaroot 17638 17550 0 22:34 pts/0 00:00:00 grep --color=auto acupjavaroot 26016 1 0 7æœˆ08 ? 00:05:11 java -jar acupjava-1.0-SNAPSHOT.jar æ‰¾åˆ°è¿›ç¨‹ä¸­CPUé«˜çš„çº¿ç¨‹ tidæ‰“å°å‡ºçº¿ç¨‹çº¿ç¨‹åŸºæœ¬ä¿¡æ¯ï¼Œæ‰¾åˆ°cpuç™¾åˆ†æ¯”é«˜çš„ä¸€ä¸ªæˆ–å‡ ä¸ªçº¿ç¨‹ï¼Œè®°ä½å®ƒä»¬çš„tidã€‚ PSï¼šæ —å­è´¨é‡ä¸å¥½ï¼Œå…¨æ˜¯0.0%ï¼Œä¸è¦åœ¨æ„~ 123456789[root@iZba13i1mo82ot7a3lhq5oZ ~]# ps -mp 26016 -o THREAD,tid,timeUSER %CPU PRI SCNT WCHAN USER SYSTEM TID TIMEroot 0.0 - - - - - - 00:05:11root 0.0 19 - futex_ - - 26016 00:00:00root 0.0 19 - futex_ - - 26017 00:00:02root 0.0 19 - futex_ - - 26018 00:00:00root 0.0 19 - futex_ - - 26019 00:00:00root 0.0 19 - futex_ - - 26020 00:00:11(ç•¥...) æ‰“å°çº¿ç¨‹æ ˆé€‰æ‹©ä¸€ä¸ªçº¿ç¨‹ï¼ŒæŠŠtidä»10è¿›åˆ¶è½¬ä¸º16è¿›åˆ¶ 12[root@iZba13i1mo82ot7a3lhq5oZ ~]# printf \"%x\\n\" 2601765a1 ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹å¯ä»¥æŠŠçº¿ç¨‹æ ˆæ‰“å°åˆ°æ–‡ä»¶é‡Œï¼Œjstack pid &gt;&gt; æ–‡ä»¶å ä½¿ç”¨lsæŸ¥çœ‹æ–‡ä»¶å·²ç»å­˜åœ¨ 123[root@iZba13i1mo82ot7a3lhq5oZ ~]# jstack 26016 &gt;&gt; stack.txt[root@iZba13i1mo82ot7a3lhq5oZ ~]# lstest stack.txt æ‰¾åˆ°å ç”¨CPUé«˜çš„çº¿ç¨‹æ‰“å¼€æ–‡ä»¶ï¼Œæœç´¢tidæ‰€åœ¨ä½ç½®ï¼Œå¯ä»¥çœ‹åˆ°çº¿ç¨‹æ ˆï¼Œç”±æ­¤åˆ†æå®šä½å¯èƒ½æœ‰é—®é¢˜çš„ä»£ç ã€‚ 12345\"http-nio-9527-AsyncTimeout\" #29 daemon prio=5 os_prio=0 tid=0x00007fbf68973800 nid=0x65a1 waiting on condition [0x00007fbf48ab0000] java.lang.Thread.State: TIMED_WAITING (sleeping) at java.lang.Thread.sleep(Native Method) at org.apache.coyote.AbstractProtocol$AsyncTimeout.run(AbstractProtocol.java:1200) at java.lang.Thread.run(Thread.java:748) å¦‚æ­¤è¿™èˆ¬ï¼ŒCPUé«˜çš„é—®é¢˜åŸºæœ¬å°±èƒ½å®šä½å‡ºæ¥äº†ã€‚ï¼ˆPS: ä»¥ä¸Šæ•°æ®åšäº†äº›è®¸è„±æ•å¤„ç†ï¼‰","categories":[{"name":"é¢è¯•æ‚è°ˆ","slug":"é¢è¯•æ‚è°ˆ","permalink":"https://acupt.github.io/categories/é¢è¯•æ‚è°ˆ/"}],"tags":[{"name":"cpu","slug":"cpu","permalink":"https://acupt.github.io/tags/cpu/"}],"keywords":[{"name":"é¢è¯•æ‚è°ˆ","slug":"é¢è¯•æ‚è°ˆ","permalink":"https://acupt.github.io/categories/é¢è¯•æ‚è°ˆ/"}]},{"title":"å†…å­˜æ³„æ¼å¦‚ä½•æ’æŸ¥","slug":"interview-oom-check","date":"2019-07-16T13:45:00.000Z","updated":"2019-07-16T15:00:32.013Z","comments":true,"path":"2019/07/16/interview-oom-check/","link":"","permalink":"https://acupt.github.io/2019/07/16/interview-oom-check/","excerpt":"","text":"JAVAçš„åƒåœ¾å›æ”¶æœºåˆ¶ç»™äº†ç¨‹åºçŒ¿ä¾¿åˆ©ï¼Œæˆ‘ä»¬å¯ä»¥ä¸éœ€è¦æ˜¾å¼é‡Šæ”¾èµ„æºã€‚ä½†æƒ³é«˜æ•æ— å¿§å´æ˜¯ä¸èƒ½ï¼ŒOOMåƒä¸ªéšè—åœ¨æš—å¤„çš„å¹½(hua)çµ(nong)ï¼Œå¨èƒç€å¯æ€œã€å¼±å°åˆæ¼‚äº®çš„ç¨‹åºçŒ¿ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªå¥åº·çš„ç¨‹åºï¼Œå®ƒæ˜¯ä¸åº”è¯¥å‡ºç°OOMçš„ã€‚å†…å­˜é‡Œçš„å¯¹è±¡ä»ç”Ÿåˆ°æ­»ï¼Œäº•ç„¶æœ‰åºã€‚ä½†ç”±äºä¸€äº›äººä¸ºçš„å¤±è¯¯ï¼Œå¾€å¾€ä¼šè®©ä¸€äº›å¯¹è±¡é€ƒè¿‡GCçš„åˆ¶è£ï¼Œè·³å‡ºGCå¤–ï¼Œä¸åœ¨åƒåœ¾ä¸­ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå†…å­˜æ³„æ¼å°±å‘ç”Ÿäº†ã€‚ å†…å­˜æ³„éœ²ï¼Œæ˜¯æŒ‡ç¨‹åºåœ¨ç”³è¯·å†…å­˜å¹¶ä¸”ç”¨å®Œè¿™å—å†…å­˜åï¼ˆå¯¹è±¡ä¸å†éœ€è¦äº†ï¼‰ï¼Œæ²¡æœ‰é‡Šæ”¾å·²ç”³è¯·çš„å†…å­˜ç©ºé—´ã€‚å°‘æ•°å¶ç„¶çš„å†…å­˜æ³„æ¼ï¼Œè™½ç„¶ä¸å¤ªå¥½ï¼Œä½†é—®é¢˜ä¸å¤§ï¼Œæˆ‘ä»¬ä¹Ÿä¸è‡³äºå¯¹é‚£ç‚¹å†…å­˜æŠ æŠ æœæœçš„ã€‚ä½†å¦‚æœæ˜¯å†…å­˜ä¸æ–­æ³„æ¼ï¼Œç›´åˆ°æ–°çš„å¯¹è±¡æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ç”Ÿæˆï¼Œå°±ä¼šå¯¼è‡´OOMã€‚ ä»€ä¹ˆæ—¶å€™å¯èƒ½å†…å­˜æ³„æ¼æŠ›å‡ºOOMå¼‚å¸¸å½“ç¨‹åºæŠ›å‡ºOutOfMemoryErrorï¼Œå¦‚æœä½ è‡ªè®¤ä¸æ˜¯å¤ªæŠ ï¼Œç»™äº†è¿™ä¸ªç¨‹åºè¶³å¤Ÿçš„ç©ºé—´ï¼Œé‚£ä¹ˆå¯ä»¥æ€€ç–‘æœ‰å†…å­˜æ³„æ¼ å†…å­˜æŒç»­ä¸Šå‡ä¸€ä¸ªå¥åº·çš„ç¨‹åºåº”è¯¥æœ‰å¹³ç¨³çš„æ–°é™ˆä»£è°¢ï¼Œå†…å­˜å ç”¨åº”è¯¥ç»´æŒåœ¨ä¸€å®šèŒƒå›´ã€‚ä½†å¦‚æœå†…å­˜æŒç»­é£™å‡ï¼Œç”šè‡³åˆ°è¾¾äº†ä¸€ä¸ªå±é™©çš„å€¼ï¼Œé‚£ä¹ˆå¯ä»¥æ€€ç–‘æœ‰å†…å­˜æ³„æ¼ã€‚ æŸ¥çœ‹GCæƒ…å†µé¦–å…ˆè·å–åˆ°åº”ç”¨çš„pidï¼Œå¯ä»¥ä½¿ç”¨javaçš„jpså‘½ä»¤ï¼Œæˆ–è€…ps -ef|grep åº”ç”¨åå…³é”®è¯ 1234567891011121314151617/** * å¯åŠ¨ä¸ªåº”ç”¨ï¼ŒæŒç»­é€ å¯¹è±¡ */public class AcuptMain &#123; public static void main(String[] args) throws InterruptedException &#123; List&lt;Liangzai&gt; liangzais = new ArrayList&lt;&gt;(); while (true) &#123; liangzais.add(new Liangzai()); Thread.sleep(1000); &#125; &#125; private static class Liangzai &#123; byte[] body = new byte[1024 * 1024]; &#125;&#125; 1234567// æ‰§è¡Œå‘½ä»¤jpsæŸ¥çœ‹javaè¿›ç¨‹âœ ~ jps11617 Launcher11618 AcuptMain1353 RemoteMavenServer1322 11627 Jps 123// æ ¹æ®å…³é”®è¯æŸ¥çœ‹ï¼Œè¿›ç¨‹idä¸º 11618 ï¼Œå’ŒjpsæŸ¥åˆ°çš„ä¸€è‡´âœ ~ ps -ef|grep acupt 501 11618 1322 0 10:44ä¸‹åˆ ?? 0:00.39 /Library/Java/JavaVirtualMachines... 123456789101112131415# æŸ¥çœ‹gcæ€»ä½“æƒ…å†µï¼Œå„ä¸ªåŒºçš„ä½¿ç”¨ç‡å˜åŒ–ï¼Œ3ç§’æ›´æ–°ä¸€æ¬¡âœ ~ jstat -gcutil 11618 3000 S0 S1 E O M CCS YGC YGCT FGC FGCT GCT 0.00 0.00 56.20 0.00 17.39 19.90 0 0.000 0 0.000 0.000 0.00 0.00 60.89 0.00 17.39 19.90 0 0.000 0 0.000 0.000 0.00 0.00 65.58 0.00 17.39 19.90 0 0.000 0 0.000 0.000 0.00 0.00 70.26 0.00 17.39 19.90 0 0.000 0 0.000 0.000 0.00 0.00 74.95 0.00 17.39 19.90 0 0.000 0 0.000 0.000 0.00 0.00 79.64 0.00 17.39 19.90 0 0.000 0 0.000 0.000 0.00 0.00 84.33 0.00 17.39 19.90 0 0.000 0 0.000 0.000 0.00 0.00 89.01 0.00 17.39 19.90 0 0.000 0 0.000 0.000 0.00 0.00 93.70 0.00 17.39 19.90 0 0.000 0 0.000 0.000 0.00 0.00 98.39 0.00 17.39 19.90 0 0.000 0 0.000 0.000 0.00 98.48 5.02 26.91 79.14 82.73 1 0.021 0 0.000 0.021 (ä»¥ä¸‹ç•¥...) å¯ä»¥çœ‹åˆ°Eden(E)æŒç»­é€ å¯¹è±¡ï¼Œå¹¶ä¸”æ»¡äº†ä¹‹åï¼Œè€å¹´ä»£(O)å¢åŠ ï¼ŒEåŒºè…¾ç©ºåç»§ç»­é€ å¯¹è±¡ã€‚ï¼ˆç¨‹åºå¤šæ‰§è¡Œä¸€æ®µæ—¶é—´ï¼Œæˆ–è€…é€ å¯¹è±¡é€Ÿåº¦æå¿«ç‚¹ï¼Œæœ€ç»ˆä¼šæŠ›å‡ºOOMï¼‰ æŸ¥çœ‹å­˜æ´»å¯¹è±¡1234567891011121314// æŸ¥çœ‹å­˜æ´»å¯¹è±¡ï¼Œå¯ä»¥çœ‹åˆ°æ’åç¬¬ä¸€çš„æ˜¯byteæ•°ç»„ï¼Œè€Œä¸”å¤šè§‚å¯Ÿä¼šä¼šå‘ç°å…¶æ•°é‡ä¹Ÿæ˜¯ä¸€ç›´åœ¨å¢åŠ âœ ~ jmap -histo:live 11618 num #instances #bytes class name---------------------------------------------- 1: 644 103949616 [B 2: 4342 416736 [C 3: 4326 103824 java.lang.String 4: 721 82056 java.lang.Class 5: 746 49224 [Ljava.lang.Object; 6: 738 29520 java.util.LinkedHashMap$Entry 7: 609 19488 java.util.HashMap$Node 8: 303 19392 java.net.URL 9: 303 13560 [Ljava.lang.String; æ ¹æ®å­˜æ´»å¯¹è±¡çš„ä¸æ­£å¸¸å¢é•¿æƒ…å†µï¼Œåˆ†æç¨‹åºä¸­å“ªäº›åœ°æ–¹ç”¨åˆ°äº†è¿™ç§å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥å¤§è‡´æ¨æ–­å‡ºå¯èƒ½çš„å†…å­˜æ³„æ¼å¤„ã€‚","categories":[{"name":"é¢è¯•æ‚è°ˆ","slug":"é¢è¯•æ‚è°ˆ","permalink":"https://acupt.github.io/categories/é¢è¯•æ‚è°ˆ/"}],"tags":[{"name":"jvm","slug":"jvm","permalink":"https://acupt.github.io/tags/jvm/"},{"name":"oom","slug":"oom","permalink":"https://acupt.github.io/tags/oom/"}],"keywords":[{"name":"é¢è¯•æ‚è°ˆ","slug":"é¢è¯•æ‚è°ˆ","permalink":"https://acupt.github.io/categories/é¢è¯•æ‚è°ˆ/"}]},{"title":"JAVA GC ç®€æ","slug":"interview-gc","date":"2019-07-15T15:00:00.000Z","updated":"2019-07-16T13:47:33.758Z","comments":true,"path":"2019/07/15/interview-gc/","link":"","permalink":"https://acupt.github.io/2019/07/15/interview-gc/","excerpt":"","text":"ä½œä¸ºä¸€ä¸ªè½é­„çš„JAVAå¼€å‘ï¼Œåœ¨é¢è¯•ä¸­å¸¸è¢«é—®é“ï¼šä½ æ˜¯ä»€ä¹ˆåƒåœ¾ï¼Ÿå“¦ä¸ï¼Œæ˜¯ä½ å¯¹JAVAçš„åƒåœ¾å›æ”¶æœºåˆ¶æœ‰äº†è§£å—ï¼Ÿ æ¥ä¸‹æ¥å°±å¯¹GCåšä¸€ä¸ªå…¨æ–¹ä½çš„æ€»ç»“ï¼Œå¸Œæœ›ä¸‹æ¬¡å¯ä»¥è‡ªä¿¡åœ°å›ç­”é¢è¯•å®˜ï¼šæˆ‘æ˜¯å¯ä»¥è¢«è´µå…¬å¸å›æ”¶çš„é‚£ç§ã€‚ GCçš„æ—¶æœºé¦–å…ˆï¼Œæ ¹æ®å†…å­˜åŒºåŸŸä¸åŒï¼ŒJVMå·¥ä½œæ¨¡å¼ä¸åŒï¼ŒGCä¹Ÿæœ‰ä¸€äº›å·®åˆ«ã€‚ æ–°ç”Ÿä»£ï¼ˆminor GC/young GCï¼‰ PS: æ–°ç”Ÿä»£çš„å†…å­˜ç©ºé—´å¯åˆ†ä¸º3ä¸ªï¼ŒEdenåŒº(äº§ç”Ÿæ–°ç”Ÿå‘½çš„ä¼Šç”¸å›­)ï¼ŒfromåŒºå’ŒtoåŒºï¼ˆGCæ—¶å€’è…¾å¯¹è±¡ç”¨çš„ä¸¤ä¸ªç›˜å­ï¼‰ å½“JVMæ— æ³•ä¸ºä¸€ä¸ªæ–°çš„å¯¹è±¡åˆ†é…ç©ºé—´æ—¶ä¼šè§¦å‘ Minor GCï¼Œæ¯”å¦‚å½“ Eden åŒºæ»¡äº†ã€‚æ‰€ä»¥å¦‚æœç¨‹åºç–¯ç‹‚é€ å¯¹è±¡ï¼Œå°±ä¼šé¢‘ç¹è§¦å‘GCã€‚ è€å¹´ä»£/æ°¸ä¹…ä»£ï¼ˆmajor GCï¼‰/æ•´ä¸ªå †ï¼ˆfull GCï¼‰ å½“ä¸€ä¸ªå¯¹è±¡ç»å†äº†å¤ªå¤šGCè€Œä¸æ­»ï¼Œå®ƒä¼šçªç ´æ—§è§„åˆ™çš„æŸç¼šï¼Œé£å‡åˆ°è€å¹´ä»£/æ°¸ä¹…ä»£ï¼Œæˆä¸ºæ–°çš„å­˜åœ¨ï¼Œä½†å¹¶ä¸ä»£è¡¨ç€å®ƒå¯ä»¥ä¸æ­»ï¼Œæ²¡æœ‰è°å¯ä»¥ä¸æ­»ï¼Œå°¤å…¶æ˜¯æ–°çš„åœ°æ–¹ä¹Ÿç¼ºå°‘èµ„æºçš„æ—¶å€™ã€‚è€ŒMajor GCé€šå¸¸æ˜¯è·Ÿfull GCæ˜¯ç­‰ä»·çš„ï¼Œæ”¶é›†æ•´ä¸ªGCå †ã€‚ å‡åˆ°æ°¸ä¹…ä»£çš„å¯¹è±¡å¤§äºæ°¸ä¹…ä»£å‰©ä½™ç©ºé—´full gcï¼Œæˆ–è€…å°äºæ—¶è¢«HandlePromotionFailureå‚æ•°å¼ºåˆ¶full gcã€‚ å…¶å®ƒGCæ—¶æœºï¼š åœ¨ç¨‹åºä¸­è°ƒç”¨System.gc()å‡½æ•°ï¼Œå»ºè®®JVMåšGCï¼ˆæ³¨æ„åªæ˜¯å»ºè®®ï¼ŒJVMæœ‰æƒæ— è§†ç¨‹åºçŒ¿çš„å»ºè®®ï¼‰ è°ƒå‚æ§åˆ¶è¿›å…¥è€å¹´ä»£/æ°¸ä¹…ä»£çš„å¹´é¾„ï¼ˆå¦‚æœæˆ‘è®°å¾—è‚¯å®šä¼šå†™å‡ºæ¥çš„ï¼Œæ²¡æœï¼Œæ‡’å¾—æœï¼‰ OOMä¹‹å‰ï¼ˆåœ¨æ”¾å¼ƒæ²»ç–—æŠ›å‡ºå¼‚å¸¸å‰æ€»è¦åšæœ€åçš„åŠªåŠ›å§ï¼‰ GCçš„ç›®æ ‡ - ä¸ä½¿ç”¨çš„å¯¹è±¡ å½“ç„¶æ˜¯ä¸ä½¿ç”¨çš„å¯¹è±¡ï¼Œè¿˜åœ¨ä½¿ç”¨çš„å¯¹è±¡ç»™å›æ”¶äº†è°çŸ¥é“ç¨‹åºä¼šè·‘æˆä»€ä¹ˆæ ·å­ é‚£ä¹ˆä»€ä¹ˆæ˜¯ä¸ä½¿ç”¨çš„å¯¹è±¡å‘¢ï¼Ÿ è¶…å‡ºä½œç”¨åŸŸçš„å¯¹è±¡/å¼•ç”¨è®¡æ•°ä¸ºç©º å¼•ç”¨è®¡æ•°æ³•: æœ‰äººå¼•ç”¨+1ï¼Œè¢«äººæŠ›å¼ƒ-1ã€‚ ä¼˜ç‚¹ï¼šä¸€æ—¦æ²¡æœ‰å¼•ç”¨å³å¯é‡Šæ”¾å†…å­˜ï¼Œä¸éœ€è¦ç­‰å¾…ç‰¹å®šæ—¶æœºï¼Œå›æ”¶çš„æ—¶æœºä¹Ÿæ¯”è¾ƒå¹³å‡ã€‚ ç¼ºç‚¹ï¼šç»´æŠ¤è®¡æ•°æ¶ˆè€—èµ„æºï¼ˆä½†é—®é¢˜ä¸å¤§ï¼‰ï¼Œå¾ªç¯å¼•ç”¨ï¼ˆå¤§ï¼‰ å¯è¾¾æ€§åˆ†æï¼Œæœ‰gc rootæ— æ³•åˆ°è¾¾çš„å¯¹è±¡ é€šè¿‡ä¸€ç³»åˆ—ç§°ä¸ºâ€GC Rootsâ€çš„å¯¹è±¡ä½œä¸ºèµ·å§‹ç‚¹ï¼Œä»è¿™äº›èŠ‚ç‚¹å¼€å§‹å‘ä¸‹æœç´¢ï¼Œæ— æ³•åˆ°è¾¾çš„å¯¹è±¡å°±æ˜¯æ²¡ç”¨çš„ã€‚å¯ä»¥è¢«å½“åšrootçš„å¯¹è±¡ï¼Œå¦‚ï¼šçº¿ç¨‹å¯¹è±¡ã€æœ¬åœ°å˜é‡ã€å…¨å±€å˜é‡ç­‰ã€‚ è¿™é‡Œåˆå¼•å…¥äº†å¼•ç”¨çš„æ¦‚å¿µï¼Œå¼ºåº¦ä»å¼ºåˆ°å¼±ä¾æ¬¡å¦‚ä¸‹ï¼š å¼ºå¼•ç”¨ï¼šæœ€å¸¸è§çš„å¦‚ Object a = new Object()ï¼Œå³ä½¿OOMä¹Ÿä¸å›æ”¶ è½¯å¼•ç”¨ï¼ˆSoftReferenceï¼‰ï¼šå†…å­˜ä¸å¤Ÿæ—¶å›æ”¶ å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰ï¼šæ­£å¸¸gcï¼Œè¢«æ‰«æåˆ°å°±å›æ”¶ å¹»æƒ³å¼•ç”¨ï¼ˆPhantomReferenceï¼‰ï¼šä¸å¯ä»¥è·å–/å¤æ´»å¯¹è±¡, åœ¨åƒåœ¾å›æ”¶æ—¶å¾—åˆ°é€šçŸ¥ GCçš„è¡Œä¸ºç®€å•çš„è¯´å°±æ˜¯åˆ é™¤å¯¹è±¡ï¼Œå›æ”¶ç©ºé—´ã€‚æ ¹æ®ç®—æ³•ä¸åŒï¼Œå…·ä½“çš„è¡Œä¸ºä¹Ÿæœ‰æ‰€ä¸åŒï¼Œå¿«æ²¡ç”µäº†ï¼Œå°±ä¸å†™äº†ï¼ˆä¸»è¦ä¹Ÿæ²¡å‡†å¤‡ï¼‰ ä¸¾ä¸ªæ —å­ï¼š 1ã€åœæ­¢å…¶ä»–çº¿ç¨‹ï¼Œæ ‡è®°å¯¹è±¡2ã€æ¸…ç†å¯¹è±¡2.1ã€æ–°ç”Ÿä»£-å¤åˆ¶æ¸…ç†ï¼š Edenå’Œfromçš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°toï¼Œç„¶åfromå’Œtoäº¤æ¢ï¼Œå­˜æ´»å¯¹è±¡å¹´é¾„+1ï¼Œå¹´é¾„åˆ°è¾¾é˜ˆå€¼è¿›å…¥è€å¹´ä»£/æ°¸ä¹…ä»£2.2ã€è€å¹´ä»£-æ ‡è®°æ¸…ç†/æ•´ç†ï¼š æ ‡è®°æ¸…ç†é€Ÿåº¦å¿«ï¼Œä½†æœ‰å†…å­˜ç¢ç‰‡ æ ‡è®°æ•´ç†ä¼šç§»åŠ¨å­˜æ´»å¯¹è±¡ï¼Œæ’é™¤å†…å­˜ç¢ç‰‡","categories":[{"name":"é¢è¯•æ‚è°ˆ","slug":"é¢è¯•æ‚è°ˆ","permalink":"https://acupt.github.io/categories/é¢è¯•æ‚è°ˆ/"}],"tags":[{"name":"jvm","slug":"jvm","permalink":"https://acupt.github.io/tags/jvm/"},{"name":"gc","slug":"gc","permalink":"https://acupt.github.io/tags/gc/"}],"keywords":[{"name":"é¢è¯•æ‚è°ˆ","slug":"é¢è¯•æ‚è°ˆ","permalink":"https://acupt.github.io/categories/é¢è¯•æ‚è°ˆ/"}]},{"title":"ä»0.5åˆ°1å†™ä¸ªrpcæ¡†æ¶ - 7:ç½‘å…³æ”¯æŒ(gateway)","slug":"acuprpc-7","date":"2019-07-13T08:15:00.000Z","updated":"2019-07-13T08:39:29.148Z","comments":true,"path":"2019/07/13/acuprpc-7/","link":"","permalink":"https://acupt.github.io/2019/07/13/acuprpc-7/","excerpt":"","text":"è¿™ä¸æ˜¯æ•™ç¨‹ï¼Œåªæ˜¯ä¸ªäººæ€»ç»“ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯ä»¥æ­é…æºç çœ‹çœ‹ï¼šacuprpc å¾®æœåŠ¡é™¤äº†åœ¨å†…éƒ¨ç›¸äº’è°ƒç”¨ï¼Œæœ‰æ—¶æŸäº›æœåŠ¡ä¹Ÿä¼šæä¾›ç»™å¤–éƒ¨åº”ç”¨ã€‚å½“ç„¶ä¸èƒ½è®©å¤–éƒ¨åº”ç”¨ä¹ŸåŠ å…¥åˆ°â€œå¤§å®¶åº­â€é‡Œï¼Œæ¯•ç«ŸçŸ¥äººçŸ¥é¢ä¸çŸ¥æºç ï¼Œæˆ‘ä»¬å¯ä»¥æ´¾å‡ºä¸€ä¸ªâ€œå‰å°â€å»æ¥å¾…å®ƒä»¬ï¼Œè¿™å°±æ˜¯â€œç½‘å…³â€ã€‚ ç½‘å…³è´Ÿè´£å¯¹æ¥å¤–éƒ¨æ¥å®¾ï¼Œå› æ­¤è¦åšå¥½å®‰å…¨æªæ–½ï¼Œä»€ä¹ˆç™»é™†ã€æƒé™è¯¥ä¸Šå°±ä¸Šã€‚ æµç¨‹å¦‚ä¸‹ï¼š ç½‘å…³æ”¶åˆ°è¯·æ±‚ è§£æè¯·æ±‚ï¼ˆæœåŠ¡åï¼Œæ–¹æ³•ï¼Œå‚æ•°ç­‰ï¼‰ é€‰æ‹©ä¸€ä¸ªå®ä¾‹ï¼ˆæ¥è‡ªæ³¨å†Œä¸­å¿ƒï¼‰ RPCè°ƒç”¨ ç»“æœè¿”å›ç»™è¯·æ±‚æ–¹ 1234567891011121314151617181920212223242526@RestController@RequestMapping(\"/api\")public class ApiController &#123; /** * åŠ¨æ€è°ƒç”¨rpcæœåŠ¡çš„å…³é”®ï¼Œåœ¨acuprpc-spring-boot-starterä¸­å·²ç»ç”Ÿæˆï¼Œå¯ä»¥éšæ—¶å¼•ç”¨ */ private RpcClientManager rpcClientManager; public ApiController(RpcClientManager rpcClientManager) &#123; this.rpcClientManager = rpcClientManager; &#125; @RequestMapping(method = RequestMethod.POST, produces = \"application/json\") public Object invoke(@RequestBody RpcRequestDTO requestDTO) &#123; RpcServiceInfo serviceInfo = new RpcServiceInfo(requestDTO.getApp(), requestDTO.getService()); RpcClient client = rpcClientManager.lookup(serviceInfo);//è·å–ä¸€ä¸ªå¯ä»¥æä¾›æ‰€éœ€æœåŠ¡çš„è¿æ¥ RpcRequest request = new RpcRequest(requestDTO.getApp(), requestDTO.getService(), requestDTO.getMethod()); if (requestDTO.getParameters() != null) &#123; Map&lt;String, String&gt; map = new HashMap&lt;&gt;(); requestDTO.getParameters().forEach((k, v) -&gt; map.put(k, JsonUtil.toJson(v))); request.setNamedParameter(map); &#125; return client.invoke(request);//è°ƒç”¨æœåŠ¡è·å¾—è¿”å›çš„jsonå­—ç¬¦ä¸² &#125;&#125; è¿™ä¸ªdemoä½œä¸ºä¸€ä¸ªå­æ¨¡å—ï¼ˆacuprpc-spring-boot-starter-gatewayï¼‰åŠ å…¥äº†æ¡†æ¶çš„å…¨å®¶æ¡¶ï¼Œç›´æ¥å¼•å…¥ä¾èµ–å°±èƒ½ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ã€‚ åŸºäºè¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥å®ç°æ›´åŠ å¤æ‚çš„ä¹Ÿæ— éœ€æ±‚ï¼Œè¿™é‡Œå°±ä¸ç»†è®²äº†ï¼Œæœ¬ç³»åˆ—ç»“æŸã€‚","categories":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}],"tags":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/tags/å¾®æœåŠ¡/"},{"name":"eureka","slug":"eureka","permalink":"https://acupt.github.io/tags/eureka/"}],"keywords":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}]},{"title":"ä»0.5åˆ°1å†™ä¸ªrpcæ¡†æ¶ - 6:è°ƒç”¨å¼‚å¸¸èŠ‚ç‚¹è‡ªåŠ¨é‡è¯•","slug":"acuprpc-6","date":"2019-07-13T07:00:00.000Z","updated":"2019-07-13T08:16:36.330Z","comments":true,"path":"2019/07/13/acuprpc-6/","link":"","permalink":"https://acupt.github.io/2019/07/13/acuprpc-6/","excerpt":"","text":"è¿™ä¸æ˜¯æ•™ç¨‹ï¼Œåªæ˜¯ä¸ªäººæ€»ç»“ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯ä»¥æ­é…æºç çœ‹çœ‹ï¼šacuprpc eureka clientæ¯éš”30så‘æ³¨å†Œä¸­å¿ƒå‘é€å¿ƒè·³æ¥ç»™è‡ªå·±ç»­å‘½ï¼Œå½“æ³¨å†Œä¸­å¿ƒé•¿æ—¶é—´æ²¡æ”¶åˆ°clientçš„ä¿¡å·ï¼Œå°±ä¼šè®¤ä¸ºå®ƒæŒ‚æ‰äº†ï¼ŒæŠŠå®ƒæå‡ºç¾¤èŠã€‚å†åŠ ä¸Šå…¶å®ƒæœåŠ¡ä¹ŸæŒ‰ç…§ä¸€å®šé¢‘ç‡æ›´æ–°æœ¬åœ°ç¼“å­˜ï¼Œå› æ­¤å¾€å¾€ä¸ä¼šé‚£ä¹ˆåŠæ—¶åœ°å‘ç°æ›¾ç»çš„å°ä¼™ä¼´å·²ç»ä¸‹çº¿äº†ã€‚å¯¼è‡´çš„åæœå°±æ˜¯ï¼Œä¼šå‘ä¸å†å­˜åœ¨çš„èŠ‚ç‚¹å‘é€è¯·æ±‚ï¼Œç»“æœè¿æ¥å¼‚å¸¸ã€‚ å¯¹æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä»æ¡†æ¶å±‚é¢åŠ å…¥ä¸€ä¸ªé‡è¯•æœºåˆ¶ï¼Œspringé‡Œé¢ç±»ä¼¼çš„æœºåˆ¶ä¹Ÿæœ‰ï¼Œä½†æ—¢ç„¶åœ¨å†™è‡ªå·±çš„æ¡†æ¶ï¼Œé‚£å°±è‡ªå·±å®ç°ä¸€ä¸ªã€‚ åœ¨ç¬¬ä¸€ç« é‡Œå·²ç»å®ç°äº†é€šè¿‡åŠ¨æ€ä»£ç†æ‰§è¡Œè¿œç¨‹è°ƒç”¨ï¼Œé‚£ä¹ˆç›´æ¥ä»è¿™é‡Œå…¥æ‰‹ï¼Œé€šè¿‡åˆ¤æ–­æ•è·çš„å¼‚å¸¸æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657@Override public Object invoke(Object proxy, Method method, Object[] args) &#123; if (\"toString\".equals(method.getName()) &amp;&amp; (args == null || args.length == 0)) &#123; return rpcServiceInfo.toString();//debugæ—¶è€æ˜¯è¢«ideè°ƒç”¨ç„¶åæŠ›å¼‚å¸¸ï¼Œå¾ˆçƒ¦ &#125; RpcRequest rpcRequest = new RpcRequest(rpcServiceInfo.getAppName(), rpcServiceInfo.getServiceName(), method.getName()); if (args != null &amp;&amp; args.length &gt; 0) &#123; rpcRequest.setOrderedParameter(Arrays.stream(args).map(JsonUtil::toJson).collect(Collectors.toList())); &#125; int n = 3; // æœ€å¤šé‡è¯•3æ¬¡ï¼Œæ”¹æˆå¯é…ç½®çš„æ›´å¥½ int i = 0; RpcClient client = null; while (i++ &lt; n) &#123; try &#123; client = getRpcClient(); String res = client.invoke(rpcRequest); return JsonUtil.fromJson(res, TypeFactory.defaultInstance().constructType(method.getGenericReturnType())); &#125; catch (Exception e) &#123; if (client == null) &#123; throw e; &#125; boolean rediscover = needRediscover(e) &amp;&amp; i &lt; n; log.error(\"invoke &#123;&#125;/&#123;&#125; &#123;&#125; &#123;&#125; error=&#123;&#125; msg=&#123;&#125; rediscover=&#123;&#125;\", i, n, rpcRequest.getKey(), client.getNodeInfo(), e.getClass().getName(), e.getMessage(), rediscover); if (rediscover) &#123; try &#123; NodeInfo nodeInfo = rpcClientManager.selectNode(rpcServiceInfo, client.getNodeInfo()); client.reconnect(nodeInfo); continue; &#125; catch (RpcNotFoundException e1) &#123; e.addSuppressed(e1); &#125; &#125; throw e; &#125; &#125; throw new RuntimeException(\"invoke error\"); &#125; /** * æ ¹æ®å¼‚å¸¸ç±»å‹åˆ¤æ–­æ˜¯å¦éœ€è¦æ¢ä¸ªå®ä¾‹ */ private boolean needRediscover(Throwable e) &#123; while (e != null) &#123; if (e instanceof HttpStatusException) &#123; // æˆ‘è‡ªå®šä¹‰çš„å¼‚å¸¸ç±»å‹ï¼Œè¿™é‡Œå¦‚æœæ˜¯æœåŠ¡ä¸å¯ç”¨ï¼ˆç¨‹åºè™½ç„¶æ­£å¸¸ä½†ä¸å†æä¾›æœåŠ¡ï¼‰ if (((HttpStatusException) e).getStatus() == NOT_AVAILABLE) &#123; return true; &#125; &#125; else if (e instanceof ConnectException) &#123; // è¿æ¥å¼‚å¸¸ï¼Œæƒ³å¿…æ˜¯ä¸åœ¨äº† return true; &#125; e = e.getCause(); &#125; return false; &#125; æœ‰äº†é‡è¯•æœºåˆ¶ï¼Œå°±ä¸æ€•æŸäº›å®¶ä¼™çªç„¶æ‰é“¾å­äº†ï¼Œå½“ç„¶å¦‚æœå…¨éƒ¨æ‰é“¾å­é‚£å°±æ²¡å¾—ç©äº†ã€‚","categories":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}],"tags":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/tags/å¾®æœåŠ¡/"},{"name":"eureka","slug":"eureka","permalink":"https://acupt.github.io/tags/eureka/"}],"keywords":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}]},{"title":"ä»0.5åˆ°1å†™ä¸ªrpcæ¡†æ¶ - 5:æœåŠ¡ç›‘æ§å’Œç®¡ç†(actuator)","slug":"acuprpc-5","date":"2018-11-29T06:00:00.000Z","updated":"2019-07-11T14:13:43.500Z","comments":true,"path":"2018/11/29/acuprpc-5/","link":"","permalink":"https://acupt.github.io/2018/11/29/acuprpc-5/","excerpt":"","text":"è¿™ä¸æ˜¯æ•™ç¨‹ï¼Œåªæ˜¯ä¸ªäººæ€»ç»“ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯ä»¥æ­é…æºç çœ‹çœ‹ï¼šacuprpc springbooté¡¹ç›®ä¸­åªè¦å¼•å…¥spring-boot-starter-actuatorå°±å¯ä»¥å¾—åˆ°ä¸€äº›ç®¡ç†æœåŠ¡çš„æ¥å£ï¼Œæ¯”å¦‚åœæ­¢æœåŠ¡ï¼Œè·å–æœåŠ¡ä¿¡æ¯ç­‰ã€‚ä»–ç”¨çš„å¹¶ä¸æ˜¯controllerï¼Œè€Œæ˜¯Endpointï¼Œä¸è¿‡ä¸»è¦åŠŸèƒ½å·®ä¸å¤šã€‚ å€Ÿä½ä¸ŠèŠ‚å®ç°çš„filteræœºåˆ¶ï¼Œå¯ä»¥åœ¨ä¸æ”¹åŠ¨æ¡†æ¶æ ¸å¿ƒä»£ç çš„åŸºç¡€ä¸Šå®ç°è¿™ä¸ªåŠŸèƒ½ã€‚ä½œä¸ºå®è·µå†™ä¸¤ä¸ªåŠŸèƒ½ï¼šè·å–æœåŠ¡ç«¯çš„ç»Ÿè®¡æ•°æ®ã€æœåŠ¡çŠ¶æ€æ§åˆ¶ æ–°å»ºæ¨¡å— acuprpc-spring-boot-starter-actuatorã€‚ ä¸ºäº†ç»Ÿä¸€ç®¡ç†è¿™ä¸ªæ¡†æ¶çš„endpointï¼Œå®šä¹‰ä¸€ä¸ªçˆ¶ç±»ã€‚æ‰€æœ‰å­ç±»çš„idé»˜è®¤åŠ ä¸Šâ€œrpcâ€å‰ç¼€ 12345678910111213public abstract class AbstractRpcEndpoint&lt;T&gt; extends AbstractEndpoint&lt;T&gt; &#123; private static final String PREFIX = \"rpc\"; public AbstractRpcEndpoint(String id) &#123; super(PREFIX + id); &#125; public AbstractRpcEndpoint(String id, boolean sensitive) &#123; super(PREFIX + id, sensitive); &#125; public AbstractRpcEndpoint(String id, boolean sensitive, boolean enabled) &#123; super(PREFIX + id, sensitive, enabled); &#125;&#125; æ•°æ®ç»Ÿè®¡MonitorFilterä½¿ç”¨filteræ‹¦æˆªè¯·æ±‚ï¼Œç»Ÿè®¡å¤„ç†è¯·æ±‚çš„æ•°é‡ã€‚ 12345678910111213141516171819202122232425262728293031323334@Getterpublic class MonitorFilter implements RpcFilter &#123; private Map&lt;String, RequestCount&gt; requestCountMap = new ConcurrentHashMap&lt;&gt;(); @Override public void doFilter(RpcRequest request, RpcResponse response, RpcFilterChain filterChain) &#123; RequestCount count = requestCountMap.computeIfAbsent(request.getKey(), RequestCount::new); count.received.increment(); count.invoking.increment(); try &#123; filterChain.doFilter(request, response); count.success.increment(); &#125; catch (Exception e) &#123; count.failed.increment(); throw e; &#125; finally &#123; count.invoking.decrement(); &#125; &#125; @Getter public static class RequestCount &#123; private String key; private LongAdder received = new LongAdder();//å·²æ¥æ”¶ private LongAdder invoking = new LongAdder();//æ‰§è¡Œä¸­ private LongAdder success = new LongAdder();//å¤„ç†æˆåŠŸ private LongAdder failed = new LongAdder();//å¤„ç†å¤±è´¥ public RequestCount(String key) &#123; this.key = key; &#125; &#125;&#125; RpcStatEndpointæä¾›httpæ¥å£ï¼Œé€šè¿‡ /rpcstat å³å¯è·å–invoke()çš„è¿”å›å€¼ã€‚ 1234567891011121314151617public class RpcStatEndpoint extends AbstractRpcEndpoint&lt;Map&lt;String, Object&gt;&gt; &#123; private MonitorFilter filter; public RpcStatEndpoint(MonitorFilter filter) &#123; super(\"stat\"); this.filter = filter; &#125; @Override public Map&lt;String, Object&gt; invoke() &#123; Map&lt;String, Object&gt; result = new HashMap&lt;&gt;(); Collection&lt;MonitorFilter.RequestCount&gt; counts = filter.getRequestCountMap().values(); result.put(\"counts\", counts); result.put(\"serving\", counts.stream().anyMatch(t -&gt; t.getInvoking().sum() &gt; 0L)); return result; &#125;&#125; æœåŠ¡ç®¡ç†RejectFilterä½¿ç”¨filteræ‹¦æˆªè¯·æ±‚ï¼Œå¹¶åœ¨filterä¸­ç»´æŠ¤ä¸€ä¸ªä¸‹çº¿çŠ¶æ€ï¼Œå¦‚æœä¸‹çº¿äº†åˆ™æ‹’ç»æ‰€æœ‰è¯·æ±‚ï¼ˆé’ˆå¯¹è¿™ç§è¿”å›å€¼ï¼Œå®¢æˆ·ç«¯å¯ä»¥é‡æ–°å‘ç°å…¶ä»–èŠ‚ç‚¹ï¼‰ã€‚ 123456789101112131415@Datapublic class RejectFilter implements RpcFilter &#123; private boolean reject = false; //æ‹’ç»è¯·æ±‚çš„å¤„ç†é€»è¾‘ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ private BiConsumer&lt;RpcRequest, RpcResponse&gt; rejectFunction = (rpcRequest, response) -&gt; response.reject(); @Override public void doFilter(RpcRequest request, RpcResponse response, RpcFilterChain filterChain) &#123; if (reject) &#123; rejectFunction.accept(request, response); return; &#125; filterChain.doFilter(request, response); &#125;&#125; EndpointMvcAdapterEndpointä½¿ç”¨å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯ç›¸å¯¹controllerä¸æ˜¯é‚£ä¹ˆçµæ´»ï¼Œæ¯”å¦‚æˆ‘è¦è®©æ¥å£æ”¯æŒå‚æ•°ï¼Œå°±éœ€è¦ä¸€äº›å…¶ä»–æ“ä½œï¼Œå°†Endpointä½¿ç”¨EndpointMvcAdapteråŒ…è£…ä¸€æ¬¡ã€‚ä¸ºäº†å¤ç”¨ï¼Œæˆ‘å†™äº†ä¸ªé€šç”¨çš„EndpointMvcAdapterï¼Œé€šè¿‡åå°„å»è°ƒç”¨å‚æ•°æŒ‡å®šçš„æ–¹æ³•ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738@Slf4jpublic class ReflectEndpointMvcAdapter extends EndpointMvcAdapter implements RpcCode &#123; private Map&lt;String, Method&gt; methodMap = new HashMap&lt;&gt;(); private Set&lt;String&gt; ipWhiteList = new HashSet&lt;&gt;(); public ReflectEndpointMvcAdapter(Endpoint&lt;?&gt; delegate, String ipWhiteList) &#123; super(delegate); Method[] methods = delegate.getClass().getMethods(); //... &#125; @RequestMapping(value = \"/&#123;name:.*&#125;\", method = RequestMethod.GET, produces = &#123; ActuatorMediaTypes.APPLICATION_ACTUATOR_V1_JSON_VALUE, MediaType.APPLICATION_JSON_VALUE &#125;) @ResponseBody @HypermediaDisabled public Object invoke(HttpServletRequest request, HttpServletResponse response, @PathVariable String name) &#123; if (!checkIp(request)) &#123; //... &#125; Method method = methodMap.get(name); //... try &#123; return method.invoke(getDelegate()); &#125; catch (Exception e) &#123; //... &#125; &#125; private boolean checkIp(HttpServletRequest request) &#123; //... &#125; private String getIp(HttpServletRequest request) &#123; //... &#125;&#125; RpcEndpointå› ä¸ºè¦ç”¨ReflectEndpointMvcAdapterï¼Œinvokeæ–¹æ³•æš‚æ—¶æ²¡æƒ³åˆ°ç”¨ä»€ä¹ˆï¼ˆ /rpc æ—¶è°ƒç”¨ï¼‰ï¼Œå°±è¿”å›nullã€‚ 1234567891011121314151617181920212223242526272829public class RpcEndpoint extends AbstractRpcEndpoint&lt;Object&gt; implements RpcCode &#123; private RejectFilter filter; public RpcEndpoint(RejectFilter filter) &#123; super(\"\"); this.filter = filter; &#125; @Override public Object invoke() &#123; return null; &#125; public void online() &#123; filter.setReject(false); &#125; public void offline() &#123; filter.setReject(true); &#125; public int status() &#123; if (filter.isReject()) &#123; throw new HttpStatusException(NOT_AVAILABLE); &#125; return 0; &#125;&#125; å®šä¹‰beanæ—¶åŒ…è£… 123456789@Beanpublic ReflectEndpointMvcAdapter rpcEndpoint(RejectFilter rejectFilter) &#123; return new ReflectEndpointMvcAdapter(process(new RpcEndpoint(rejectFilter)), ipWhiteList);&#125;private &lt;T extends AbstractRpcEndpoint&lt;?&gt;&gt; T process(T endpoint) &#123; endpoint.setSensitive(sensitive); return endpoint;&#125; ç°åœ¨åªè¦å¼•å…¥acuprpc-spring-boot-starter-actuatorå°±èƒ½å¾—åˆ°è¿™å‡ ä¸ªhttpæ¥å£äº†ï¼Œå€ŸåŠ©è¿™å‡ ä¸ªæ¥å£æœåŠ¡å¯ä»¥ä¼˜é›…åœ°é‡å‘ã€‚","categories":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}],"tags":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/tags/å¾®æœåŠ¡/"},{"name":"actuator","slug":"actuator","permalink":"https://acupt.github.io/tags/actuator/"}],"keywords":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}]},{"title":"ä»0.5åˆ°1å†™ä¸ªrpcæ¡†æ¶ - 4:request filter","slug":"acuprpc-4","date":"2018-11-29T05:00:00.000Z","updated":"2019-07-11T14:13:38.714Z","comments":true,"path":"2018/11/29/acuprpc-4/","link":"","permalink":"https://acupt.github.io/2018/11/29/acuprpc-4/","excerpt":"","text":"è¿™ä¸æ˜¯æ•™ç¨‹ï¼Œåªæ˜¯ä¸ªäººæ€»ç»“ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯ä»¥æ­é…æºç çœ‹çœ‹ï¼šacuprpc ä¸ºäº†åç»­æ‰©å±•æ–¹ä¾¿ï¼Œæä¸ªfilteræ”¯æŒï¼Œå°±æŠ„ä¸€ä¸ªservletçš„filterå§ã€‚ servlet filter åˆ†æåœ¨å†™mvcé¡¹ç›®æ—¶ï¼Œç»å¸¸ä¼šç”¨åˆ°filterï¼Œå¯ä»¥ç»™ä¸€ä¸ªè¯·æ±‚åšå‰ç½®æˆ–è€…åç½®å¤„ç†ã€‚å¦‚ä¸‹ï¼š 1234567891011121314151617181920@WebFilter(filterName = \"requestFilter\", urlPatterns = \"/*\")public class MyFilter implements Filter &#123; @Override public void init(FilterConfig filterConfig) throws ServletException &#123; System.out.println(\"filter init\"); &#125; @Override public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException &#123; System.out.println(\"æˆ‘è¿›æ¥äº†\"); chain.doFilter(request, response); System.out.println(\"æˆ‘è¦èµ°äº†\"); &#125; @Override public void destroy() &#123; System.out.println(\"filter destroy\"); &#125;&#125; è¿™æ˜¯ä¸€ç§è´£ä»»é“¾æ¨¡å¼çš„å®ç°ï¼Œdebugçœ‹ä¸‹è°ƒç”¨æ ˆå¯ä»¥äº†è§£æ¡†æ¶æ˜¯æ€ä¹ˆå®ç°çš„ã€‚ æ¯æ¬¡è¯·æ±‚ç”Ÿæˆä¸€ä¸ªFilterChainå¯¹è±¡ï¼Œå¹¶ä½¿å…¶æŒæœ‰æ‰€æœ‰filterçš„æ•°ç»„ï¼Œåˆå§‹åŒ–æˆå‘˜å˜é‡pos=0ï¼ˆè¡¨ç¤ºåº”è¯¥æ‰§è¡Œç¬¬å‡ ä¸ªfilterï¼‰ ä»FilterChain.doFilterå¼€å§‹è°ƒç”¨æ•´ä¸ªé“¾è·¯ï¼Œä»ç¬¬ä¸€ä¸ªfilterå¼€å§‹ï¼Œè°ƒç”¨æ—¶ä¼šæŠŠchainæœ¬èº«ä¼ ç»™filterï¼Œposè‡ªå¢ æŸä¸ªfilterå¦‚æœä¸æ‹¦æˆªè¿™ä¸ªè¯·æ±‚ï¼Œåˆ™è°ƒç”¨FilterChain.doFilterï¼Œç”±äºposå·²ç»è‡ªå¢ï¼Œåˆ™ä¼šè°ƒç”¨ä¸‹ä¸€ä¸ªfilter filterå…¨éƒ¨è°ƒç”¨åï¼ˆpos=filters.lengthï¼‰,å¼€å§‹çœŸæ­£æ‰§è¡Œè¯·æ±‚ è¯·æ±‚è¿”å›åä¼šä¾æ¬¡å†ç»è¿‡ä¹‹å‰ç»è¿‡çš„æ‰€æœ‰filterï¼ˆå€’åºï¼‰ rpc filter å®ç°å®šä¹‰filteræ¥å£ï¼Œä½¿ç”¨è€…å¦‚æœè¦æ·»åŠ è¿‡æ»¤é€»è¾‘éœ€è¦é›†æˆè¿™ä¸ªæ¥å£ã€‚ 123public interface RpcFilter &#123; void doFilter(RpcRequest request, RpcResponse response, RpcFilterChain filterChain);&#125; filteræŒæœ‰è€… 1234567891011121314151617181920212223242526272829public class RpcFilterChain implements RpcCode &#123; private RpcFilter[] filters = new RpcFilter[0]; private int pos; private RpcServiceInfo serviceInfo; private RpcServiceExecutor serviceExecutor;//æœ€ç»ˆè¦æ‰§è¡Œè¯·æ±‚çš„å¤„ç†å™¨ public RpcFilterChain(List&lt;RpcFilter&gt; filterList, RpcServiceInfo serviceInfo, RpcServiceExecutor serviceExecutor) &#123; if (filterList != null &amp;&amp; !filterList.isEmpty()) &#123; this.filters = new RpcFilter[filterList.size()]; this.filters = filterList.toArray(this.filters); &#125; this.serviceInfo = serviceInfo; this.serviceExecutor = serviceExecutor; &#125; public void doFilter(RpcRequest request, RpcResponse response) &#123; if (pos &lt; filters.length) &#123; RpcFilter filter = filters[pos++]; filter.doFilter(request, response, this); return; &#125; if (serviceExecutor == null) &#123; response.error(SERVICE_NOT_FOUND, \"service not exist: \" + serviceInfo); return; &#125; serviceExecutor.execute(request, response); &#125;&#125; rpc server æ¥æ”¶åˆ°è¯·æ±‚åå…ˆåˆå§‹åŒ–ä¸€ä¸ªè´£ä»»é“¾ï¼Œç„¶åè§¦å‘ã€‚ 1234567891011public RpcResponse execute(RpcRequest rpcRequest) &#123; RpcServiceInfo rpcServiceInfo = new RpcServiceInfo(rpcRequest.getAppName(), rpcRequest.getServiceName()); RpcFilterChain chain = new RpcFilterChain(filters, rpcServiceInfo, serviceExecutorMap.get(rpcServiceInfo)); RpcResponse rpcResponse = new RpcResponse(); try &#123; chain.doFilter(rpcRequest, rpcResponse); &#125; catch (Exception e) &#123; rpcResponse.error(e); &#125; return rpcResponse;&#125;","categories":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}],"tags":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/tags/å¾®æœåŠ¡/"},{"name":"filter","slug":"filter","permalink":"https://acupt.github.io/tags/filter/"},{"name":"è´£ä»»é“¾","slug":"è´£ä»»é“¾","permalink":"https://acupt.github.io/tags/è´£ä»»é“¾/"}],"keywords":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}]},{"title":"ä»0.5åˆ°1å†™ä¸ªrpcæ¡†æ¶ - 3:è¿œç¨‹æœåŠ¡è°ƒç”¨(thrift)","slug":"acuprpc-3","date":"2018-11-29T04:00:00.000Z","updated":"2019-07-11T14:13:32.202Z","comments":true,"path":"2018/11/29/acuprpc-3/","link":"","permalink":"https://acupt.github.io/2018/11/29/acuprpc-3/","excerpt":"","text":"è¿™ä¸æ˜¯æ•™ç¨‹ï¼Œåªæ˜¯ä¸ªäººæ€»ç»“ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯ä»¥æ­é…æºç çœ‹çœ‹ï¼šacuprpc thriftæ˜¯Facebookå¼€æºçš„rpcæ¡†æ¶ï¼ŒåŸºäºTPCï¼Œé»˜è®¤ä½¿ç”¨äºŒè¿›åˆ¶ã€‚ éœ€è¦å…ˆæŒæ¡thriftçš„åŸºæœ¬ç”¨æ³•: thrift-Java ç¤ºä¾‹ é¡¹ç›®ç»“æ„1234- acuprpc + acuprpc-core //server/clientæ ¸å¿ƒå¤„ç†é€»è¾‘ + acuprpc-protocol-thrift //åŸºäºthriftå®ç°è¿œç¨‹è°ƒç”¨ + acuprpc-spring-boot-starter //serverç«¯æœåŠ¡æ‰«æï¼Œclientç«¯åŠ¨æ€ä»£ç†ï¼Œ\bæœåŠ¡æ³¨å†Œ/å‘ç° thrift é€šä¿¡æ¥å£å®šä¹‰å®šä¹‰æœåŠ¡æä¾›è€…ï¼ˆserverï¼‰å’ŒæœåŠ¡è°ƒç”¨è€…ï¼ˆclientï¼‰äº¤æµæ‰€ç”¨çš„æ•°æ®ç»“æ„ï¼Œclientéœ€è¦å‘Šè¯‰serverè¦è°ƒç”¨çš„ç±»åã€æ–¹æ³•åä»¥åŠå‚æ•°ï¼ˆjsonæ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œåœ¨serverç«¯å†ååºåˆ—åŒ–ï¼‰ã€‚ resources/service.thrift 123456789101112131415161718namespace java com.acupt.acuprpc.protocol.thrift.protoservice ThriftService&#123; InvokeResponse invokeMethod(1:InvokeRequest invokeRequest)&#125;struct InvokeRequest&#123;1: required string appName;2: required string serviceName;3: required string methodName;4: required list&lt;string&gt; orderedParameter;5: required map&lt;string,string&gt; namedParameter;&#125;struct InvokeResponse&#123;1: required i32 code;2: optional string message;3: optional string result;&#125; thrift-serviceè¿™ä¸ªç±»è´Ÿè´£æ¥æ”¶ thrift-client å‘è¿‡æ¥çš„è¯·æ±‚ï¼Œå–å‡ºè¯·æ±‚ä¸­çš„å‚æ•°ï¼Œè½¬æ¢æˆé€šç”¨çš„ç»“æ„ï¼Œäº¤ç»™coreå±‚çš„RpcServerå»æ‰§è¡Œå¯¹åº”æ–¹æ³•ï¼Œç„¶åå°†è¿”å›å€¼åºåˆ—åŒ–æˆjsonè¿”å›ç»™ thrift-clientã€‚ 123456789101112131415161718192021222324public class ThriftService implements com.acupt.acuprpc.protocol.thrift.proto.ThriftService.Iface &#123; private RpcServer rpcServer; public ThriftService(RpcServer rpcServer) &#123; this.rpcServer = rpcServer; &#125; @Override public InvokeResponse invokeMethod(InvokeRequest invokeRequest) &#123; RpcRequest rpcRequest = new RpcRequest( invokeRequest.getAppName(), invokeRequest.getServiceName(), invokeRequest.getMethodName(), invokeRequest.getOrderedParameter(), invokeRequest.getNamedParameter()); RpcResponse rpcResponse = rpcServer.execute(rpcRequest); InvokeResponse response = new InvokeResponse(); response.setCode(rpcResponse.getCode()); response.setMessage(rpcResponse.getMessage()); response.setResult(rpcResponse.getResultString()); return response; &#125;&#125; thrift-serverä½œç‰©æœåŠ¡æä¾›è€…çš„å…·ä½“å®ç°ç±»ï¼Œåªéœ€è¦å®ç°ä¸¤ä¸ªæ–¹æ³•ï¼šå¯åŠ¨æœåŠ¡å’Œå…³é—­æœåŠ¡ï¼Œå…¶ä»–çš„äº¤ç»™coreå±‚çš„çˆ¶ç±»å³å¯ã€‚ ç”±äºthrift server è°ƒç”¨serve()æ–¹æ³•åä¼šé˜»å¡çº¿ç¨‹ï¼Œå› æ­¤éœ€è¦å¦å¤–å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»å¼€å¯æœåŠ¡ã€‚ 123456789101112131415161718192021222324252627282930313233public class ThriftServer extends RpcServer &#123; private static final int nThreads = 100; private TServer server; public ThriftServer(RpcInstance rpcInstance) &#123; super(rpcInstance); &#125; @Override protected void startRpc() &#123; new Thread(() -&gt; &#123; TProcessor tprocessor = new com.acupt.acuprpc.protocol.thrift.proto.ThriftService. Processor&lt;com.acupt.acuprpc.protocol.thrift.proto.ThriftService.Iface&gt;(new ThriftService(this)); TServerTransport serverTransport = null; try &#123; serverTransport = new TServerSocket(getRpcInstance().getRpcConf().getPort()); &#125; catch (TTransportException e) &#123; throw new RpcException(e); &#125; TThreadPoolServer.Args tArgs = new TThreadPoolServer.Args(serverTransport); tArgs.processor(tprocessor); tArgs.executorService(Executors.newFixedThreadPool(nThreads)); server = new TThreadPoolServer(tArgs); server.serve();//é˜»å¡ &#125;).start(); &#125; @Override protected void shutdownRpc() &#123; if (server != null) &#123; server.setShouldStop(true); &#125; &#125;&#125; thrift-clientä½œä¸ºæœåŠ¡è°ƒç”¨è€…ï¼Œéœ€è¦æŠŠ\båŠ¨æ€ä»£ç†ç±»ä¼ æ¥çš„è¯·æ±‚ä¿¡æ¯åŒ…è£…æˆthriftæ”¯æŒçš„ç»“æ„ï¼Œå¹¶è°ƒç”¨thriftçš„è¯·æ±‚æ–¹æ³•ï¼Œå†æŠŠè¿œç¨‹æœåŠ¡è¿”å›çš„ç»“æœè¿”å›ç»™ä»£ç†ç±»ã€‚ thrift client æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œä»å®ƒæä¾›çš„æ–¹æ³•å°±èƒ½å¤Ÿçœ‹å‡ºæ¥ã€‚ 12345678910111213public void send_invokeMethod(InvokeRequest invokeRequest)&#123; //...&#125;public InvokeResponse recv_invokeMethod()&#123; //...&#125;public InvokeResponse invokeMethod(InvokeRequest invokeRequest) throws org.apache.thrift.TException&#123; send_invokeMethod(invokeRequest); return recv_invokeMethod();&#125; ä¸ºäº†ç®€å•ç›´æ¥åœ¨æŠŠæ–¹æ³•è®¾ä¸º synchronized ï¼Œåç»­å†ä½¿ç”¨å¯¹è±¡æ±  12345678910111213141516171819202122232425262728293031323334353637383940414243public class ThriftClient extends RpcClient implements RpcCode &#123; private AtomicReference&lt;ThriftService.Client&gt; clientRef; public ThriftClient(NodeInfo nodeInfo) &#123; super(nodeInfo); clientRef = new AtomicReference&lt;&gt;(getClient(nodeInfo)); &#125; //todo clientçº¿ç¨‹ä¸å®‰å…¨ï¼Œä½¿ç”¨è¿æ¥æ± ç®¡ç† @Override @SneakyThrows protected synchronized String remoteInvoke(RpcRequest rpcRequest) &#123; InvokeRequest request = new InvokeRequest(); request.setAppName(rpcRequest.getAppName()); request.setServiceName(rpcRequest.getServiceName()); request.setMethodName(rpcRequest.getMethodName()); request.setOrderedParameter(rpcRequest.getOrderedParameter()); InvokeResponse response = clientRef.get().invokeMethod(request); if (response.getCode() != SUCCESS) &#123; throw new HttpStatusException(response.getCode(), response.getMessage()); &#125; return response.getResult(); &#125; @Override protected NodeInfo reconnectRpc(NodeInfo nodeInfo) &#123; //... &#125; @Override public void shutdownRpc() &#123; close(clientRef.get()); &#125; private ThriftService.Client getClient(NodeInfo nodeInfo) &#123; //... &#125; private void close(ThriftService.Client client) &#123; //... &#125;&#125;","categories":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}],"tags":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/tags/å¾®æœåŠ¡/"},{"name":"thrift","slug":"thrift","permalink":"https://acupt.github.io/tags/thrift/"}],"keywords":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}]},{"title":"ä»0.5åˆ°1å†™ä¸ªrpcæ¡†æ¶ - 2:è¿œç¨‹æœåŠ¡è°ƒç”¨(grpc)","slug":"acuprpc-2","date":"2018-11-29T03:00:00.000Z","updated":"2019-07-11T14:13:29.401Z","comments":true,"path":"2018/11/29/acuprpc-2/","link":"","permalink":"https://acupt.github.io/2018/11/29/acuprpc-2/","excerpt":"","text":"è¿™ä¸æ˜¯æ•™ç¨‹ï¼Œåªæ˜¯ä¸ªäººæ€»ç»“ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯ä»¥æ­é…æºç çœ‹çœ‹ï¼šacuprpc gRPCæ˜¯Googleå¼€æºçš„è·¨è¯­è¨€è¿œç¨‹æœåŠ¡è°ƒç”¨(RPC)æ¡†æ¶ï¼Œé€šä¿¡åè®®ç”¨çš„HTTP/2ï¼Œæ•°æ®ä¼ è¾“é»˜è®¤ç”¨çš„protocol buffersï¼ˆä¸€ç§è½»ä¾¿é«˜æ•ˆçš„ç»“æ„åŒ–æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œæƒ³æ¯”jsonæ›´å°æ›´å¿«ï¼Œä¸è¿‡æ²¡æœ‰å¯è¯»æ€§ï¼‰ã€‚ éœ€è¦å…ˆæŒæ¡grpcçš„åŸºæœ¬ç”¨æ³•: gRPC-Java ç¤ºä¾‹ é¡¹ç›®ç»“æ„1234- acuprpc + acuprpc-core //server/clientæ ¸å¿ƒå¤„ç†é€»è¾‘ + acuprpc-protocol-grpc //åŸºäºgrpcå®ç°è¿œç¨‹è°ƒç”¨ + acuprpc-spring-boot-starter //serverç«¯æœåŠ¡æ‰«æï¼Œclientç«¯åŠ¨æ€ä»£ç†ï¼Œ\bæœåŠ¡æ³¨å†Œ/å‘ç° grpcé€šä¿¡æ¥å£å®šä¹‰å®šä¹‰æœåŠ¡æä¾›è€…ï¼ˆserverï¼‰å’ŒæœåŠ¡è°ƒç”¨è€…ï¼ˆclientï¼‰äº¤æµæ‰€ç”¨çš„æ•°æ®ç»“æ„ï¼Œclientéœ€è¦å‘Šè¯‰serverè¦è°ƒç”¨çš„ç±»åã€æ–¹æ³•åä»¥åŠå‚æ•°ï¼ˆjsonæ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œåœ¨serverç«¯å†ååºåˆ—åŒ–ï¼‰ã€‚ 1234567891011121314151617181920212223242526syntax = \"proto3\";option java_multiple_files = true;option java_package = \"com.acupt.acuprpc.protocol.grpc.proto\";option java_outer_classname = \"GrpcServiceProto\";package com.acupt.acuprpc.protocol.grpc.proto;service GrpcService &#123; rpc invokeMethod (InvokeRequest) returns (InvokeResponse) &#123; &#125;&#125;message InvokeRequest &#123; string appName = 1; string serviceName = 2; string methodName = 3; repeated string orderedParameter = 4; map&lt;string, string&gt; namedParameter = 5;&#125;message InvokeResponse &#123; int32 code = 1; string message = 2; string result = 3;&#125; grpc-serviceè¿™ä¸ªç±»è´Ÿè´£æ¥æ”¶grpc-clientå‘è¿‡æ¥çš„è¯·æ±‚ï¼Œå–å‡ºè¯·æ±‚ä¸­çš„å‚æ•°ï¼Œè½¬æ¢æˆé€šç”¨çš„ç»“æ„ï¼Œäº¤ç»™coreå±‚çš„RpcServerå»æ‰§è¡Œå¯¹åº”æ–¹æ³•ï¼Œç„¶åå°†è¿”å›å€¼åºåˆ—åŒ–æˆjsonè¿”å›ç»™grpc-clientã€‚ 1234567891011121314151617181920212223242526public class GrpcService extends GrpcServiceGrpc.GrpcServiceImplBase &#123; private RpcServer rpcServer; public GrpcService(RpcServer rpcServer) &#123; this.rpcServer = rpcServer; &#125; @Override public void invokeMethod(InvokeRequest request, StreamObserver&lt;InvokeResponse&gt; responseObserver) &#123; RpcRequest rpcRequest = new RpcRequest( request.getAppName(), request.getServiceName(), request.getMethodName(), request.getOrderedParameterList(), request.getNamedParameterMap()); RpcResponse rpcResponse = rpcServer.execute(rpcRequest); InvokeResponse response = InvokeResponse.newBuilder() .setCode(rpcResponse.getCode()) .setMessage(rpcResponse.getMessage()) .setResult(rpcResponse.getResultString()) .build(); responseObserver.onNext(response); responseObserver.onCompleted(); &#125;&#125; grpc-serverä½œç‰©æœåŠ¡æä¾›è€…çš„å…·ä½“å®ç°ç±»ï¼Œåªéœ€è¦å®ç°ä¸¤ä¸ªæ–¹æ³•ï¼šå¯åŠ¨æœåŠ¡å’Œå…³é—­æœåŠ¡ï¼Œå…¶ä»–çš„äº¤ç»™coreå±‚çš„çˆ¶ç±»å³å¯ã€‚ 123456789101112131415161718192021222324public class GrpcServer extends RpcServer &#123; private Server server; public GrpcServer(RpcInstance rpcInstance) &#123; super(rpcInstance); &#125; @SneakyThrows @Override protected void startRpc() &#123; server = ServerBuilder .forPort(getRpcInstance().getRpcConf().getPort()) .addService(new GrpcService(this)) .build().start(); &#125; @Override protected void shutdownRpc() &#123; if (server != null) &#123; server.shutdown(); &#125; &#125;&#125; grpc-clientä½œä¸ºæœåŠ¡è°ƒç”¨è€…ï¼Œéœ€è¦æŠŠ\båŠ¨æ€ä»£ç†ç±»ä¼ æ¥çš„è¯·æ±‚ä¿¡æ¯åŒ…è£…æˆgrpcæ”¯æŒçš„ç»“æ„ï¼Œå¹¶è°ƒç”¨grpcçš„è¯·æ±‚æ–¹æ³•ï¼Œå†æŠŠè¿œç¨‹æœåŠ¡è¿”å›çš„ç»“æœè¿”å›ç»™ä»£ç†ç±»ã€‚ 12345678910111213141516171819202122232425262728293031323334353637public class GrpcClient extends RpcClient implements RpcCode &#123; private AtomicReference&lt;GrpcServiceGrpc.GrpcServiceFutureStub&gt; stubRef; public GrpcClient(NodeInfo nodeInfo) &#123; super(nodeInfo); this.stubRef = new AtomicReference&lt;&gt;(getStub(nodeInfo)); &#125; @Override protected String remoteInvoke(RpcRequest rpcRequest) &#123; InvokeRequest.Builder builder = InvokeRequest.newBuilder() .setAppName(rpcRequest.getAppName()) .setServiceName(rpcRequest.getServiceName()) .setMethodName(rpcRequest.getMethodName()); // ... ListenableFuture&lt;InvokeResponse&gt; future = stubRef.get().invokeMethod(builder.build()); InvokeResponse response = null; //... return response.getResult(); &#125; @Override @SneakyThrows protected NodeInfo reconnectRpc(NodeInfo nodeInfo) &#123; //...ä½¿ç”¨å‚æ•°ä¸­çš„ipå’Œç«¯å£å»ºç«‹æ–°è¿æ¥ï¼Œå¹¶æ–­å¼€è€çš„è¿æ¥ï¼Œå¯ç”¨äºé‡æ–°è´Ÿè½½å’Œå¼‚å¸¸èŠ‚ç‚¹é‡è¯• &#125; @Override @SneakyThrows public void shutdownRpc() &#123; //...ä¸»åŠ¨æ–­å¼€å’ŒæœåŠ¡ç«¯çš„è¿æ¥ &#125; private GrpcServiceGrpc.GrpcServiceFutureStub getStub(NodeInfo nodeInfo) &#123; //...å’ŒæœåŠ¡ç«¯å»ºç«‹è¿æ¥ï¼Œä½¿ç”¨å‚æ•°ä¸­çš„ipå’Œç«¯å£ &#125;","categories":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}],"tags":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/tags/å¾®æœåŠ¡/"},{"name":"grpc","slug":"grpc","permalink":"https://acupt.github.io/tags/grpc/"}],"keywords":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}]},{"title":"ä»0.5åˆ°1å†™ä¸ªrpcæ¡†æ¶ - 1:æœåŠ¡æ³¨å†Œ/å‘ç°(eureka)","slug":"acuprpc-1","date":"2018-11-29T02:00:00.000Z","updated":"2019-07-11T14:13:22.585Z","comments":true,"path":"2018/11/29/acuprpc-1/","link":"","permalink":"https://acupt.github.io/2018/11/29/acuprpc-1/","excerpt":"","text":"è¿™ä¸æ˜¯æ•™ç¨‹ï¼Œåªæ˜¯ä¸ªäººæ€»ç»“ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯ä»¥æ­é…æºç çœ‹çœ‹ï¼šacuprpc 123- acuprpc + acuprpc-core //server/clientæ ¸å¿ƒå¤„ç†é€»è¾‘ + acuprpc-spring-boot-starter //serverç«¯æœåŠ¡æ‰«æï¼Œclientç«¯åŠ¨æ€ä»£ç†ï¼Œ\bæœåŠ¡æ³¨å†Œ/å‘ç° Eureka Serverspring-cloud-starter-eureka-server Eureka ClientåŸç†å°±æ˜¯åˆ©ç”¨eurekaæä¾›çš„å®¢æˆ·ç«¯ç±»æ¥å‘Eureka Serverå‘é€æ³¨å†Œè¯·æ±‚ï¼ŒæŠŠè‡ªå·±æä¾›æœåŠ¡çš„åœ°å€å’Œç«¯å£ï¼ˆrpcæœåŠ¡ç«¯å£ï¼Œä¸æ˜¯springbootå¯åŠ¨çš„\bhttpç«¯å£ï¼‰å‘Šè¯‰æ³¨å†Œä¸­å¿ƒï¼Œè¿™æ ·å…¶ä»–å®¢æˆ·ç«¯ï¼ˆåŒ…æ‹¬è‡ªèº«ï¼‰å°±å¯ä»¥è¯·æ±‚Eureka Serverè·å–éœ€è¦çš„æœåŠ¡èŠ‚ç‚¹ä¿¡æ¯ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263/** * åœ¨æœåŠ¡ä¸­å¿ƒæ³¨å†Œçš„å®ä¾‹ */@Getter@Slf4jpublic class RpcInstance &#123; private EurekaClient eurekaClient; private ApplicationInfoManager applicationInfoManager; private RpcConf rpcConf; public RpcInstance(RpcConf rpcConf) &#123; RpcEurekaInstanceConfig instanceConfig = new RpcEurekaInstanceConfig(); instanceConfig.setAppGroupName(rpcConf.getAppGroup()); instanceConfig.setAppname(rpcConf.getAppName()); instanceConfig.setNonSecurePort(rpcConf.getPort()); instanceConfig.setIpAddress(IpUtil.INTRANET_IP); instanceConfig.setHostname(IpUtil.HOSTNAME); RpcEurekaClientConfig clientConfig = new RpcEurekaClientConfig(); clientConfig.getServiceUrl().put(\"default\", rpcConf.getDiscoveryServiceUrl()); clientConfig.setRegisterWithEureka(rpcConf.isRegisterWithDiscovery()); InstanceInfo instanceInfo = new EurekaConfigBasedInstanceInfoProvider(instanceConfig).get(); this.applicationInfoManager = new ApplicationInfoManager(instanceConfig, instanceInfo); this.eurekaClient = new DiscoveryClient(applicationInfoManager, clientConfig); this.rpcConf = rpcConf; log.info(\"protocol server -&gt; \" + rpcConf.getRpcServerClass()); log.info(\"protocol client -&gt; \" + rpcConf.getRpcClientClass()); &#125; public void start() &#123; applicationInfoManager.setInstanceStatus(InstanceInfo.InstanceStatus.STARTING); &#125; public void started() &#123; applicationInfoManager.setInstanceStatus(InstanceInfo.InstanceStatus.UP); &#125; public void shutdown() &#123; applicationInfoManager.setInstanceStatus(InstanceInfo.InstanceStatus.DOWN); eurekaClient.shutdown(); &#125; /** * åˆ›å»ºä¸€ä¸ªrpc serverï¼Œæ ¹æ®é…ç½®çš„è°ƒç”¨æ–¹å¼ï¼ˆå®ç°ç±»ï¼‰ç”Ÿæˆå¯¹è±¡ */ @SneakyThrows public RpcServer newRpcServer() &#123; return rpcConf.getRpcServerClass().getConstructor(RpcInstance.class).newInstance(this); &#125; /** * åˆ›å»ºä¸€ä¸ªrpc clientï¼Œæ ¹æ®é…ç½®çš„è°ƒç”¨æ–¹å¼ï¼ˆå®ç°ç±»ï¼‰ç”Ÿæˆå¯¹è±¡ */ @SneakyThrows public RpcClient newRpcClient(NodeInfo nodeInfo) &#123; return rpcConf.getRpcClientClass().getConstructor(NodeInfo.class).newInstance(nodeInfo); &#125;&#125; starteræ„å»ºä¸€ä¸ªè‡ªå·±çš„spring boot starterï¼Œè¿™æ ·åˆ«çš„é¡¹ç›®åªéœ€è¦å¼•å…¥è¿™ä¸ªä¾èµ–ï¼Œå°±èƒ½ä½¿ç”¨starteræä¾›çš„æœåŠ¡äº†ã€‚ 1234- resources - META-INF spring.factories // å®šä¹‰@Configurationç±»çš„è·¯å¾„ï¼Œæœ‰äº†è¿™ä¸ªå£°æ˜ä¾èµ–starterçš„é¡¹ç›®å°±èƒ½è·å¾—starterä¸­æä¾›çš„bean spring-configuration-metadata.json // é…ç½®ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰ï¼Œæœ‰äº†å®ƒåœ¨IDEä¸­ç¼–è¾‘applicationé…ç½®æ–‡ä»¶å¯ä»¥çœ‹åˆ°æç¤ºä¿¡æ¯ rpc server æœåŠ¡ç®¡ç†ä½œä¸ºrpcæœåŠ¡æä¾›è€…ï¼Œéœ€è¦åœ¨åº”ç”¨å¯åŠ¨æ—¶æŠŠæœ‰æ³¨è§£ï¼ˆ@Rpcï¼‰çš„æœåŠ¡ç®¡ç†èµ·æ¥ï¼Œè¿™æ ·æ¥æ”¶åˆ°rpcè¯·æ±‚åå¯ä»¥å¿«é€ŸæŸ¥è¯¢åˆ°æŒ‡å®šå¯¹è±¡ï¼Œæ‰§è¡ŒæŒ‡å®šæ–¹æ³•ã€‚ å®ç°æ¥å£BeanPostProcessorçš„beanå³å¯å¾—åˆ°å¤„ç†springä¸­çš„æ‰€æœ‰beanï¼ˆæ¯ä¸ªbeanåˆå§‹åŒ–å®Œæˆåä¼šè°ƒç”¨æ¥å£æ–¹æ³•ï¼‰ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748public class RpcServiceScanner implements BeanPostProcessor &#123; private RpcServer rpcServer; public RpcServiceScanner(RpcServer rpcServer) &#123; this.rpcServer = rpcServer; &#125; @Override public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException &#123; return bean; &#125; @Override public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123; // AOPä»£ç†ç±»éœ€è¦æ‹¿åˆ°åŸå§‹çš„ç±»ï¼Œä¸ç„¶è¯»ä¸åˆ°ç±»ä¸Šçš„æ³¨è§£ Class&lt;?&gt; beanClass = AopUtils.isAopProxy(bean) ? AopUtils.getTargetClass(bean) : bean.getClass(); val nrpc = beanClass.getAnnotation(Rpc.class); if (nrpc == null) &#123; return bean; &#125; Method[] methods = beanClass.getDeclaredMethods(); if (methods.length == 0) &#123; return bean; &#125; Map&lt;String, MethodInfo&gt; methodInfoMap = new HashMap&lt;&gt;(); for (Method method : methods) &#123; methodInfoMap.put(method.getName(), new MethodInfo(method)); &#125; Class&lt;?&gt;[] interfaces = beanClass.getInterfaces(); if (interfaces.length == 0) &#123; return bean; &#125; // clientæ˜¯é€šè¿‡æ¥å£è°ƒç”¨serverçš„ï¼Œå› æ­¤å¹¶ä¸çŸ¥é“å…·ä½“å®ç°ç±»çš„è·¯å¾„ï¼Œåªæœ‰æ¥å£åï¼Œå› æ­¤æŠŠæ‰€æœ‰æ¥å£éƒ½æ³¨å†Œä¸€é for (Class&lt;?&gt; serviceInterface : interfaces) &#123; rpcServer.registerService( new RpcServiceInfo(rpcServer.getRpcInstance().getRpcConf().getAppName(), serviceInterface.getCanonicalName()), bean, serviceInterface, methodInfoMap); &#125; return bean; &#125;&#125; rpc client è¿œç¨‹æœåŠ¡ä»£ç†ä½œä¸ºæœåŠ¡è°ƒç”¨è€…ï¼Œå¯ä»¥é€šè¿‡æ¥å£åƒè°ƒç”¨æœ¬åœ°ä»£ç ä¸€æ ·è°ƒç”¨è¿œç¨‹æœåŠ¡ï¼ŒåŸç†å°±æ˜¯ä¸ºæ¥å£åˆ›å»ºä¸€ä¸ªä»£ç†ï¼Œåœ¨ä»£ç†ä¸­è¿›è¡Œè¿œç¨‹è°ƒç”¨ã€‚ è¿™é‡Œä½¿ç”¨ä¸»åŠ¨åˆ›å»ºä»£ç†çš„æ–¹å¼ã€‚ 1234567891011121314151617public class RpcServiceConsumer &#123; private RpcClientManager rpcClientManager; public RpcServiceConsumer(RpcClientManager rpcClientManager) &#123; this.rpcClientManager = rpcClientManager; &#125; @SuppressWarnings(\"unchecked\") public &lt;T&gt; T create(String appName, Class&lt;T&gt; serviceInterface) &#123; RpcServiceInfo serviceInfo = new RpcServiceInfo(appName, serviceInterface.getCanonicalName()); return (T) Proxy.newProxyInstance( serviceInterface.getClassLoader(), new Class&lt;?&gt;[]&#123;serviceInterface&#125;, new RpcInvocationHandler(serviceInfo, rpcClientManager)); &#125;&#125; 12345678910111213141516171819202122232425262728293031323334353637383940public class RpcInvocationHandler implements InvocationHandler &#123; private RpcServiceInfo rpcServiceInfo; private RpcServiceManager rpcServiceManager; private RpcClient rpcClient; public RpcInvocationHandler(RpcServiceInfo rpcServiceInfo, RpcServiceManager rpcServiceManager) &#123; this.rpcServiceInfo = rpcServiceInfo; this.rpcServiceManager = rpcServiceManager; tryInitRpcClient(false); &#125; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; RpcMethodInfo methodInfo = new RpcMethodInfo(rpcServiceInfo, method.getName(), method.getGenericReturnType()); return tryGetRpcClient().invoke(methodInfo, args); &#125; private RpcClient tryGetRpcClient() &#123; if (rpcClient == null) &#123; tryInitRpcClient(true); &#125; return rpcClient; &#125; private synchronized void tryInitRpcClient(boolean throwError) &#123; if (rpcClient != null) &#123; return; &#125; try &#123; rpcClient = rpcServiceManager.lookup(rpcServiceInfo); &#125; catch (Exception e) &#123; if (throwError) &#123; throw e; &#125; &#125; &#125;&#125; æ³¨å†Œä¸€ä¸ªApplicationListenerï¼Œæ¥æ”¶springbootç¨‹åºå‡†å¤‡å®Œåçš„ä¿¡å·ï¼Œç„¶åå‘Šè¯‰æ³¨å†Œä¸­å¿ƒå‡†å¤‡å¥½äº†ã€‚ 12345678910111213public class RpcApplicationListener implements ApplicationListener&lt;ApplicationReadyEvent&gt; &#123; private RpcServer rpcServer; public RpcApplicationListener(RpcServer rpcServer) &#123; this.rpcServer = rpcServer; &#125; @Override public void onApplicationEvent(ApplicationReadyEvent event) &#123; rpcServer.started(); &#125;&#125;","categories":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}],"tags":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/tags/å¾®æœåŠ¡/"},{"name":"eureka","slug":"eureka","permalink":"https://acupt.github.io/tags/eureka/"}],"keywords":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}]},{"title":"ä»0.5åˆ°1å†™ä¸ªrpcæ¡†æ¶ - 0:å‰è¨€","slug":"acuprpc-0","date":"2018-11-29T01:00:00.000Z","updated":"2019-08-01T16:55:58.239Z","comments":true,"path":"2018/11/29/acuprpc-0/","link":"","permalink":"https://acupt.github.io/2018/11/29/acuprpc-0/","excerpt":"","text":"è¿™ä¸æ˜¯æ•™ç¨‹ï¼Œåªæ˜¯ä¸ªäººæ€»ç»“ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯ä»¥æ­é…æºç çœ‹çœ‹ï¼šacuprpc æœ€è¿‘åœ¨æ–°å…¬å¸å¼€å§‹æ¥è§¦å¾®æœåŠ¡ï¼Œåœ¨æ­¤ä¹‹å‰å¹¶æ²¡æœ‰å¾®æœåŠ¡çš„å¼€å‘ç»éªŒã€‚å¯¹æ¯”äº†spring cloudå’Œå…¬å¸çš„rpcæ¡†æ¶ï¼Œå¯¹å¾®æœåŠ¡è¿™å¥—ä¸œè¥¿ç»ˆäºæœ‰äº†ä¸€ç‚¹ç²—æµ…çš„è®¤çŸ¥ï¼Œä¸ºäº†åŠ æ·±ç†è§£ï¼Œè‡ªå·±åŠ¨æ‰‹å†™ä¸ªrpcæ¡†æ¶ç©ç©ã€‚é¡ºä¾¿è®°å½•ä¸‹æ¥ï¼Œä¸ç„¶ç©è¿‡çš„ä¸œè¥¿è¿‡æ®µæ—¶é—´å°±å¿˜äº†ã€‚ æˆ‘çš„spring cloudçš„å…¥é—¨è¯»ç‰©: å²ä¸Šæœ€ç®€å•çš„ SpringCloud æ•™ç¨‹ æˆ‘çš„å­¦ä¹ æˆæœ: acuprpc è®¾è®¡æ–¹æ¡ˆæ€»çš„æ¥è¯´å°±æ˜¯åœ¨ç°æœ‰å·¥å…·ä¸Šçš„äºŒæ¬¡å¼€å‘ã€‚ æœåŠ¡æ³¨å†Œ/å‘ç°: eureka è¿™ä¸ªæ¨¡å—spring cloudå·²ç»é›†æˆçš„éå¸¸æ˜“ç”¨äº†ï¼Œå®åœ¨æ²¡å…´è¶£å†æ•´äº›éªšæ“ä½œï¼Œå¼•å…¥spring-cloud-starter-eureka-serverä¾èµ–ï¼Œå¯åŠ¨ç±»åŠ ä¸ªæ³¨è§£@EnableEurekaServerå°±æ˜¯ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒäº†ã€‚ è¿œç¨‹æœåŠ¡è°ƒç”¨: grpc/thrift grpcæ˜¯Googleå¼€æºçš„rpcæ¡†æ¶ï¼Œthriftæ˜¯Facebookå¼€æºçš„rpcæ¡†æ¶ï¼Œè€Œä¸”ä»–ä»¬éƒ½æ”¯æŒè·¨è¯­è¨€ï¼Œéƒ½æ˜¯å¾ˆå‰å®³çš„ä¸œè¥¿ï¼Œéœ€è¦ç”¨å®ƒä»¬çš„è§„åˆ™å®šä¹‰æ•°æ®ç»“æ„ï¼Œ\bæ¯ä¸ª\bæœåŠ¡éƒ½å®šä¹‰ä¸€æ¬¡æ˜¯æŒºç´¯çš„ï¼Œå¦‚æœåªå®šä¹‰ä¸€ä¸ªé€šç”¨çš„æœåŠ¡ï¼Œç„¶ååœ¨è¿™ä¸ªæœåŠ¡é‡Œé¢é€šè¿‡Javaåå°„å»æ‰§è¡Œå¯¹åº”æ–¹æ³•å°±å¯ä»¥å°‘å¾ˆå¤šå·¥ä½œé‡äº†ï¼ˆæŠŠå·¥ä½œé‡å˜æˆäº†Javaä»£ç ç¼–å†™ï¼‰ã€‚ è‡³äºé€‰æ‹©è¿™ä¸¤ç§ï¼Œå› ä¸ºéƒ½æƒ³è¯•è¯•ï¼Œæ‰€ä»¥æœ€ç»ˆè®¾è®¡rpcæ¡†æ¶æ˜¯å¯ä»¥åˆ‡æ¢é€šä¿¡æ–¹å¼çš„ï¼ŒæŠŠè¿™éƒ¨åˆ†æŠ½å‡ºæ¥åšæˆå¯æ‰©å±•çš„å³å¯ã€‚ ç›®å½•// åªè¦åˆ—å‡ºæ¥ï¼Œæ€»æœ‰ä¸€å¤©ä¼šå†™å®Œã€‚ ä»0.5åˆ°1å†™ä¸ªrpcæ¡†æ¶ - 1:æœåŠ¡æ³¨å†Œ/å‘ç°(eureka) ä»0.5åˆ°1å†™ä¸ªrpcæ¡†æ¶ - 2:è¿œç¨‹æœåŠ¡è°ƒç”¨(grpc) ä»0.5åˆ°1å†™ä¸ªrpcæ¡†æ¶ - 3:è¿œç¨‹æœåŠ¡è°ƒç”¨(thrift) ä»0.5åˆ°1å†™ä¸ªrpcæ¡†æ¶ - 4:request filter ä»0.5åˆ°1å†™ä¸ªrpcæ¡†æ¶ - 5:æœåŠ¡ç›‘æ§å’Œç®¡ç†(actuator) ä»0.5åˆ°1å†™ä¸ªrpcæ¡†æ¶ - 6:è°ƒç”¨å¼‚å¸¸èŠ‚ç‚¹è‡ªåŠ¨é‡è¯• ä»0.5åˆ°1å†™ä¸ªrpcæ¡†æ¶ - 7:ç½‘å…³æ”¯æŒ(gateway)","categories":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}],"tags":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/tags/å¾®æœåŠ¡/"},{"name":"rpc","slug":"rpc","permalink":"https://acupt.github.io/tags/rpc/"},{"name":"grpc","slug":"grpc","permalink":"https://acupt.github.io/tags/grpc/"},{"name":"thrift","slug":"thrift","permalink":"https://acupt.github.io/tags/thrift/"},{"name":"eureka","slug":"eureka","permalink":"https://acupt.github.io/tags/eureka/"}],"keywords":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}]},{"title":"thrift-Java ç¤ºä¾‹","slug":"thrift-start","date":"2018-11-20T12:00:00.000Z","updated":"2018-11-20T12:05:26.055Z","comments":true,"path":"2018/11/20/thrift-start/","link":"","permalink":"https://acupt.github.io/2018/11/20/thrift-start/","excerpt":"","text":"å®‰è£…thriftmac brew install thrift å®‰è£…å®Œæˆæ£€æŸ¥ thrift â€“version æ–°å»ºmavené¡¹ç›®pom.xml 123456789101112131415161718192021222324252627282930&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.thrift&lt;/groupId&gt; &lt;artifactId&gt;libthrift&lt;/artifactId&gt; &lt;version&gt;0.11.0&lt;/version&gt; &lt;/dependency&gt;&lt;/dependencies&gt;&lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.thrift&lt;/groupId&gt; &lt;artifactId&gt;thrift-maven-plugin&lt;/artifactId&gt; &lt;version&gt;0.10.0&lt;/version&gt; &lt;configuration&gt; &lt;thriftExecutable&gt;/usr/local/bin/thrift&lt;/thriftExecutable&gt; &lt;!--thriftå®‰è£…è·¯å¾„--&gt; &lt;thriftSourceRoot&gt;src/main/resources&lt;/thriftSourceRoot&gt; &lt;!--thrifté…ç½®æ–‡ä»¶è·¯å¾„--&gt; &lt;/configuration&gt; &lt;executions&gt; &lt;execution&gt; &lt;id&gt;thrift-sources&lt;/id&gt; &lt;phase&gt;generate-sources&lt;/phase&gt; &lt;goals&gt; &lt;goal&gt;compile&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;/plugin&gt; &lt;/plugins&gt;&lt;/build&gt; å®šä¹‰æœåŠ¡æ–°å»ºæ–‡ä»¶ src/main/resources/service.thrift 1234namespace java com.acupt.thritf.serviceservice HelloService&#123; string hello(1:string name)&#125; æ„å»ºä½¿ç”¨mavenæ’ä»¶æ ¹æ®.protoæ–‡ä»¶ç”ŸæˆJavaä»£ç ï¼Œæ’ä»¶å·²åœ¨pom.xmlä¸­é…ç½®ï¼Œåªéœ€æ‰§è¡Œå‘½ä»¤ï¼š mvn install æ„å»ºå®Œæˆåå¯ä»¥åœ¨targetä¸­æ‰¾åˆ°ç”Ÿæˆçš„Javaä»£ç ï¼Œç”¨è¿™äº›ä»£ç \bå¯ä»¥å®ç°thriftè¿œç¨‹è°ƒç”¨ã€‚ target/generated-sources/thrift/com/acupt/thritf/service/HelloService.java å¦‚æœåœ¨é¡¹ç›®ä¸­æ— æ³•ç›´æ¥å¼•ç”¨ä¸Šé¢çš„ç±»ï¼ŒIDEAå³é”®\bthriftæ–‡ä»¶å¤¹ -&gt; Mark Directory as -&gt; Generated Sources Root ç°åœ¨å°±å¯ä»¥åœ¨é¡¹ç›®ä¸­å¼•ç”¨äº† ä»£ç 3ä¸ªç±» 123456789101112131415package com.acupt.thrift;import com.acupt.thritf.service.HelloService;import org.apache.thrift.TException;/** * æœåŠ¡å®ç°ç±» */public class HelloServiceImpl implements HelloService.Iface &#123; @Override public String hello(String name) throws TException &#123; return \"hello,\" + name; &#125;&#125; 123456789101112131415161718192021222324252627282930313233343536373839404142package com.acupt.thrift;import com.acupt.thritf.service.HelloService;import org.apache.thrift.TProcessor;import org.apache.thrift.protocol.TBinaryProtocol;import org.apache.thrift.server.TServer;import org.apache.thrift.server.TSimpleServer;import org.apache.thrift.transport.TServerSocket;/** * æœåŠ¡æä¾›æ–¹ */public class MyServer &#123; public static void main(String args[]) &#123; try &#123; TProcessor tprocessor = new HelloService.Processor&lt;HelloService.Iface&gt;(new HelloServiceImpl()); TServerSocket serverTransport = new TServerSocket(50005); TServer.Args tArgs = new TServer.Args(serverTransport); tArgs.processor(tprocessor); tArgs.protocolFactory(new TBinaryProtocol.Factory()); TServer server = new TSimpleServer(tArgs); System.out.println(\"server starting\"); //å®šæ—¶å…³é—­ new Thread(() -&gt; &#123; try &#123; System.out.println(\"server wait stop\"); Thread.sleep(30000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(\"server stopping\"); server.stop(); System.out.println(\"server stop\"); &#125;).start(); server.serve();//ä¼šé˜»å¡ System.out.println(\"server finish\"); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;&#125; 1234567891011121314151617181920212223242526272829303132package com.acupt.thrift;import com.acupt.thritf.service.HelloService;import org.apache.thrift.protocol.TBinaryProtocol;import org.apache.thrift.protocol.TProtocol;import org.apache.thrift.transport.TSocket;import org.apache.thrift.transport.TTransport;/** * æœåŠ¡è°ƒç”¨æ–¹ */public class MyClient &#123; public static void main(String[] args) &#123; TTransport transport = null; try &#123; transport = new TSocket(\"localhost\", 50005); TProtocol protocol = new TBinaryProtocol(transport); HelloService.Client client = new HelloService.Client(protocol); transport.open(); String result = client.hello(\"tom\"); System.out.println(result); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; finally &#123; if (null != transport) &#123; transport.close(); &#125; &#125; &#125;&#125; å…ˆå¯åŠ¨MyServerï¼Œ\bæˆåŠŸå¯åŠ¨åå†å¯åŠ¨MyClientã€‚ å’Œgrpcç”¨æ³•\bå·®ä¸å¤šï¼ŒgRPC-Java ç¤ºä¾‹","categories":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}],"tags":[{"name":"rpc","slug":"rpc","permalink":"https://acupt.github.io/tags/rpc/"},{"name":"thrift","slug":"thrift","permalink":"https://acupt.github.io/tags/thrift/"}],"keywords":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}]},{"title":"spring rabbitmq å¼‚å¸¸é‡è¯•æºç åˆ†æ","slug":"spring-rabbitmq-retry","date":"2018-11-15T03:00:00.000Z","updated":"2019-07-12T14:14:55.510Z","comments":true,"path":"2018/11/15/spring-rabbitmq-retry/","link":"","permalink":"https://acupt.github.io/2018/11/15/spring-rabbitmq-retry/","excerpt":"","text":"springbooté›†æˆrabbitMQ\bå‘æ¶ˆæ¯123456789@Resourceprivate RabbitTemplate rabbitTemplate;@Value(\"$&#123;my.exchange&#125;\")private String exchange;public void send(Object obj) &#123; rabbitTemplate.convertAndSend(exchange, \"\", JsonUtils.toJson(obj));&#125; å¤„ç†æ¶ˆæ¯1234@RabbitListener(queues = \"$&#123;msg.queue.my.exchange&#125;\")public void receive(String msg) &#123; //...&#125; é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœå¤„ç†æ¶ˆæ¯æ—¶æŠ›å‡ºäº†å¼‚å¸¸ï¼Œè¿™ä¸ªæ¶ˆæ¯ä¼šä¸€ç›´é‡å¤æ¶ˆè´¹ï¼ˆé‡å¤è°ƒç”¨receiveæ–¹æ³•ï¼‰ï¼Œç›´åˆ°æ²¡æœ‰æŠ›å¼‚å¸¸ã€‚ æ¶ˆæ¯æ¥æ”¶/å¤„ç†æµç¨‹åˆ†æåœ¨@RabbitListeneræ³¨è§£çš„æ–¹æ³•é‡Œæ‰“ä¸ªæ–­ç‚¹ï¼Œè§‚å¯Ÿä¸‹è°ƒç”¨æ ˆã€‚ æœ«ç«¯æ˜¯ä¸ªå®ç°äº†Runnableçš„å†…éƒ¨ç±»SimpleMessageListenerContainer$AsyncMessageProcessingConsumer 123456789101112@Overridepublic void run() &#123; //â€¦â€¦ //ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºåªè¦è¿™ä¸ªæ¶ˆè´¹è€…ï¼ˆconsumerï¼‰çŠ¶æ€æ»¡è¶³ä¼šä¸€ç›´è½®è¯¢å»æ¥æ”¶æ¶ˆæ¯å’Œæ¶ˆè´¹æ¶ˆæ¯ while (isActive(this.consumer) || this.consumer.hasDelivery() || !this.consumer.cancelled()) &#123; try &#123; boolean receivedOk = receiveAndExecute(this.consumer); // At least one message received //â€¦â€¦ &#125; //â€¦â€¦ &#125;&#125; 12345678910111213141516171819202122232425private boolean doReceiveAndExecute(BlockingQueueConsumer consumer) throws Throwable &#123; //NOSONAR Channel channel = consumer.getChannel(); for (int i = 0; i &lt; this.txSize; i++) &#123; logger.trace(\"Waiting for message from consumer.\"); Message message = consumer.nextMessage(this.receiveTimeout); if (message == null) &#123;break;&#125; try &#123; //å¦‚æœè·å–åˆ°äº†æ¶ˆæ¯å°±ä¼šå»æ¶ˆè´¹ï¼Œè¿™é‡Œæœ€ç»ˆä¼šæ‰§è¡Œåˆ°æˆ‘ä»¬å†™çš„listeneræ–¹æ³• executeListener(channel, message); &#125; //å½“æˆ‘ä»¬å†™çš„æ–¹æ³•æŠ›å¼‚å¸¸çš„æ—¶å€™å°±ä¼šæ¥åˆ°è¿™é‡Œ //å‘ç°å«Œç–‘ä»£ç ï¼šconsumer.rollbackOnExceptionIfNecessary(ex) catch (ImmediateAcknowledgeAmqpException e) &#123;/*â€¦â€¦*/&#125; catch (Throwable ex) &#123; //NOSONAR if (causeChainHasImmediateAcknowledgeAmqpException(ex)) &#123;/*â€¦â€¦*/&#125; if (this.transactionManager != null) &#123;/*æ²¡å¼€äº‹åŠ¡ï¼Œå¿½ç•¥*/&#125; else &#123; consumer.rollbackOnExceptionIfNecessary(ex); throw ex; &#125; &#125; &#125; return consumer.commitIfNecessary(isChannelLocallyTransacted(channel));&#125; 12345678910111213141516171819202122public void rollbackOnExceptionIfNecessary(Throwable ex) throws Exception &#123; boolean ackRequired = !this.acknowledgeMode.isAutoAck() &amp;&amp; !this.acknowledgeMode.isManual(); try &#123; if (this.transactional) &#123;/*â€¦â€¦*/&#125; if (ackRequired) &#123; boolean shouldRequeue = RabbitUtils.shouldRequeue(this.defaultRequeuRejected, ex, logger); for (Long deliveryTag : this.deliveryTags) &#123; // æœ€ç»ˆä¼šæ‰§è¡Œåˆ°è¿™é‡Œ // With newer RabbitMQ brokers could use basicNack here... this.channel.basicReject(deliveryTag, shouldRequeue); &#125; if (this.transactional) &#123;/*â€¦â€¦*/&#125; &#125; &#125; catch (Exception e) &#123; logger.error(\"Application exception overridden by rollback exception\", ex); throw e; &#125; finally &#123; this.deliveryTags.clear(); &#125;&#125; ç”±ä¸Šå¯çœ‹å‡ºï¼Œå¯¼è‡´æ— é™é‡è¯•çš„ä¸¤ä¸ªå€¼ï¼š ackRequired: å’Œackæ¨¡å¼ç›¸å…³ shouldRequeue: å’ŒdefaultRequeuRejectedä»¥åŠæŠ›å‡ºçš„å¼‚å¸¸ç±»å‹æœ‰å…³ æ ¹æ®éœ€è¦ä¿®æ”¹acknowledgeModeæˆ–è€…defaultRequeuRejectedå³å¯ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­æ ¹æ®IDEè¡¥å…¨æç¤ºå¯ä»¥æ‰¾åˆ°è¿™ä¸¤ä¸ªå±æ€§ã€‚ 12spring.rabbitmq.listener.acknowledge-mode=nonespring.rabbitmq.listener.default-requeue-rejected=false å¦‚æœåªæ˜¯ä¸æƒ³å¼‚å¸¸æ—¶é‡è¯•ï¼Œç›´æ¥åœ¨ä¸šåŠ¡ä»£ç ä¸­tryâ€¦catchå…¨éƒ¨ä»£ç ä¸è®©æŠ›å¼‚å¸¸ä¹Ÿè¡Œã€‚ PSï¼šéªŒè¯è¿™ä¸¤ä¸ªé…ç½®çš„æ—¶å€™å‘ç°ä¸ç”Ÿæ•ˆï¼Œä¸€ç•ªdebugå‘ç°é¡¹ç›®é‡Œé¢è‡ªå®šä¹‰äº†ä¸€ä¸ªå·¥å‚beanï¼Œåˆ›å»ºæ¶ˆè´¹è€…ç›¸å…³å¯¹è±¡æ—¶ç”¨çš„é‚£ä¸ªå·¥å‚beanï¼Œè€Œä¸æ˜¯æ ¹æ®é…ç½®å±æ€§ç”Ÿæˆã€‚ 1234567@Beanpublic SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory(ConnectionFactory connectionFactory) &#123; SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory(); factory.setConnectionFactory(connectionFactory); factory.setMessageConverter(new Jackson2JsonMessageConverter()); return factory;&#125; æ³¨é‡Šæ‰è¿™ä¸ªbeané‚£ä¸¤ä¸ªé…ç½®æ‰ç”Ÿæ•ˆï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨è¿™ä¸ªbeané‡Œè®¾ç½®é‚£ä¸¤ä¸ªå±æ€§ã€‚","categories":[{"name":"éšç¬”","slug":"éšç¬”","permalink":"https://acupt.github.io/categories/éšç¬”/"}],"tags":[{"name":"spring","slug":"spring","permalink":"https://acupt.github.io/tags/spring/"},{"name":"rabbitmq","slug":"rabbitmq","permalink":"https://acupt.github.io/tags/rabbitmq/"}],"keywords":[{"name":"éšç¬”","slug":"éšç¬”","permalink":"https://acupt.github.io/categories/éšç¬”/"}]},{"title":"spring cloud è‡ªå®šä¹‰é…ç½®æºåŠé…ç½®åˆ·æ–°","slug":"spring-cloud-source-diy","date":"2018-10-29T07:19:56.000Z","updated":"2018-11-15T09:12:42.075Z","comments":true,"path":"2018/10/29/spring-cloud-source-diy/","link":"","permalink":"https://acupt.github.io/2018/10/29/spring-cloud-source-diy/","excerpt":"","text":"é€šè¿‡è‡ªå®šä¹‰é…ç½®æºå¯ä»¥æ¥å…¥è‡ªå·±çš„é…ç½®æœåŠ¡ï¼Œé…åˆContextRefresherå¯ä»¥è®©åº”ç”¨è¿è¡Œä¸­è‡ªåŠ¨æ›´æ–°é…ç½®ã€‚ å®ç°PropertySourceLocator123456789101112131415161718/** * è‡ªå®šä¹‰é…ç½®æº */public class MyPropertySourceLocator implements PropertySourceLocator &#123; @Override public PropertySource&lt;?&gt; locate(Environment environment) &#123; String msg = new SimpleDateFormat(\"HH:mm:ss\").format(new Date()); Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(\"demo.diy.msg\", msg); System.err.println(\"MyPropertySourceLocator, demo.diy.msg = \" + msg); //springè‡ªå¸¦çš„ä¸€ä¸ªç®€å•çš„mapç»“æ„é…ç½®é›†åˆï¼Œä¹Ÿå¯ä»¥ç»§æ‰¿PropertySourceè‡ªå®šä¹‰ MapPropertySource source = new MapPropertySource(\"my-source\", map); return source; &#125;&#125; é…ç½®ç±»123456789@Configurationpublic class MyConfigBootstrapConfiguration &#123; @Bean public MyPropertySourceLocator myPropertySourceLocator() &#123; return new MyPropertySourceLocator(); &#125;&#125; ç”¨Javaä»£ç å£°æ˜beanï¼Œè¿˜éœ€è¦åœ¨resources/META-INF/spring.factoriesä¸­å£°æ˜ 12org.springframework.cloud.bootstrap.BootstrapConfiguration=\\com.netease.ag.demoweb.MyConfigBootstrapConfiguration Springä¸­ç±»ä¼¼ä¸Java SPIçš„åŠ è½½æœºåˆ¶ã€‚å®ƒåœ¨META-INF/spring.factoriesæ–‡ä»¶ä¸­é…ç½®æ¥å£çš„å®ç°ç±»åç§°ï¼Œç„¶ååœ¨ç¨‹åºä¸­è¯»å–è¿™äº›é…ç½®æ–‡ä»¶å¹¶å®ä¾‹åŒ–ã€‚è¿™ç§è‡ªå®šä¹‰çš„SPIæœºåˆ¶æ˜¯Spring Boot Starterå®ç°çš„åŸºç¡€ã€‚ ä½¿ç”¨è‡ªå®šä¹‰é…ç½®123456789101112131415@RefreshScope //å¯æ›´æ–°@Component@Datapublic class ValueConfig &#123; @Value(\"$&#123;demo.copy.msg&#125;\") private String copyMsg; @Value(\"$&#123;demo.diy.msg&#125;\") private String diyMsg; public ValueConfig() &#123; System.err.println(\"ValueConfig init\"); &#125;&#125; application.propertiesä¸­å¯ä»¥å¼•ç”¨è‡ªå®šä¹‰é…ç½® 1demo.copy.msg=$&#123;demo.diy.msg&#125; springbootåº”ç”¨å¯åŠ¨12345678910111213141516171819202122232425262728@SpringBootApplication@RestControllerpublic class DemowebApplication &#123; @Resource private ValueConfig valueConfig; @Resource private ContextRefresher contextRefresher; public DemowebApplication() &#123; System.err.println(\"DemowebApplication init\"); &#125; public static void main(String[] args) &#123; SpringApplication.run(DemowebApplication.class, args); &#125; @RequestMapping(\"/t\") public String t() &#123; return valueConfig.toString(); &#125; //æ›´æ–°beanå±æ€§ @RequestMapping(\"/r\") public Object r() &#123; return contextRefresher.refresh(); &#125; å¯åŠ¨æ—¥å¿—1234567891011121314 . ____ _ __ _ _ /\\\\ / ___'_ __ _ _(_)_ __ __ _ \\ \\ \\ \\( ( )\\___ | '_ | '_| | '_ \\/ _` | \\ \\ \\ \\ \\\\/ ___)| |_)| | | | | || (_| | ) ) ) ) ' |____| .__|_| |_|_| |_\\__, | / / / / =========|_|==============|___/=/_/_/_/ :: Spring Boot :: (v1.5.2.RELEASE)MyPropertySourceLocator, demo.diy.msg = 17:18:22...DemowebApplication init...ValueConfig init...Tomcat started on port(s): 8080 (http) æŸ¥è¯¢ï¼Œå¤šæ¬¡è¯·æ±‚è¿”å›ä¸€è‡´ è¯·æ±‚ï¼šhttp://localhost:8080/tå“åº”ï¼šValueConfig(copyMsg=17:18:22, diyMsg=17:18:22) æ›´æ–° è¯·æ±‚ï¼šhttp://localhost:8080/rå“åº”ï¼š[â€œdemo.diy.msgâ€] æ—¥å¿—è¾“å‡ºï¼š1MyPropertySourceLocator, demo.diy.msg = 17:27:44 å†æ¬¡è°ƒç”¨æŸ¥è¯¢æ¥å£ï¼Œå‘ç°å€¼æ”¹å˜ï¼Œå¹¶ä¸”è¾“å‡ºæ—¥å¿— 1ValueConfig init è¯æ˜æ›´æ–°å­—æ®µå®é™…æ˜¯é‡æ–°ç”Ÿæˆäº†ä¸€ä¸ªbean","categories":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}],"tags":[{"name":"config","slug":"config","permalink":"https://acupt.github.io/tags/config/"}],"keywords":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}]},{"title":"gRPC-Java ç¤ºä¾‹","slug":"grpc-start","date":"2018-10-23T12:19:56.000Z","updated":"2018-11-28T07:41:22.877Z","comments":true,"path":"2018/10/23/grpc-start/","link":"","permalink":"https://acupt.github.io/2018/10/23/grpc-start/","excerpt":"","text":"æ–°å»ºmavené¡¹ç›®pom.xml 12345678910111213141516171819202122232425262728293031323334353637383940&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;io.grpc&lt;/groupId&gt; &lt;artifactId&gt;grpc-all&lt;/artifactId&gt; &lt;version&gt;1.5.0&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;extensions&gt; &lt;extension&gt; &lt;groupId&gt;kr.motd.maven&lt;/groupId&gt; &lt;artifactId&gt;os-maven-plugin&lt;/artifactId&gt; &lt;version&gt;1.4.1.Final&lt;/version&gt; &lt;/extension&gt; &lt;/extensions&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.xolstice.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;protobuf-maven-plugin&lt;/artifactId&gt; &lt;version&gt;0.5.0&lt;/version&gt; &lt;configuration&gt; &lt;protocArtifact&gt;com.google.protobuf:protoc:3.3.0:exe:$&#123;os.detected.classifier&#125; &lt;/protocArtifact&gt; &lt;pluginId&gt;grpc-java&lt;/pluginId&gt; &lt;pluginArtifact&gt;io.grpc:protoc-gen-grpc-java:1.5.0:exe:$&#123;os.detected.classifier&#125; &lt;/pluginArtifact&gt; &lt;!--*.protoæ–‡ä»¶ç›®å½•--&gt; &lt;protoSourceRoot&gt;src/main/resources&lt;/protoSourceRoot&gt; &lt;/configuration&gt; &lt;executions&gt; &lt;execution&gt; &lt;goals&gt; &lt;goal&gt;compile&lt;/goal&gt; &lt;goal&gt;compile-custom&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; å®šä¹‰æœåŠ¡æ–°å»ºæ–‡ä»¶ src/main/resources/test.proto 1234567891011121314151617181920syntax = \"proto3\";option java_multiple_files = true;option java_package = \"com.acupt.grpc.proto\";option java_outer_classname = \"HelloProto\";package com.acupt.grpc;service HelloService &#123; rpc hello (InvokeRequest) returns (InvokeResponse) &#123; &#125;&#125;message InvokeRequest &#123; string name = 1;&#125;message InvokeResponse &#123; string msg = 1;&#125; æ„å»ºä½¿ç”¨mavenæ’ä»¶æ ¹æ®.protoæ–‡ä»¶ç”ŸæˆJavaä»£ç ï¼Œæ’ä»¶å·²åœ¨pom.xmlä¸­é…ç½®ï¼Œåªéœ€æ‰§è¡Œå‘½ä»¤ï¼š mvn install æ„å»ºå®Œæˆåå¯ä»¥åœ¨targetä¸­æ‰¾åˆ°ç”Ÿæˆçš„Javaä»£ç ï¼Œç”¨è¿™äº›ä»£ç \bå¯ä»¥å®ç°gRPCè¿œç¨‹è°ƒç”¨ã€‚ ä½†åœ¨é¡¹ç›®ä¸­è¿˜æ— æ³•ç›´æ¥å¼•ç”¨ä¸Šé¢çš„ç±»ï¼Œå³é”®\b -&gt; Mark Directory as -&gt; Generated Sources Root ç°åœ¨å°±å¯ä»¥åœ¨é¡¹ç›®ä¸­å¼•ç”¨äº† ä»£ç 3ä¸ªç±» 1234567891011121314151617181920212223package com.acupt.grpc;import com.acupt.grpc.proto.HelloServiceGrpc;import com.acupt.grpc.proto.InvokeRequest;import com.acupt.grpc.proto.InvokeResponse;import io.grpc.stub.StreamObserver;/** * æœåŠ¡å®ç°ç±» */public class HelloService extends HelloServiceGrpc.HelloServiceImplBase &#123; @Override public void hello(InvokeRequest request, StreamObserver&lt;InvokeResponse&gt; responseObserver) &#123; System.out.println(\"request -&gt; \" + request); String name = request.getName();//è‡ªå®šä¹‰çš„å­—æ®µå name InvokeResponse response = InvokeResponse.newBuilder() .setMsg(\"hello,\" + name)//è‡ªå®šä¹‰çš„å­—æ®µå msg .build(); responseObserver.onNext(response); responseObserver.onCompleted(); &#125;&#125; 12345678910111213141516171819202122232425package com.acupt.grpc;import io.grpc.Server;import io.grpc.ServerBuilder;import java.io.IOException;/** * æœåŠ¡æä¾›æ–¹ * * @author liujie */public class MyServer &#123; public static void main(String[] args) throws IOException, InterruptedException &#123; int port = 50051; Server server = ServerBuilder.forPort(port) .addService(new HelloService()) .build() .start(); System.out.println(\"started\"); Thread.sleep(1000 * 60 * 2); server.shutdown(); System.out.println(\"shutdown\"); &#125;&#125; 123456789101112131415161718192021package com.acupt.grpc;import com.acupt.grpc.proto.HelloServiceGrpc;import com.acupt.grpc.proto.InvokeRequest;import com.acupt.grpc.proto.InvokeResponse;import io.grpc.Channel;import io.grpc.ManagedChannelBuilder;/** * æœåŠ¡è°ƒç”¨æ–¹ */public class MyClient &#123; public static void main(String[] args) &#123; InvokeRequest request = InvokeRequest.newBuilder().setName(\"tom\").build(); Channel channel = ManagedChannelBuilder.forAddress(\"localhost\", 50051).usePlaintext(true).build(); HelloServiceGrpc.HelloServiceBlockingStub blockingStub = HelloServiceGrpc.newBlockingStub(channel); InvokeResponse response = blockingStub.hello(request); System.out.println(response.getMsg()); &#125;&#125; å…ˆå¯åŠ¨MyServerï¼Œ\bæˆåŠŸå¯åŠ¨åå†å¯åŠ¨MyClient è¯·æ±‚æ–¹å¼1.é˜»å¡\båŒæ­¥è¯·æ±‚ï¼Œæ¥å£è¿”å›å‰æ˜¯é˜»å¡çš„ã€‚ 123HelloServiceGrpc.HelloServiceBlockingStub blockingStub = HelloServiceGrpc.newBlockingStub(channel);InvokeResponse response = blockingStub.hello(request);System.out.println(response.getMsg()); 2.Futureè°ƒç”¨åè¿”å›guavaåŒ…é‡Œç»§æ‰¿äº†Futureçš„æ¥å£ListenableFutureï¼ˆå¢åŠ äº†listeneræ”¯æŒï¼‰ï¼Œå¯ä»¥æ§åˆ¶è¶…æ—¶æ—¶é—´ã€‚ 12345678910111213141516HelloServiceGrpc.HelloServiceFutureStub futureStub = HelloServiceGrpc.newFutureStub(channel);ListenableFuture&lt;InvokeResponse&gt; future = futureStub.hello(request);future.addListener( () -&gt; System.out.println(\"listener 1\"), command -&gt; &#123; System.out.println(\"execute 1 \" + command); command.run(); &#125;);future.addListener( () -&gt; System.out.println(\"listener 2\"), command -&gt; &#123; System.out.println(\"execute 2 \" + command); command.run(); &#125;);System.out.println(future.get(10, TimeUnit.SECONDS)); 3.å›è°ƒè°ƒç”¨æ¥å£ä¼ å…¥å›è°ƒå‡½æ•°ï¼Œè°ƒç”¨åé©¬ä¸Šè¿”å›ã€‚ 123456789101112131415161718192021222324MyClient.done = false;HelloServiceGrpc.HelloServiceStub stub = HelloServiceGrpc.newStub(channel);stub.hello(request, new StreamObserver&lt;InvokeResponse&gt;() &#123; @Override public void onNext(InvokeResponse value) &#123; System.out.println(\"onNext \" + value); &#125; @Override public void onError(Throwable t) &#123; System.out.println(\"onError \" + t.getMessage()); t.printStackTrace(); MyClient.done = true; &#125; @Override public void onCompleted() &#123; System.out.println(\"onCompleted\"); MyClient.done = true; &#125;&#125;);while (!MyClient.done) &#123; Thread.sleep(1000);&#125;","categories":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}],"tags":[{"name":"rpc","slug":"rpc","permalink":"https://acupt.github.io/tags/rpc/"},{"name":"grpc","slug":"grpc","permalink":"https://acupt.github.io/tags/grpc/"}],"keywords":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://acupt.github.io/categories/å¾®æœåŠ¡/"}]},{"title":"github+hexoæ­å»ºä¸ªäººä¸»é¡µ","slug":"github-hexo-homepage","date":"2018-05-20T07:41:09.000Z","updated":"2019-08-04T14:55:33.481Z","comments":true,"path":"2018/05/20/github-hexo-homepage/","link":"","permalink":"https://acupt.github.io/2018/05/20/github-hexo-homepage/","excerpt":"","text":"ä½œä¸ºæŠ€æœ¯äººå‘˜ï¼Œè°ä¸æ›¾æƒ³è¿‡æœ‰ä¸€ä¸ªå±äºè‡ªå·±çš„ç½‘ç«™ã€‚ä½†å› ä¸ºç§ç§åŸå› ï¼ˆæ²¡æ—¶é—´ã€æ²¡æŠ€æœ¯ã€æ²¡é’±â€¦ï¼‰ï¼Œå¾€å¾€åªæ˜¯æƒ³æƒ³ã€‚ç°åœ¨ï¼Œä¸€å¥—å®Œæ•´çš„è§£å†³æ–¹æ¡ˆæ¥å¸®åŠ©å½·å¾¨çš„ä½ å®ç°æ¢¦æƒ³~ åœ¨ä¸‹ä»¥å‰ä¹Ÿå°è¯•è¿‡æ­å»ºä¸ªäººä¸»é¡µï¼Œå‰ç«¯+åç«¯+æœåŠ¡å™¨+åŸŸåï¼Œç­‰è¿™äº›éƒ½å¼„è¿‡ä¸€éåï¼Œå‘ç°ç³»ç»Ÿè®¾è®¡çš„å¤ªæŒ«æ²¡æœ‰ä½¿ç”¨çš„æ¬²æœ›ï¼Œä¹Ÿæ²¡æœ‰å†™åšå®¢çš„æ¬²æœ›ã€‚æŸå¤©çªç„¶é†’æ‚Ÿäº†ï¼Œåˆ«æé‚£äº›èŠ±é‡Œèƒ¡å“¨çš„ï¼Œå¥½å¥½æ‰¾ä¸ªç°æˆçš„å·¥å…·èƒ½æ­å»ºè‡ªå·±çš„ç½‘ç«™å°±è¡Œï¼Œæˆ‘éƒ½èƒ½æƒ³åˆ°ï¼Œåˆ«äººè‚¯å®šæ—©åšå‡ºæ¥äº†ã€‚ hexoï¼Œå¿«é€Ÿã€ç®€æ´ä¸”é«˜æ•ˆçš„åšå®¢æ¡†æ¶ã€‚hexoå¿«é€Ÿæ­å»ºåšå®¢ï¼ˆä¸å†™ä»£ç ï¼‰ï¼ŒåŸºæœ¬æ— ç¼æ¥å…¥è‡ªå·±çš„mdæ–‡æ¡£ï¼Œé…åˆgithubï¼ŒæœåŠ¡å™¨å’ŒåŸŸåä¹Ÿæœ‰äº†ã€‚ macOS Sierra github git nodejs hexo githubä¸ªäººä¸»é¡µåˆ›å»ºå®˜æ–¹æ•™ç¨‹ æ–°å»ºä»“åº“æˆ‘çš„githubç”¨æˆ·åæ˜¯acuptï¼Œæ–°å»ºä»“åº“ï¼Œåä¸º acupt.github.ioï¼Œ gitåœ°å€ä¸º git@github.com:acupt/acupt.github.io.git githubç»™ä½ çš„ä¸ªäººä¸»é¡µåœ°å€ä¸º https://acupt.github.io ä¿®æ”¹ä¸»é¡µè®¿é—®ä¸»é¡µåœ°å€å°†å±•ç¤ºæ ¹ç›®å½•ä¸‹çš„index.htmlï¼Œå¦‚æœæ²¡æœ‰çš„è¯å±•ç¤ºREADME.mdï¼Œä¹Ÿæ²¡æœ‰ï¼Ÿå‘Šè¾ï¼ è¿™æ—¶å€™å¯ä»¥åœ¨index.htmlé‡Œé¢å†™ä¸»é¡µä»£ç äº†ï¼Œä¸æƒ³å†™çš„ç»§ç»­å¾€ä¸‹ã€‚ hexoæ­å»ºä¸ªäººä¸»é¡µå®‰è£…hexoå‡†å¤‡å·¥ä½œï¼Œè¯·è‡ªè¡Œå®‰è£… nodejs git å¼€å§‹å®‰è£…hexoï¼Œæ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹å¹¶è¿›å…¥å®ƒ 123npm install hexo-cli -ghexo initnpm install å¯åŠ¨hexo12hexo g # ç”Ÿæˆæ–‡ä»¶ï¼ŒåŒ hexo generatehexo s # å¯åŠ¨æœåŠ¡ï¼ŒåŒ hexo server å¯åŠ¨æˆåŠŸååœ¨æµè§ˆå™¨è®¿é—® http://localhost:4000 å†™æ–‡ç« ä¸»ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤å¯æ–°å»ºä¸€ä¸ªmdæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥è‡ªå·±æ–°å»ºåˆ°source/_postsç›®å½•ä¸‹ 12345678hexo new &quot;æ–‡ä»¶å&quot; #æ–°å»ºæ–‡ç« hexo new page &quot;é¡µé¢å&quot; #æ–°å»ºé¡µé¢ # å¸¸ç”¨ç®€å†™hexo n == hexo newhexo g == hexo generatehexo s == hexo serverhexo d == hexo deploy ä¿®æ”¹ä¸»é¢˜å¦‚æœé»˜è®¤æ¨¡æ¿å°±èƒ½æ»¡è¶³ï¼Œæ­¤æ­¥éª¤å¯ä»¥è·³è¿‡ï¼Œä½†ä¸æ‰¾ä¸ªé…·ç‚«çš„æ¨¡æ¿è¿˜æ€ä¹ˆzhuangbilityã€‚ ä¸‹è½½ä¸»é¢˜å…ˆæ‰¾åˆ°ä½ æƒ³è±¡ä¸­çš„æ»‘æ¿é‹ï¼ˆ å®˜æ–¹æ¨¡æ¿åº“ ï¼‰ï¼Œå…‹éš†æ¨¡æ¿åˆ°hexoçš„themesç›®å½•ä¸‹ã€‚ 12# æˆ‘å¥½ä¸å®¹æ˜“æ‰¾åˆ°çš„é…·ç‚«æ¨¡æ¿git clone https://github.com/miccall/hexo-theme-Mic_Theme.git ä½†è¿™ä¸ªé¡¹ç›®åä¸å¤ªå‹å¥½ï¼Œå…‹éš†æˆåŠŸåéœ€è¦æŠŠæ–‡ä»¶å¤¹é‡å‘½åä¸ºæ¨¡æ¿åã€‚ 1mv hexo-theme-Mic_Theme miccall ä¸»é¢˜æ¨¡æ¿é…ç½®ç¼–è¾‘hexoä¸»ç›®å½•ä¸‹çš„_config.ymlï¼Œä¿®æ”¹themeå‚æ•°ä¸ºæ–°çš„ä¸»é¢˜åmiccall 12345# Extensions## Plugins: https://hexo.io/plugins/## Themes: https://hexo.io/themes/#theme: yiliatheme: miccall ä¿®æ”¹æ¨¡æ¿çš„é…ç½®æ–‡ä»¶ï¼Œåœ¨æ¨¡æ¿æ–‡ä»¶å¤¹å†…ä¹Ÿæœ‰ä¸ª_config.ymlï¼Œå’Œhexoä¸»ç›®å½•ä¸‹çš„_config.ymlè´Ÿè´£çš„ä¸œè¥¿ä¸ä¸€æ ·ï¼Œhexoçš„é…ç½®ç®¡é€šç”¨å±æ€§ï¼Œæ¨¡æ¿çš„é…ç½®ç®¡ä¸ªæ€§å‚æ•°ï¼Œæ¨¡æ¿çš„é¡¹ç›®é¦–é¡µä¸€èˆ¬éƒ½æœ‰é…ç½®æ•™ç¨‹ã€‚ æ¨¡æ¿å¯èƒ½æœ‰äº›åœ°æ–¹ä¸ç¬¦åˆè‡ªå·±çš„éœ€æ±‚ï¼Œå¦‚æœæ²¡æ³•é…ç½®çš„è¯ï¼Œé™¤äº†ç»™ä½œè€…æissueï¼Œè¿˜å¯ä»¥è‡ªå·±æ”¹æ¨¡æ¿ä»£ç ï¼ˆåæ­£ä»£ç åœ¨æœ¬åœ°ï¼Œå¯ä»¥ä¸ºæ‰€æ¬²ä¸ºï¼‰ï¼Œæ¯”å¦‚æˆ‘æŠŠè¿™ä¸ªæ¨¡æ¿çš„groupï¼ˆå›¢é˜Ÿï¼‰å¸ƒå±€ç”¨æ¥å±•ç¤ºè‡ªå·±çš„ä½œå“ï¼Œé‚£æˆ‘å°±ä¸éœ€è¦QQå¾®ä¿¡å¾®åšï¼Œåªè¦ä¸ªé“¾æ¥å°±è¡Œäº†ï¼Œçœ‹æ–‡æ¡£æ²¡æœ‰ç›¸å…³å‚æ•°éšè—ï¼Œå»ä»£ç é‡Œæœç´¢äº†ä¸‹ï¼Œæ³¨é‡Šæ‰äº†é‚£å‡ è¡Œä»£ç ã€‚ é‡å¯æœåŠ¡å¦‚æœä¹‹å‰å¯åŠ¨ç€ï¼ŒCtrl+Cå…³é—­ï¼Œåå°è¿è¡Œçš„å°±killæ‰ã€‚ 123hexo clean # æ¸…é™¤ç¼“å­˜ï¼Œä¼šåˆ é™¤ä¸»ç›®å½•ä¸‹çš„publicç›®å½•å’Œæ•°æ®åº“æ•°æ®hexo ghexo s hexoå‘å¸ƒä¸ªäººä¸»é¡µåˆ°githubç¼–è¾‘hexoä¸»ç›®å½•ä¸‹çš„_config.ymlï¼Œä¿®æ”¹deployé…ç½® 123456# Deployment## Docs: https://hexo.io/docs/deployment.htmldeploy: type: git repo: git@github.com:acupt/acupt.github.io.git branch: master æ­¤é…ç½®è¡¨ç¤ºç”¨éƒ¨ç½²åˆ°gitä¸Šï¼Œä¸è¿‡éœ€è¦å†å®‰è£…ä¸€ä¸ªæ’ä»¶ã€‚ 1npm install hexo-deployer-git --save å‘å¸ƒ 12hexo ghexo d è®¿é—®è‡ªå·±çš„githubä¸ªäººé¡µé¢ï¼ˆå¦‚ https://acupt.github.io/ )ï¼ŒæŸ¥çœ‹æ•ˆæœã€‚ æ„Ÿè°¢miccall@githubæä¾›çš„é…·ç‚«æ¨¡æ¿ï¼Œhttps://github.com/miccall/hexo-theme-Mic_Theme æŠ€æœ¯æ€§æ”¹è¿›è™½ç„¶è¿™ä¸ªä¸»é¢˜å¾ˆé…·ç‚«ï¼Œä½†ä¸å¯èƒ½æ¯ä¸€ç‚¹éƒ½å¦‚æˆ‘æ‰€æ„¿ï¼Œå¦‚æœä¸»é¢˜ä½œè€…æœªæä¾›å¯é…ç½®é€‰é¡¹ï¼Œå°±éœ€è¦å¯¹æ¨¡æ¿æºä»£ç åšäº›æ”¹åŠ¨ã€‚ å…ˆå»ä¸»é¢˜é¡¹ç›®çš„githubä¸»é¡µforkä¸€ä»½åˆ°è‡ªå·±çš„githubï¼Œå†cloneåˆ°æœ¬åœ°ã€‚ linkså¸ƒå±€é…ç½®å¯é€‰æ­¤ä¸»é¢˜çš„å›¢é˜Ÿé¡µé¢å¸ƒå±€æˆ‘å¾ˆå–œæ¬¢ï¼Œä½†æˆ‘å¹¶æ²¡æœ‰å°ä¼™ä¼´æƒ³è´´ä¸Šå»ï¼Œé‚£å°±åšæˆä½œå“å±•ç¤ºé¡µé¢å¥½äº†ã€‚ä½†æ˜¯è¿™ä¸ªå¸ƒå±€è®¾è®¡ä¹‹åˆæ˜¯ä¸ºäº†å±•ç¤ºäººï¼Œæ‰€ä»¥æœ‰QQã€å¾®ä¿¡ç­‰ä¿¡æ¯é…ç½®ï¼Œä½†æˆ‘åªæƒ³è¦ä¸€ä¸ªâ€˜é“¾æ¥â€™å±æ€§ï¼Œå…¶å®ƒçš„æ˜¾ç¤ºå‡ºæ¥æœ‰ç‚¹ç¢äº‹ã€‚ IDEæ‰“å¼€æœ¬åœ°ä»£ç ï¼Œå…¨å±€æœç´¢ï¼Œå°±ç”¨å±æ€§ååšå…³é”®è¯ï¼Œæœæ–­åœ¨ä¸€ä¸ªpage-links.ejsæ–‡ä»¶ä¸­å‘ç°ã€‚ 123456&lt;ul class=&quot;social&quot;&gt; &lt;li&gt;&lt;a href=&quot;&lt;%= site.data.links[i].link%&gt;&quot; class=&quot;fa fa-link&quot;&gt;&lt;/a&gt;&lt;/li&gt; &lt;li&gt;&lt;a href=&quot;&lt;%= site.data.links[i].qq%&gt;&quot; class=&quot;fa fa-qq&quot;&gt;&lt;/a&gt;&lt;/li&gt; &lt;li&gt;&lt;a href=&quot;&lt;%= site.data.links[i].wachat%&gt;&quot; class=&quot;fa fa-wechat&quot;&gt;&lt;/a&gt;&lt;/li&gt; &lt;li&gt;&lt;a href=&quot;&lt;%= site.data.links[i].weibo%&gt;&quot; class=&quot;fa fa-weibo&quot;&gt;&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt; ç½‘ä¸ŠæŸ¥ä¸€ä¸‹è¯­æ³•ï¼ŒåŠ ä¸ªifåˆ¤æ–­ã€‚ 1234567891011121314&lt;ul class=&quot;social&quot;&gt; &lt;% if (site.data.links[i].link != null) &#123; %&gt; &lt;li&gt;&lt;a href=&quot;&lt;%= site.data.links[i].link%&gt;&quot; class=&quot;fa fa-link&quot;&gt;&lt;/a&gt;&lt;/li&gt; &lt;%&#125;%&gt; &lt;% if (site.data.links[i].qq != null) &#123; %&gt; &lt;li&gt;&lt;a href=&quot;&lt;%= site.data.links[i].qq%&gt;&quot; class=&quot;fa fa-qq&quot;&gt;&lt;/a&gt;&lt;/li&gt; &lt;%&#125;%&gt; &lt;% if (site.data.links[i].wachat != null) &#123; %&gt; &lt;li&gt;&lt;a href=&quot;&lt;%= site.data.links[i].wachat%&gt;&quot; class=&quot;fa fa-wechat&quot;&gt;&lt;/a&gt;&lt;/li&gt; &lt;%&#125;%&gt; &lt;% if (site.data.links[i].weibo != null) &#123; %&gt; &lt;li&gt;&lt;a href=&quot;&lt;%= site.data.links[i].weibo%&gt;&quot; class=&quot;fa fa-weibo&quot;&gt;&lt;/a&gt;&lt;/li&gt; &lt;%&#125;%&gt;&lt;/ul&gt; å¦¥äº† httpsç«™å†…è®¿é—®httpèµ„æºå—é™éƒ¨ç½²åˆ°githubåç¬¬äºŒå¤©å‘ç°æˆ‘é…·ç‚«çš„ä½œå“å±•ç¤ºé¡µé¢ä¸å†é…·ç‚«äº†ï¼Œæ ·å¼æœ‰ç‚¹è¯¡å¼‚ï¼Œæ‰“å¼€è°ƒè¯•ç•Œé¢ æ˜¾ç„¶æœ€ä¸Šé¢é‚£ä¸¤ä¸ªå¼‚å¸¸æ˜¯é—®é¢˜æ‰€åœ¨ï¼ˆä¸‹é¢é‚£ä¸ªå¼‚å¸¸æ²¡å½±å“ï¼Œæœ‰ç©ºå†ç ”ç©¶ï¼‰ httpsåè®®çš„ç½‘ç«™å¦‚æœç”¨httpè®¿é—®å¤–éƒ¨èµ„æºï¼Œå¾€å¾€ä¼šæ”¶åˆ°è¿™ç§é™åˆ¶ï¼Œè¿™ç§æƒ…å†µæœ€å¥½ç»Ÿä¸€ä¸€ä¸‹ï¼Œå¤§å®¶ç”¨åŒæ ·çš„åè®®å³å¯ï¼Œæ˜¾ç„¶æˆ‘ä¸èƒ½æ”¹githubçš„åè®®ï¼Œé‚£åªèƒ½æ”¹ä¸»é¢˜ä»£ç äº† è¿˜æ˜¯ä¸€æ³¢å…¨å±€æœç´¢ï¼Œè¿˜æ˜¯é‚£ä¸ªæ–‡ä»¶ 12&lt;link href=&quot;http://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;link href=&quot;http://cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css&quot; rel=&quot;stylesheet&quot;&gt; æ”¹æˆhttpså³å¯ï¼Œä½†å¯ä»¥å†ä¼˜é›…ç‚¹ 12&lt;link href=&quot;//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;link href=&quot;//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css&quot; rel=&quot;stylesheet&quot;&gt; å‘å¸ƒï¼ŒéªŒè¯ï¼Œæå®šï¼Œé¡ºä¾¿æäº†ä¸ªpull requestã€‚ æ°ªé‡‘é¡¹ç›®:ç»‘å®šè‡ªå·±çš„åŸŸå å‹æƒ…æç¤ºï¼šåˆ°äº†è¿™æ­¥ï¼Œå†å¾€ä¸‹å°±éœ€è¦æ°ªé‡‘äº†ã€‚ã€‚ã€‚ è™½ç„¶åšå®¢å·²ç»å¯ä»¥ç”¨äº†ï¼Œä½†æ¯•ç«Ÿæ˜¯ä¸ªäºŒçº§åŸŸåï¼ˆacupt.github.ioï¼‰ï¼Œå¦‚æœæƒ³è®©è‡ªå·±çš„åšå®¢æ›´æœ‰é€¼æ ¼ï¼Œå¯ä»¥ç»‘å®šä¸€ä¸ªè‡ªå·±çš„åŸŸåã€‚ åŸŸåä¸€èˆ¬åœ¨é˜¿é‡Œäº‘æˆ–è€…è…¾è®¯äº‘å°±å¯ä»¥ä¹°ï¼Œæ¯”è¾ƒæ–¹ä¾¿ï¼Œè€Œä¸”å› ä¸ºgithubæœåŠ¡å™¨åœ¨å›½å¤–ï¼Œå¯ä»¥ç›´æ¥è§£æä½ çš„åŸŸååˆ°githubé¡µé¢ï¼Œæ— é¡»å¤‡æ¡ˆã€‚å¦‚æœæ˜¯è‡ªå·±ä¹°çš„å›½å†…æœåŠ¡å™¨ï¼Œé‚£ä¹ˆæƒ³ç»‘å®šåŸŸååˆ™éœ€è¦å¤‡æ¡ˆï¼ˆåœ¨å“ªä¹°æœåŠ¡å™¨åœ¨å“ªå¤‡æ¡ˆï¼‰ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚ è´­ä¹°åŸŸåï¼šå›½å†…ç©å®¶é¦–é€‰ é˜¿é‡Œäº‘ é…ç½®åŸŸåè§£æï¼šè´­ä¹°åŸŸååè¿›å…¥é˜¿é‡Œäº‘æ§åˆ¶å°ï¼Œæ·»åŠ åŸŸåè§£æï¼Œè®°å½•ç±»å‹é€‰æ‹©CNAMEï¼Œè®°å½•å€¼ä¸ºä½ çš„åšå®¢åœ°å€ï¼ˆacupt.github.ioï¼‰ æ·»åŠ CNAMEæ–‡ä»¶ï¼šåœ¨acupt.github.ioä»“åº“æ ¹ç›®å½•æ·»åŠ ä¸€ä¸ªæ–‡ä»¶CNAMEï¼ˆæ²¡æœ‰æ‰©å±•åï¼‰ï¼Œå†…å®¹æ˜¯ä½ çš„åŸŸåï¼š å‚è€ƒ æˆ‘çš„ 12acupt.cnwww.acupt.cn æˆ‘é…ç½®äº†ä¸¤ä¸ªåŸŸåï¼Œä¸€ä¸ªä¸»åŸŸåacupt.cnï¼Œä¸€ä¸ªå¤§å®¶æ¯”è¾ƒç†Ÿæ‚‰çš„www.acupt.cnï¼ˆæœ€åè¿˜æ˜¯è¢«é‡å®šå‘åˆ°ä¸»åŸŸåäº†ï¼‰ï¼Œå¦‚æœè®¿é—®acupt.github.ioä¹Ÿä¼šè¢«é‡å®šå‘åˆ°acupt.cnã€‚ HTTPSæ”¯æŒï¼šä½¿ç”¨è‡ªå·±çš„åŸŸååä¸€èˆ¬ä¼šå˜æˆhttpè®¿é—®ï¼Œå› ä¸ºä½ æ²¡æœ‰SSLè¯ä¹¦ã€‚è¿™ä¸ªä¹Ÿæ˜¯å¯ä»¥æ”¯æŒçš„ï¼Œä½†ç”±äºæˆ‘æ²¡æ“ä½œè¿‡ï¼Œå°±ä¸å†™äº†ã€‚ä½†æˆ‘çš„ç½‘ç«™ä»ç„¶æ˜¯httpsï¼Œä¸ºä½•ï¼Ÿä¸€å¼€å§‹æˆ‘çš„ç»‘å®šåŸŸååæ˜¯httpï¼Œè¿‡äº†ä¸€ä¸¤å¤©æœ‰ä¸€ä¸ªé¡µé¢è®¿é—®æ—¶è¢«é‡å®šå‘æˆhttpsï¼Œä»¤äººå›°æƒ‘ã€‚åˆè¿‡äº†å‡ å¤©ï¼Œå…¨éƒ¨éƒ½æ˜¯httpsäº†ã€‚ã€‚ã€‚ç½‘ä¸Šæ²¡æ‰¾åˆ°å¤ªå¤šèµ„æ–™ï¼Œä¼¼ä¹è¿™æ˜¯githubä¸€ä¸ªæ²¡å®Œå…¨å¼€æ”¾çš„åŠŸèƒ½ï¼Ÿ æ°ªé‡‘é¡¹ç›®:ä½¿ç”¨è‡ªå·±çš„æœåŠ¡å™¨ ä¸æ°ªé‡‘ï¼Œä½ æ€ä¹ˆå˜å¼ºï¼Ÿ githubè™½å¥½ï¼Œé€Ÿåº¦æ˜¯ç¡¬ä¼¤ï¼Œå¦‚æœæƒ³è‡ªå·±çš„åšå®¢è®¿é—®é€Ÿåº¦æ›´å¿«ï¼Œæ‹¥æœ‰ä¸€å°æœåŠ¡å™¨å¾ˆé‡è¦ã€‚ å½“ç„¶å¼€æºä¸­å›½çš„ç äº‘ä¹Ÿæä¾›äº†ä¸ªäººä¸»é¡µåŠŸèƒ½ï¼Œé€Ÿåº¦è™½ç„¶å¿«ç‚¹ï¼Œä½†é™åˆ¶é¢‡å¤šï¼Œæ¯”å¦‚ç»‘å®šè‡ªå·±çš„åŸŸåä¹Ÿè¦æ”¶é’±ï¼ˆæ˜¯çš„ï¼Œè¿˜è¦å†ç»™å¼€æºä¸­å›½é’±ï¼Œè¿™é’±ä¹°ä¸ªæœåŠ¡å™¨å²‚ä¸å¿«å“‰ï¼‰ã€‚ æ¨èå‡ ä¸ªäº‘æœåŠ¡å™¨é€‰æ‹©ï¼š äºšé©¬é€Šï¼šå›½å¤–çš„å…¬å¸ï¼Œç½‘ç«™ä¸å¤ªæœåŠ¡å›½äººä¹ æƒ¯ï¼Œè€Œä¸”åé¦ˆé—®é¢˜ä¸€èˆ¬è¦ç”¨è‹±æ–‡ï¼Œä¸å¤ªæ–¹ä¾¿ã€‚ äºšé©¬é€Šå¯ä»¥è–…ç¾Šæ¯›ï¼Œæ–°ç”¨æˆ·ç»‘å®šä¿¡ç”¨å¡åæœ‰ä¸ªæœ€ä½çº§çš„äº‘æœåŠ¡å™¨ä¸€å¹´ä½¿ç”¨æƒï¼Œæ³¨æ„è¦ä¿¡ç”¨å¡ã€‚å½“åˆæäº†ä¸ªä¸€å¹´çš„æœåŠ¡å™¨ï¼Œå› ä¸ºåœ¨å›½å¤–ï¼Œå°±è¶æœºæ­å»ºäº†ä¸€ä¸ªç¿»å¢™æœåŠ¡å™¨çˆ½äº†å‡ å¤©ã€‚ è–…ç¾Šæ¯›æ³¨æ„ï¼šä¸€å¹´åˆ°æœŸä¸ä¼šè‡ªåŠ¨æ¶ˆå¤±ï¼Œä¼šå¼€å§‹æ‰£è´¹ï¼ˆä¿¡ç”¨å¡ï¼‰ï¼Œæ³¨æ„æå‰å…³é—­ï¼Œæˆ–è€…ç•™æ„å®˜æ–¹çš„è‹±æ–‡æé†’é‚®ä»¶ï¼Œä¸ç„¶ã€‚ã€‚ã€‚ï¼ˆæˆ‘æƒ³é™é™ï¼‰ è…¾è®¯äº‘ï¼šç”¨è¿‡ï¼Œæ²¡å•¥æ¯›ç—…ï¼Œæ¯å¤©å‚ä¸ç§’æ€ï¼Œè¿æ°”å¥½å¯ä»¥æŠ¢åˆ°å¾ˆä¾¿å®œè€Œä¸”æ€§èƒ½ä¸é”™çš„æœåŠ¡å™¨ã€‚ é˜¿é‡Œäº‘ï¼šä¾ç„¶æ˜¯å›½å†…ç©å®¶é¦–é€‰ï¼Œ è…¾è®¯äº‘å’Œé˜¿é‡Œäº‘éƒ½æœ‰é’ˆå¯¹å­¦ç”Ÿå…šçš„ä¼˜æƒ ï¼Œæœˆç§Ÿå¾ˆä¾¿å®œï¼Œç›¸å½“äºä¸€ä¸ªè§†é¢‘ä¼šå‘˜ï¼Œç¤¾ä¼šäººä¹Ÿæ²¡å…³ç³»ï¼Œæ–°äººä¹Ÿæ˜¯æœ‰ä¼˜æƒ çš„ï¼Œä¸æ˜¯æ–°äººï¼Ÿéƒ½æ˜¯è€ç›¸è¯†äº†è¯¥æ°ªå°±æ°ªå§~ The Endè¿™ç¯‡å¸–å­æ˜¯2018å¹´å†™çš„äº†ï¼Œä»Šå¤©ï¼ˆ2019-08-02ï¼‰æˆ‘åˆç¿»å‡ºæ¥ç¼–bianè¾‘shiäº†ä¸€ä¸‹ã€‚æ‰€ä»¥æˆ‘çš„åšå®¢å…¶å®å·²ç»æ¢äº†ä¸ªä½è°ƒçš„ä¸»é¢˜äº†ï¼ˆæ—¶é—´ä¼šä½¿äººæˆç†Ÿï¼‰ã€‚ æ”¹è¿›é¡¹ç›®ï¼š æ–°å¢åŸŸåç»‘å®š æ–°å¢ä¸¤é¡¹æ°ªé‡‘é¡¹ç›® ç»´æŠ¤åšå®¢æ˜¯ä¸€ä»¶é•¿æœŸçš„äº‹ï¼ŒæŠŠå®ƒå½“æˆä¸€ä»¶çˆ±å¥½ï¼Œæˆ–è€…ä¸€ä¸ªç›®æ ‡ï¼Œå¯ä»¥æ›´å¥½çš„åšæŒä¸‹å»ã€‚æ¬¢è¿å…³æ³¨æˆ‘ï¼Œä¸€èµ·äº¤æµå¦‚ä½•æŠŠåšå®¢åšçš„æ›´å¥½ã€‚","categories":[{"name":"å®è·µç¬”è®°","slug":"å®è·µç¬”è®°","permalink":"https://acupt.github.io/categories/å®è·µç¬”è®°/"}],"tags":[{"name":"github","slug":"github","permalink":"https://acupt.github.io/tags/github/"},{"name":"hexo","slug":"hexo","permalink":"https://acupt.github.io/tags/hexo/"}],"keywords":[{"name":"å®è·µç¬”è®°","slug":"å®è·µç¬”è®°","permalink":"https://acupt.github.io/categories/å®è·µç¬”è®°/"}]},{"title":"githubæ­å»ºä¸ªäººmavenä»“åº“","slug":"github-repository","date":"2018-05-20T07:00:00.000Z","updated":"2019-07-24T13:37:13.505Z","comments":true,"path":"2018/05/20/github-repository/","link":"","permalink":"https://acupt.github.io/2018/05/20/github-repository/","excerpt":"","text":"Mavenå¯¹Javaå¼€å‘è€…æ¥è¯´æ˜¯å¾ˆå¸¸è§çš„å·¥å…·ï¼Œæœ‰äº†å®ƒåªéœ€è¦åœ¨pomæ–‡ä»¶åŠ å‡ è¡Œä»£ç å°±èƒ½å¼•å…¥ç¬¬ä¸‰æ–¹ä»£ç ã€‚å¦‚æœæƒ³æˆ‘ä»¬è‡ªå·±å†™çš„å·¥å…·ç±»ä¹Ÿè®©åˆ«äººé€šè¿‡è¿™ç§æ–¹å¼ä½¿ç”¨ï¼Œä¸å¦¨å€ŸåŠ©githubæ­å»ºä¸ªå…è´¹ä»“åº“ã€‚ æ ¸å¿ƒåŸç†å°±æ˜¯åœ¨githubä¸Šå»ºç«‹ä¸€ä¸ªä»£ç ä»“åº“æ¥å­˜å‚¨æˆ‘ä»¬å‘å¸ƒçš„jaråŒ…ï¼Œä¸éœ€è¦è‡ªå·±ä¹°æœåŠ¡å™¨ï¼Œä¹°åŸŸåï¼Œè¿™äº›githubéƒ½èƒ½å¸®æˆ‘ä»¬å®ç°ã€‚ æ–°å»ºä»“åº“ åœ¨githubæ–°å»ºä¸€ä¸ªæ™®é€šçš„ä»“åº“å³å¯ï¼Œæˆ‘çš„ä»“åº“åœ°å€ https://github.com/acupt/repository.git å…‹éš†åˆ°æœ¬åœ° 123456789101112âœ github git clone https://github.com/acupt/repository.gitCloning into &apos;repository&apos;...remote: Counting objects: 3, done.remote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0Unpacking objects: 100% (3/3), done.âœ github cd repository âœ repository git:(master) lsREADME.mdâœ repository git:(master) pwd/Users/acupt/github/repository å‘å¸ƒåˆ°æœ¬åœ° ç”¨deployå‘½ä»¤å‘å¸ƒé¡¹ç›®ï¼ŒæŒ‡å®šæ‰“åŒ…çš„æ–‡ä»¶è¾“å‡ºåˆ°ä¸Šä¸€æ­¥å…‹éš†çš„æœ¬åœ°ä»“åº“ï¼Œåœ¨é¡¹ç›®ï¼ˆæˆ‘ä»¬éœ€è¦å‘å¸ƒåˆ°ä»“åº“çš„ä»£ç /jaråŒ…ï¼‰æ ¹ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤ 1mvn deploy -DaltDeploymentRepository=acupt-repository::default::file:/Users/acupt/github/repository/ åŒæ­¥åˆ°è¿œç¨‹ä»“åº“ ä¸æƒ³ç”¨masterå¯ä»¥æ–°å»ºä¸ªåˆ†æ”¯ 123git branch snapshotgit push origin snapshotgit checkout snapshot git add/commit/push 12345678910111213141516171819202122232425262728âœ repository git:(snapshot) âœ— git add com/âœ repository git:(snapshot) âœ— git commit -m &quot;acupsession&quot;[snapshot 4409029] acupsession 12 files changed, 74 insertions(+) create mode 100644 com/acupt/acupsession/1.0-SNAPSHOT/acupsession-1.0-20180519.110225-1.jar create mode 100644 com/acupt/acupsession/1.0-SNAPSHOT/acupsession-1.0-20180519.110225-1.jar.md5 create mode 100644 com/acupt/acupsession/1.0-SNAPSHOT/acupsession-1.0-20180519.110225-1.jar.sha1 create mode 100644 com/acupt/acupsession/1.0-SNAPSHOT/acupsession-1.0-20180519.110225-1.pom create mode 100644 com/acupt/acupsession/1.0-SNAPSHOT/acupsession-1.0-20180519.110225-1.pom.md5 create mode 100644 com/acupt/acupsession/1.0-SNAPSHOT/acupsession-1.0-20180519.110225-1.pom.sha1 create mode 100644 com/acupt/acupsession/1.0-SNAPSHOT/maven-metadata.xml create mode 100644 com/acupt/acupsession/1.0-SNAPSHOT/maven-metadata.xml.md5 create mode 100644 com/acupt/acupsession/1.0-SNAPSHOT/maven-metadata.xml.sha1 create mode 100644 com/acupt/acupsession/maven-metadata.xml create mode 100644 com/acupt/acupsession/maven-metadata.xml.md5 create mode 100644 com/acupt/acupsession/maven-metadata.xml.sha1 âœ repository git:(snapshot) âœ— git pushCounting objects: 18, done.Delta compression using up to 8 threads.Compressing objects: 100% (8/8), done.Writing objects: 100% (18/18), 12.50 KiB | 6.25 MiB/s, done.Total 18 (delta 1), reused 0 (delta 0)remote: Resolving deltas: 100% (1/1), done.To https://github.com/acupt/repository.git 3951922..4409029 snapshot -&gt; snapshotâœ repository git:(snapshot) âœ— æµ‹è¯•åˆ°è¿™é‡Œå·²ç»okäº†ï¼Œé€šè¿‡GitHubæä¾›çš„åŸŸåå¯ä»¥ä¸‹è½½mavenä¾èµ–ï¼ˆä½†æ— æ³•æŸ¥çœ‹åˆ—è¡¨ï¼‰ï¼Œåœ°å€ï¼š https://raw.github.com/acupt/repository/snapshot æ¥ä¸‹æ¥æ–°å»ºä¸€ä¸ªé¡¹ç›®è¯•ç€å¼•ç”¨å‰é¢å‘å¸ƒçš„jaråŒ…ï¼Œéœ€è¦åœ¨pomæ–‡ä»¶ä¸­å¢åŠ è¿œç¨‹ä»“åº“åœ°å€ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨mavené…ç½®æ–‡ä»¶ä¸­åšå…¨å±€é…ç½®ã€‚ æ–°å»ºmavené¡¹ç›® ä¿®æ”¹pom.xml 12345678910111213141516171819202122232425&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;com.acupt&lt;/groupId&gt; &lt;artifactId&gt;acupdemo&lt;/artifactId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;repositories&gt; &lt;repository&gt; &lt;id&gt;acupt-repository&lt;/id&gt; &lt;url&gt;https://raw.github.com/acupt/repository/snapshot&lt;/url&gt; &lt;/repository&gt; &lt;/repositories&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;com.acupt&lt;/groupId&gt; &lt;artifactId&gt;acupsession&lt;/artifactId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/project&gt; æŸ¥çœ‹æœ¬åœ°mavenä»“åº“ï¼Œçœ‹çœ‹jaråŒ…æœ‰æ²¡æœ‰ä¸‹è½½æˆåŠŸ 12345678âœ acupsession cd ~/.m2/repository/com/acupt/acupsession/1.0-SNAPSHOT âœ 1.0-SNAPSHOT lsacupsession-1.0-20180519.110225-1.jar acupsession-1.0-SNAPSHOT.jaracupsession-1.0-20180519.110225-1.jar.sha1 acupsession-1.0-SNAPSHOT.pomacupsession-1.0-20180519.110225-1.jar.tmp.sha1.tmp maven-metadata-acupt-repository.xmlacupsession-1.0-20180519.110225-1.pom maven-metadata-acupt-repository.xml.sha1acupsession-1.0-20180519.110225-1.pom.sha1 maven-metadata-acupt-repository.xml.tmp.sha1.tmpacupsession-1.0-20180519.110225-1.pom.tmp.sha1.tmp maven-metadata-snapshots.xml å¯ä»¥çœ‹åˆ°å·²ç»æœ‰jaråŒ…äº†ï¼Œè‡³æ­¤ä¸€ä¸ªå±äºä½ è‡ªå·±çš„mavenä»“åº“å°±å®Œæˆäº†ã€‚ å¦‚æœæƒ³è®©åˆ«äººä¸éœ€è¦æ·»åŠ ä½ çš„ä»“åº“åœ°å€å°±èƒ½ç”¨ä½ çš„jaråŒ…ï¼Œé‚£ä¹ˆå°±ä¸èƒ½ç”¨è‡ªå·±æ­å»ºçš„ç§äººä»“åº“äº†ï¼Œéœ€è¦å‘å¸ƒåˆ°å¤§å®¶å…¬ç”¨çš„ä»“åº“é‡Œå»ï¼Œæœ‰ä¸“é—¨çš„æä¾›è¿™ç§æœåŠ¡çš„å…¬å¸ï¼Œç½‘ä¸Šä¸€æœå°±æœ‰ï¼Œä½†ä¸æ˜¯å…è´¹çš„ï¼Œå‘Šè¾ã€‚","categories":[{"name":"å®è·µç¬”è®°","slug":"å®è·µç¬”è®°","permalink":"https://acupt.github.io/categories/å®è·µç¬”è®°/"}],"tags":[{"name":"github","slug":"github","permalink":"https://acupt.github.io/tags/github/"},{"name":"maven","slug":"maven","permalink":"https://acupt.github.io/tags/maven/"}],"keywords":[{"name":"å®è·µç¬”è®°","slug":"å®è·µç¬”è®°","permalink":"https://acupt.github.io/categories/å®è·µç¬”è®°/"}]}]}